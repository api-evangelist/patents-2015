---

title: Malicious advertisement detection and remediation
abstract: Detecting a malicious advertisement is disclosed. An advertisement is analyzed. A determination that the advertisement is associated with malicious activity is made. An indication that the advertisement is malicious is provided as output. The indication can be provided as a report, such as to a publisher and can also be provided using an API, such as to the entity responsible for serving the advertisement.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09398031&OS=09398031&RS=09398031
owner: Dasient, Inc.
number: 09398031
owner_city: Sunnyvale
owner_country: US
publication_date: 20150204
---
This application is a continuation of U.S. patent application Ser. No. 13 903 892 filed May 28 2013 and entitled Malicious Advertisement Detection and Remediation. U.S. patent application Ser. No. 13 903 892 is a continuation of U.S. patent application Ser. No. 13 037 242 filed Feb. 28 2011 and entitled Malicious Advertisement Detection and Remediation. U.S. patent application Ser. No. 13 037 242 is a continuation in part of co pending U.S. patent application Ser. No. 12 761 336 filed Apr. 15 2010 and entitled Monitoring for Problems and Detecting Mal Ware. U.S. patent application Ser. No. 12 761 336 claims priority to U.S. Provisional Application No. 61 214 546 filed Apr. 25 2009 and entitled Method and Apparatus for Web Server Anti Mal Ware and Quarantining as well as U.S. Provisional Application No. 61 214 626 filed Apr. 25 2009 and entitled Method and Apparatus for Continuous Monitoring of Domain URLs on Multiple Blacklists. U.S. patent application Ser. No. 13 037 242 also claims priority to U.S. Provisional Patent Application No. 61 438 159 filed Jan. 31 2011 and entitled Risk Assessment. U.S. patent application Ser. Nos. 13 037 242 and 12 761 336 and U.S. Provisional Patent Application Nos. 61 214 546 61 214 626 and 61 438 159 are incorporated by reference herein in their entirety for all purposes.

Websites often incorporate advertisements into the pages or other data that they serve to visitors. The advertisements are often served by a third party. For example when a visitor accesses a website that serves news articles the textual content of the website may be served by the news website while advertisements may be served by a third party. If the news website is compromised visitors client devices may be exposed to unauthorized and frequently malicious programs modifications hereinafter collectively malware . Unfortunately even if the news website is itself secured visitors may nonetheless be exposed to malware if the advertisements provided by the third party have been compromised.

The invention can be implemented in numerous ways including as a process an apparatus a system a composition of matter a computer program product embodied on a computer readable storage medium and or a processor such as a processor configured to execute instructions stored on and or provided by a memory coupled to the processor. In this specification these implementations or any other form that the invention may take may be referred to as techniques. In general the order of the steps of disclosed processes may be altered within the scope of the invention. Unless stated otherwise a component such as a processor or a memory described as being configured to perform a task may be implemented as a general component that is temporarily configured to perform the task at a given time or a specific component that is manufactured to perform the task. As used herein the term processor refers to one or more devices circuits and or processing cores configured to process data such as computer program instructions.

A detailed description of one or more embodiments of the invention is provided below along with accompanying figures that illustrate the principles of the invention. The invention is described in connection with such embodiments but the invention is not limited to any embodiment. The scope of the invention is limited only by the claims and the invention encompasses numerous alternatives modifications and equivalents. Numerous specific details are set forth in the following description in order to provide a thorough understanding of the invention. These details are provided for the purpose of example and the invention may be practiced according to the claims without some or all of these specific details. For the purpose of clarity technical material that is known in the technical fields related to the invention has not been described in detail so that the invention is not unnecessarily obscured.

System site and site respectively comprise standard commercially available server hardware e.g. having multi core processors 4 Gigabytes of RAM and Gigabit network interface adapters run typical server class operating systems e.g. Linux and also run Apache HTTP Server software. In various embodiments system is implemented across a scalable infrastructure comprising multiple such servers solid state drives and other applicable high performance hardware. Site is a commodity desktop computer and runs Microsoft Internet Information Services IIS software.

In the example shown in client is a web enabled cellular phone and clients and are personal computers. Other examples of clients that can be used in conjunction with the techniques described herein include personal digital assistants networked entertainment devices e.g. televisions portable video players and game consoles and virtually any other networkable device.

System is configured to perform a variety of analyses on the content served by sites such as site detect suspicious elements present in that content or loaded from third party sources when the content is accessed and make available instructions that can be used to mitigate such elements if applicable. As used herein malicious elements e.g. ones intentionally included in site by a nefarious individual program represent a subset of suspicious elements. Examples of content that can be used in conjunction with the techniques described herein include HTML pages including JavaScript PDF documents and executables.

As will be described in more detail below system is also configured to evaluate the inventories of advertising entities such as advertiser and or members of ad network and may do so independently of analysis of sites such as site .

Whenever system is described as performing a task such as determining whether a website includes malicious content or determining whether a particular advertisement is malicious either a single component all components or a subset of all components of system may cooperate to perform the task. Similarly whenever a component of system is described as performing a task a subcomponent may perform the task and or the component may perform the task in conjunction with other components. Portions of the functionality of system can also be provided by or replicated by one or more third parties. As one example in some embodiments system provides mitigation services without providing detection services and instead obtains detection information from a third party. As another example a very large publisher of content may choose to run its own system within its own data centers and contract only for updates and technical support. As yet another example in some embodiments system is configured to detect and remediate malicious advertisements only and does not provide services with respect to other types of malicious content.

In various embodiments at least some of the functionality provided by system is independently provided by elements of the environment shown in other than system and the techniques described herein are adapted as applicable. For example search provider which allows visitors to search the World Wide Web is configured to provide the detection functionality of system . Specifically search provider routinely scans sites and looks for the presence of problematic content. If problematic content is found search provider will prevent visitors to its site from accessing search results present on the implicated site. As another example search provider which may also be in control of one or more ad servers such as ad server can be configured to provide malicious advertisement detection and remediation services with respect to the advertisements that are placed on its search pages and or any advertisements that are served by ad network . As yet another example in some embodiments a module installed on client e.g. a browser plugin is configured to intercept and remediate problematic content prior to it being rendered in a browser installed on client .

In the example shown in detection system is in communication with a risk assessment module . In various embodiments risk assessment module is under the control of the operator of system such as by being collocated on the same sever hardware or otherwise directly integrated into system . Risk assessment module can also be operated by a party other than the operator of system either in cooperation with the operator of system or entirely independent of system .

As will be described in more detail below risk assessment module is configured to perform a structural analysis of sites such as site and to determine one or more scores that indicate the vulnerability of the site to being used in a future malware attack and e.g. to ultimately serve malware to visitors . Structural vulnerabilities typically exist because of the interconnected interdependent nature of the web. An example of a structural vulnerability is a weakness in a web page that may allow an attacker to compromise the entire page as a result of the reliance of the page design on a page component where the compromise of the component can result in compromise of the entire page. For example it is common practice for web sites to incorporate content that is hosted by third parties such as widgets within the site. Other examples of structural vulnerabilities include mash ups scripts iframed content external advertisements and third party web application software that may have vulnerabilities.

While an enterprise website might spend a great deal of effort securing its web servers and other infrastructure by including content hosted by third parties visitors to the site are effectively at the mercy of the security practices of the third party hoster. A website may not be in a position to remove a structural vulnerability because the element is essential to providing functionality or other portions of the user experience. For example a news site relies on advertising for its revenue and thus cannot remove all advertisements served by ad networks from its site. As will be described in more detail below using the techniques described herein individual problematic advertisements and or advertisements served by a nefarious advertisement server can be detected and prevented from being shown to visitors without the need to prevent other advertisements from being shown e.g. by removing the ad unit . As another example many websites rely on JavaScript or other widgets to provide traffic analysis render videos or conduct polls. Removal of such third party content would severely limit the functionality or business model of a website. Instead of removing them one way of addressing the presence of such structural vulnerabilities is to scan the site more frequently and or to focus scanning activities on particularly vulnerable aspects of the site. For example if some pages of a site include external JavaScript or specific types of external JavaScript and others do not the pages with the external JavaScript can be scanned more frequently than those that do not.

Database is configured to store a variety of information including a catalogue of known malware snippets. Database is also configured to store a network trace table which along with configuration information is used by anti malvertising module described in more detail below.

Crawler is configured to enumerate the URLs of the pages hosted by a given site such as site and to provide them to detection engine . Detection engine is configured to perform a three phase analysis of site content to detect malware and pinpoint its origin also referred to herein as determining the lineage of the malware . For example using the techniques described herein the insertion of a malicious element e.g. a 1 1 pixel transparent image or an iframe sourcing in malicious content from a foreign web site into an otherwise benign page by a malicious and obfuscated iframe can be detected reported to the appropriate entity and ultimately prevented from infecting downstream clients.

All pages can be analyzed with equal frequency and can also be analyzed with varying frequency depending on factors such as how important the page is e.g. the front page of a page that receives millions of visitors per day or the login page of an online bank vs. a personal blog and what level of service has been contracted for e.g. premium service vs. basic service . The frequency with which a page is scanned can also be configured based on recommendations provided by risk assessment module . For example if a site or given elements within a site are considered to be at high risk of being compromised with malware due to infection history vulnerabilities or other criteria those sites or portions thereof can be scanned more frequently than sites or portions thereof that are considered to be at a lower risk as applicable.

Detection engine is configured to examine the top ten pages of site once an hour. Which pages are designated as top may be performed manually by an administrator e.g. of site and may also be automatically specified to system by software running on site that logs visitor activities. In the example shown detection engine is configured to examine the remaining pages of site and all pages of site once a day. Further while site has not contracted with system to perform malware detection or remediation services as will be described in more detail below in some embodiments detection engine is nonetheless instructed to examine its pages as well.

In the first phase of analysis content analyzer performs static and dynamic analysis of the content. Static analysis module is configured to parse pages content and recognize patterns of information such as signatures of known malware the presence of script tags and iframes and their content etc. Page content and metadata associated with the page content as well as any individual elements extracted during static analysis are stored in database by static analysis module .

In addition to static content e.g. HTML many web pages also include active content e.g. JavaScript . Malicious individuals are generally aware of ways to conceal the functionality of their active content from purely static analysis techniques. For example an attacker might anticipate that a static scanner would evaluate the source tag of a script see that a path to a foreign country is included and conclude that the script is malicious. To evade the scanner the attacker might omit the source tag and instead use an onload JavaScript handler to import malicious content into a page.

Accordingly during the first phase of analysis a variety of dynamic analysis is performed by dynamic analysis module . Dynamic analysis module is configured to emulate the effects of a given page being loaded in a browser. In some embodiments the dynamic analysis performed by module includes loading the content in a browser instrumented to track what specific actions are taken as the page is loaded by employing a set of breadcrumbs that can be used to step through the loading of the page. As a result of the examination of the content in an instrumented browser the origin of any element present in the document as finally rendered in a browser can be determined even if the element is intentionally obfuscated.

One way of constructing an instrumented browser is as follows. The instrumented browser is built in an object oriented programming language and has classes and objects inside that are responsible for rendering different parts of the page. One object is responsible for rendering HTML documents and in turn other objects are responsible for handling elements such as iframes and scripts. Mock objects can also be included such as a mock PDF renderer. When a script attempts to render a PDF the mock renderer is called an action that can be logged even if a proper PDF renderer object is not present.

The instrumented browser parses a given document into a document object model DOM that unfolds the elements of the document into a tree structure that is used to display the page elements in the correct places. Elements such as iframes import additional documents having their own DOMs into the document. The static lineage of a given element can be determined by examining its position in the DOM.

The instrumented browser is also configured to keep track of the dynamic lineage of elements. In some cases the structure of the DOM may be changed in place in the browser by a programming language that can run in the browser such as JavaScript. For example a script tag when executed might have the effect of inserting an iframe into the DOM. Such an iframe could be included for a valid reason but could also be included for malicious purposes. The iframe would be tagged to the body but the parent is not the body node. Instead the iframe has a dynamic parent that is the script node. The script node is one of the children of the body and it has a child frame.

One way to determine the dynamic lineage of elements is to configure the instrumented browser with a set of hooks into the JavaScript engine. Elements such as inline script tags are interpreted while the page is parsed. The control in the browser engine passes from the parser to the JavaScript engine and when it is complete control reverts back to the parser. Whenever the JavaScript engine is entered a pointer to the script node is pushed onto a stack. When the JavaScript engine is exited a pop of the stack is performed. In the case of script tags for which the source field is defined the browser renders other elements of the page and makes an asynchronous request to fetch the JavaScript file and when it is received there is an asynchronous entry into the JavaScript engine. Scripts can also generate more script tags. While the JavaScript engine is in control any new nodes that are created are tagged with a dynamic parent pointer that points back to the script node in whose context the JavaScript engine was entered.

The instrumented browser can also be used to keep track of redirections. For example when an advertisement needs to be served on behalf of site ad server is contacted. If ad server does not have an appropriate advertisement in inventory to serve a redirection is made to ad server and so on. Suppose ad server is ultimately responsible for serving an advertisement on behalf of site and the advertisement includes a malicious element. System will be able to detect the origin of the malicious element as being site and also note what malicious behavior e.g. initiating a drive by download it is responsible for. In various embodiments a browser helper object extension is used to track referrer information for every element that is rendered such as the enclosing page for an iframe. Additional detail on the detection and remediation of malvertising is provided below.

The dynamic analysis performed by module can also include loading one or more different virtual machine images e.g. having different operating systems application versions etc. rendering instances of the content in those virtual machines and observing the results. As will be described in more detail below such virtual machine images can make use of various user profiles and geographically diverse proxies to appear to be used by a variety of diverse individual users instead of appearing to be under the control of the operator of system .

In various embodiments both types of dynamic analysis instrumented browser examination and virtual machine emulation are used. In some embodiments if a problem is indicated that implicates a specific version of an operating system and or particular application one or more images having the implicated operating system or application are used. In other embodiments all virtual machine images are used in the analysis. Other techniques can also be used to select which virtual machine images should be used by dynamic analysis module . For example the top ten pages of site may be evaluated using all virtual machine images e.g. covering several different operating systems and versions while other pages on site are examined using a single default image that represents the most common components present in a typical desktop client. As another example anti malvertising module described in more detail below may make use of several different virtual machines when evaluating an advertisement that has a significant number of impressions and use fewer or no virtual machines when evaluating an advertisement with few impressions. The number of impressions an advertisement has received or is expected to receive can also be used for other purposes such as for determining a frequency with which anti malvertising engine should perform an analysis on the advertisement.

In the second phase of analysis feature analyzer examines the output of content analyzer e.g. as stored in database and generates a set of features which are also stored in database . Examples of features include the number of scripts present on a given page the country of origin of any iframe content and any other aspects pertaining to the content and or metadata associated with the page. Examples of features that can be generated as a result of dynamic content analysis include the number of scripts generated during page load detected by the instrumented browser and the number of processes created detected during use of a virtual machine . Features may or may not inherently indicate a problem. For example an iframe that imports content from a foreign country may more likely be malicious than not but is not conclusively malicious. Other types of scans can also be performed during this phase such as by passing files such as PDF files and executable through traditional virus scanners and features such as PDF passed virus scan can be included in database as applicable.

In a subsequent phase of analysis signal analyzer combines various features together using linear combinations weighting algorithms and machine learning algorithms and determines whether any signals are present. One example of a signal is page spawns one or more processes and includes an iframe that sources information from a foreign country. Another example of a signal is page includes a snippet of known malware e.g. as determined by comparing the content of the page against the catalogue stored in database . In some embodiments signals are one of two types soft and hard. A hard signal indicates that malware has been determined to be present. Actions such as immediately notifying an administrator of the site hosting the content of the presence of malware can be taken in response. Additional actions such as performing a deep level of analysis e.g. evaluation using one or more virtual machine images may also be performed to help pinpoint or otherwise conclusively determine all malicious elements present in the page and their origins if the most thorough level of analysis was not already performed.

A soft signal indicates that malware is potentially present and that additional analysis should be performed. As one example in various embodiments the three phase analysis performed by detection engine runs in a loop. During the first loop minimal processing is performed. For example limited examination is performed in the instrumented browser and no virtual machine emulation is performed for performance reasons. Suppose as a result of the first loop a determination is made that a particular version of an application e.g. a PDF reader appears to be exploited. As one example a soft signal of script is checking for a specific outdated version of a PDF reader might be generated by signal analyzer . While there might be a valid reason for a page to insist on a particular version of the application it is more likely that a malicious element hoping to leverage a vulnerability in that particular version of the application is present. Accordingly when the soft signal is generated another loop of processing is performed by detection engine and a progressively deeper level of data is collected for analysis. For example in the second round of analysis a virtual machine image including the specific PDF reader could be used by dynamic analysis module . If malicious behavior is observed during the virtual machine emulation a hard signal can be generated by signal analyzer . If benign behavior continues to be observed either an additional round of processing is performed in even more detail or a conclusion that the script is harmless is reached as applicable.

If detection engine determines that a malicious element is present in the content it is evaluating e.g. generates a hard signal it notifies reporting engine . Reporting engine is configured to generate a variety of reports described in more detail below. Also as described in more detail below quarantine engine is configured to help prevent any detected problem from being propagated to clients by sending appropriate quarantine instructions to the web server serving the content.

If the malicious element is included in site reporting engine is configured to send an alert to a designated administrator of site that allows the administrator to initiate a remediation action via quarantine engine that will prevent the iframe from being served to any future visitors to the page. If the malicious element is included in site reporting engine is configured to send an alert to a designated administrator of site . However as site has not contracted with system to provide remediation services the administrator of site will need to remove the problematic content manually. Nonetheless because the report generated by reporting engine includes an identification of the malicious iframe itself the administrator will have a considerably easier time removing the malicious content from the page than he would absent such an identification. If the malicious element is included in site in some embodiments reporting engine is configured to alert search provider and module that site has been compromised.

As will be described in more detail below when malicious advertisements are detected by system a variety of reports can be made and actions taken in addition to or instead of the reports and remediation actions described above. For example if a malicious advertisement is being served by ad server in some embodiments the operator of ad server is informed that its subsyndicate ad server has either been compromised or is a rogue ad server. Further ad server can be automatically instructed to stop serving detected malicious advertisements to stop engaging in redirections that involve subsyndicate ad server and or other remediation actions can be taken as discussed in more detail below.

Using the techniques described herein system is able to detect iframe as being a malicious element and specifically the source of the rootkit exploit . Reporting engine will generate an appropriate report for the administrator of the site. And if the online retailer has contracted for quarantining services quarantine engine will also be configured to generate a directive to quarantine iframe .

As indicated in region a scan of the online retailer s site comprising a total of 15 web pages revealed that one page is infected and the remaining fourteen pages are not . In various embodiments other information is also included in report such as whether or not the site or portions thereof have been included in a blacklist such as a blacklist maintained by search provider .

In region a copy of iframe is provided. If the administrator selects link the administrator will be taken to a page that provides additional information about the nature of the iframe e.g. based on the catalogue of information stored in database . If the administrator checks box and selects submit button a signal will be sent to quarantine engine to initiate a quarantine instruction with respect to iframe on the online retailer s webserver. In various embodiments other actions are also made available to the administrator in report . For example if it is determined that the site has been included in a blacklist maintained by search provider a second box can be included under box that allows the administrator to request that system send a request to search provider to remove the site from the blacklist once the quarantine has been implemented.

Script decodes into an iframe element . As with iframe this iframe when loaded by a client could download additional malicious code that will cause a driveby download. Using the techniques described herein system is able to detect script as being a malicious element and specifically the source of a driveby download . Reporting engine will generate an appropriate report for the administrator of the site. And if the online retailer has contracted for quarantining services quarantine engine will also be configured to generate a directive to quarantine script .

In addition to detecting problems server can also prevent infected sites from harming clients that access those sites. In the example shown in the Apache HTTP Server software installed on site s server hardware has been extended with a module called mod antimalware. The functionality of other web server software such as IIS can similarly be extended using the techniques described herein.

In the example shown in quarantine engine is configured to securely communicate with mod antimalware through the use of client side SSL certificates or other appropriate technology. When a determination is made e.g. by detection engine and confirmed by an administrator that a malicious element on site should be quarantined quarantine engine determines an appropriate quarantine instruction and securely sends the instruction to mod antimalware. At any given time mod antimalware may have multiple quarantine directives loaded in memory for consideration when serving pages.

When requests for pages are received by the web server the mod antimalware module determines whether the URL of the content to be served matches a URL prefix for which the module has a quarantine instruction. If not the module allows the content to be served. If so mod antimalware applies the rule to the page.

In various embodiments if as a result of mod antimalware applying a rule to a page the page is altered mod antimalware is configured to insert a header X Quarantine 1 into the page. If the page is not altered no header is included. The X Quarantine header can be used to determine whether an infection in a page has been removed from the source e.g. because an administrator has edited the content or whether the processing of mod antimalware is still required to protect downstream clients from the element.

In some embodiments upon sending quarantining directives to the web server the quarantining service initiates a verification process to determine whether or not the quarantining was successful. The verification process entails a multi phase in depth scan e.g. using the techniques described above to verify that infected web pages are no longer served once quarantining directives have been deployed. Upon completion of the verification process the site administrator receives an email and or other notification as to whether or not the quarantining process was successful. In the case that it was successful the administrator can then remove the infection at his her leisure. If the quarantining verification failed i.e. an infection was still served on some web page then the quarantining service can deploy a stronger quarantining directive. For instance in the case that a QuarantineTag directive was deployed to attempt to mitigate a particular malicious tag in a web page but the infection still was served the quarantining service can deploy a Blacklist directive to prevent the entire page from being served as filtering only part of the page was unsuccessful. Additional emails can be sent to the administrator to keep the administrator up to date on the status of the quarantining and be sent a final email once all directive upgrades are attempted. Such emails can contain a link to a more detailed report which provides the administrator with information regarding whether specific URLs were successfully quarantined whether quarantining is in progress e.g. directive not sent yet or directive is in the process of being upgraded or whether the quarantining failed.

The QuarantineTag directive instructs the mod antimalware module to remove the specified tag from pages matching a given URL prefix prior to serving them but to otherwise serve the page content as is. For a given page if a URL prefix match exists but the tag to be quarantined is not present no action is taken and the page is served as if mod antimalware was not present.

The above directive quarantines prevents from being served on any page on the site any iframe that has a source attribute of http dasienttestbaddomain.com. 

The above directive quarantines on the page Default.htm any iframe that has a source attribute of http dasienttestbaddomain.com. 

The above directive quarantines on the WordPress blog page with URL wordpress p 3 any iframe that has a source attribute of http baddomain.com. 

In contrast to the QuarantineTag which looks for tags having matching attributes the QuarantineTagBody directive instructs the mod antimalware module to quarantine content that has a matching tag body.

The directive above quarantines on any page having a URL prefix of test any script with code document.wirte .

Example QuarantineTagBody page.html script document.write unescape x3c x69 x66 x72 x61 x6d x65 x20 x73 x72 x63 x3d x22 x68 x74 x 74 x70 x3a x2f x2f x77 x77 x77 x2e x6e x65 x69 x6c x64 x61 x73 x77 x61 x6e x69 x2e x63 x6 f x6d x22 x20 x77 x69 x64 x74 x68 x3d x30 x20 x68 x65 x69 x67 x68 x74 x3d x30 x20 x66 x7 2 x61 x6d x65 x62 x6f x72 x64 x65 x72 x3d x30 x3e x20 

The QuarantinePath directive instructs the mod antimalware module to quarantine the portion of the document matching the specified portion of the document structure.

The directive above quarantines on any page having a URL prefix of test the iframe in the first paragraph tag within the body.

The QuarantineBytes directive instructs the mod antimalware module to quarantine the portion of the document matching the specified byte range.

A quarantine directive in the above format instructs mod antimalware to prevent the Default.htm page from being sent. In some embodiments an administrator specified page is sent instead. The administrator specified page can be configured with a message such as This site is currently experiencing technical difficulties please come back tomorrow to help prevent a loss of goodwill by visitors who might otherwise see an error or blank page as a result of the blacklist directive being used.

At quarantine engine determines an appropriate quarantine instruction for mitigating the presence of the malicious element on the page. Examples of quarantine instructions are provided above. At quarantine engine sends the quarantine instruction to the mod antimalware module resident on the webserver that hosts the infected page. In various embodiments the processing shown in is performed multiple times with respect to a malicious element. As one example suppose that at quarantine engine determines that a QuarantineTag directive should be sent at . After the directive is sent system scans the implicated page again to see if the malicious element is still being served. If so quarantine engine is configured to select a new quarantine instruction e.g. a QuarantineTagBody instruction or QuarantinePath instruction and send that instruction at . In a worst case scenario quarantine engine may determine that a Blacklist directive should be sent at which will have the effect of both preventing the malicious element from being served along with other content on the page .

In some cases a user such as Alice may not be able to visually tell that the mod antimalware has modified the page that she would like to view. For example in the case where the malicious element is a transparent 1 1 pixel graphic its presence or absence would not be detectable by Alice. In other cases such as where an infected third party module is blocked e.g. an electronic commerce button or other widget Alice may notice that site is not fully functional. Nonetheless Alice is much more likely to maintain positive feelings toward site when encountering a partially non functional page than she would if the page was blocked by her browser or search provider with a warning that the page is infected.

MOD DIRECTIVE LIST is a table to track active directives that have been sent to modules. mod instance id is a foreign key to the instance this directive applies to.

MOD DIRECTIVE tracks directives. signal instance is a foreign key into SIGNAL INSTANCE. crawler url id is a foreign key into CRAWLER URL and points to the URL the directive is for. directive is the actual directive e.g. QuarantineTag page.html . . . .

CRAWLER URL keeps track of the URLs that have been crawled. url is the URL e.g. http example.com page.html . crawler standing set id is a foreign key to CRAWLER STANDING SET not shown which is used to keep track of the top level domain that was scanned to get to this URL. last crawl report timestamp is the last time the site was crawled. last http response code is the last HTTP response code that was observed when crawling the site.

CONTENT EXTRACTION OUTPUT stores static content and dynamically interpreted page elements. point id is the same as the crawler url id. content type id indicates whether the content is a script iframe image applet etc. instance data stores intermediate results of the content extraction phase. static lineage stores the location of content element in the HTML DOM. dynamic lineage is the series of dynamic content elements that resulted in the generation of this content element. code snippet is the code of the content element. extraction run id is a unique identifier corresponding to the set of content elements extracted from a given page. time is the timestamp at which the content element was discovered.

EXTRACTED FEATURE stores information generated by feature analyzer . feature id is an identifier for a feature of a particular content element.

SIGNAL INSTANCE stores information about signals identified by signal analyzer . signal id is an identifier of a signal.

Additional tables such as NETWORK TRACE are also used in some embodiments and the schema of database is modified as applicable.

As shown in module includes a crawler a content extraction engine a risk analysis feature extractor an aggregator a reporting engine and a database . In various embodiments the functionality of crawler and crawler is provided by a single component the functionality of content extraction engine and content analyzer is provided by a single component the functionality of the risk analysis feature extractor and feature analyzer is provided by a single component the functionality of reporting engine and reporting engine is provided by a single component and or the functionality of database and database is provided by a single component. Additional detail on various components of module will now be provided.

Crawler receives as input one or more seed URLs and a scanning depth. As one example suppose the operator of site has not yet contracted to receive detection remediation services from system but is considering doing so. In order to determine whether site would benefit from the protections offered by system the operator of site provides via a user interface to engine the domain of site e.g. ACMETribune.com . The operator of site might also provide a scanning depth e.g. 1000 pages however the scanning depth can also be provided by another entity such as via a configuration file accessible to engine . The crawler then crawls site and generates a list of its URLs. The crawler streams its list of URLs to content extraction engine .

For each URL provided to it by crawler content extraction engine fetches content e.g. by making an HTTP request and performs content extraction. The content extraction performed can be shallow deep or a combination thereof. In the case of shallow content extraction the extraction engine performs a static analysis of the downloaded content to identify various elements in the content such as JavaScript and iframe elements. In the case of deep content extraction dynamic analysis of the downloaded content is also performed. Suppose a given piece of JavaScript on a page being evaluated by the content extraction engine is internal to site however when the script is executed it loads an external piece of JavaScript. Shallow analysis would identify and extract the internal JavaScript while deep analysis would identify and extract both the internal JavaScript and the external JavaScript. Example techniques for performing both static and dynamic content analysis are described above in conjunction with the section titled Content Analysis Phase. 

The output of content extraction engine which will be described in more detail below is a stream of annotated content or tokenized information that is provided as input to risk analysis feature extractor . The risk analysis feature extractor performs additional analyses such as by categorizing elements as internal or external recognizing certain pieces of JavaScript as being associated with an advertising network and so on. The risk analysis feature extractor augments the annotations provided by the content extraction engine and provides a stream of its output also described in more detail below to aggregator .

Aggregator is configured to assess the risk posed by the various components of the website and to provide information about its assessment and about the website components to reporting engine . Reporting engine is configured to generate a risk assessment report. Different approaches can be used to determine the overall risk to be displayed e.g. at as well as the individual risk levels e.g. displayed at . As one example if any one risk category is determined to be high the overall risk is also deemed to be high. As another example if at least two risk categories are determined to be medium the overall risk could be deemed to be high as well due to the cumulative risk posed by the medium risks. Different risk categories can also be weighted differently as applicable and risks can also be assessed in accordance with any applicable industry standards or other guidelines.

In various embodiments in addition to the output provided to it by risk analysis feature extractor aggregator considers additional information e.g. stored in database when making its assessment. Examples of such additional information include ranked lists of external domains white lists and black lists and historical infection information for external domains.

In some embodiments database stores historical information about the structure of various websites and whether or not those sites were ultimately infected by malware. The historical information can be used to refine threshold values or rules used in determining the risk levels posed by the presence of various third party content and or out of date software applications. As one example training sets for use in machine learning processing can be created from the risk assessment reports of sites that have been infected in the past or are currently infected and sites that have never been infected in the past or are currently not infected. In addition the machine learning processing can incorporate the number of times and or frequency with which sites have been infected in the past.

Region of the report indicates the domain for which the report was run and which was provided as input to crawler along with an appropriate depth value . Region includes summary information such as an overall risk in this example High the date and time the assessment was completed the number of URLs analyzed and the number of potential risks identified. An explanation of what it means to be a High risk is also provided along with a recommendation of how to minimize the risk.

Region of the report provides a summary of the risk posed to the site by components classified into five categories 1 External JavaScript 2 External iframes 3 Advertisements 4 External Images and 5 Out of Date Web Applications. In the example shown in site is highly susceptible to a malware attack via all five types. In region summary information about each type of risk is presented.

By selecting one of the statistical boxes additional information about the corresponding category is presented in region regions and . In the example shown in the External JavaScripts category is selected . A list of those JavaScripts and the number of site s pages on which those scripts appear is provided in region . In region a list of the specific pages of site that include external JavaScripts and the number of such scripts appearing on each of the respective pages is provided. In the example shown in the threat risk posed by the presence of external JavaScript on site is indicated in box as being High. 

Many websites use third party content such as widgets for counting traffic tracking users sharing content video polls and other user functionality. The use of third party widgets has enabled rich user functionality and analytics. However in a security context websites that use third party widgets can be turned into distribution vehicles for malware if the third party widgets are targeted or compromised by attackers. As one example suppose the operator of site included a free statistics counter hosted by a third party at the bottom of every page of site several years ago. The counter was initially and has been for multiple years a legitimate counter. However at any time the owner of the counter could intentionally modify the behavior of counter or the counter could be compromised by another entity without the owner s knowledge. If such an event were to occur every visitor to any page of website would be at risk.

In some embodiments in calculating the risk shown in boxes and a count of the number of objects is used the more objects the higher the risk. Conversely the presence of a single object across many pages may pose a lower risk. In other embodiments more sophisticated approaches are used. For example the sources of the external JavaScripts can be checked against a whitelist or blacklist with those scripts matching domains on the whitelist being accorded a low score those scripts matching domains on the blacklist being accorded a very high score and or domains not present on either list being accorded a midlevel score. As another example a ranked list of the top 10 or 1000 websites e.g. including the domains .google.com .usa.gov and .wikipedia.org can be used to classify external JavaScript provided by sites on the ranked list as a lower threat than JavaScript provided by other sites not appearing on the list. Other types of reputation scoring that consider vulnerability assessments as well as other information can also be used in conjunction with the risk calculation of third party content as applicable.

Historical infection information about a different site can also be considered in performing the evaluation depicted in . For example database can be configured to serve information about the scans that system performs e.g. of sites and and share that information with module . A cooperative effort to track the infection histories of sites can also be undertaken with sites such as search provider sharing information about the scans it performs with detection system and or module .

In some embodiments the identity of the ad network ad provider serving the ad is considered when performing the risk assessment. For example the presence on a page of a top tier advertisement link may be treated by aggregator as posing a low or medium risk while an advertisement link from a third tier network is treated as posing a high risk. However as some top tier ad networks also sub syndicate their ad inventory which may expose them to malicious ads inserted into dubious upstream ad networks in some embodiments all ad networks are deemed to pose the same risks by the aggregator. Ad networks that are known to employ monitoring or scanning of their ads may have their assessed risk decreased based upon the amount and frequency of monitoring or scanning that they employ in proportion to the overall size of their ad inventory . Techniques for detecting malicious advertisements and remediating such advertisements are disclosed below.

Risk assessment module can determine the version information of installed applications languages in a variety of ways. As one example an application fingerprinter can be used. As another example when content extraction engine fetches content information such as the version of the web server serving the content will be accessible to the content extraction engine via HTTP headers. Other applications such as blog software imprint version information within the pages they are responsible for generating. Content extraction engine can provide such information to aggregator for further analysis.

Different approaches can be used to determine the level of risk to assign to out of date applications. For example applications that are out of date by a minor revision number can be treated as posing a lower risk than applications that are out of date by a major revision number. As another example the presence in a vulnerability database of the installed version and or an indication that the particular version is known to be vulnerable to malware attacks can be treated as posing a higher risk than if the installed version is not present in a vulnerability database. As yet another example in some cases it may not be possible to confirm the version number of software. In that scenario a rule can be specified such that any software with unconfirmed version numbers is treated in a fail secure manner e.g. as a medium or high risk or can instead be treated in a fail safe manner e.g. as a low risk . More complex rules can also be specified for how aggregator determines to classify the risk posed by installed applications. For example one rule could be that the inability to confirm a version number of a single application is not by itself sufficient to merit a medium or high risk label but when combined with at least one other problem e.g. a second unconfirmed application or an application that is known to be out of date the inability to confirm the version number will influence the final risk level assigned. At the same time inability to confirm version numbers may mean that a site is intentionally masking the version numbers of all of its applications a positive security practice . If all the version numbers of applications installed on the site are being masked then the site could be considered lower risk.

If a risk from the presence of out of date applications is determined to exist the report can recommend that the implicated software be updated. In some cases however it might not be possible to update the software. For example a specific version of an application may be required for site compatibility reasons or a review process may be in place that precludes immediate upgrades. In such circumstances the report can be used to configure more frequent scans by a system such as system to help mitigate the risk posed by the out of date application s .

The operator of site who does not contract to receive detection remediation services from system can nonetheless obtain risk assessments from engine . As one example the operator may choose to periodically obtain assessments to make sure that the marketing department of the photograph repository has not compromised the security of the site by installing unauthorized web applications or including unapproved third party widgets on site pages.

The process shown in or portions thereof can be initiated in a variety of contexts. As one example the operator of detection system can make available risk assessment reports to prospective subscribers of system s detection and mitigation services. As another example the operator of detection system can use the risk assessment report of a given site to configure the frequency with which detection system performs various scans associated with the site. The report need not take the human readable form shown in but can instead in addition be output in a machine readable format. As yet another example an administrator of site can use the output of risk assessment module to make sure that the marketing department has not installed a widget that has not been vetted by the security department. In such a scenario the widget may not yet be compromised and thus not pose an immediate threat to site visitors. However the administrator will be able to efficiently learn of the presence on site of the widget and have it removed or take another appropriate action such as to bring the widget to the attention of the CISO. As another example using the techniques described herein the administrator of site would be able to determine which subdomain s of the site are powered by an unapproved web server.

The output of the process shown in can likewise be used in a variety of ways. As mentioned above an administrator e.g. of site or system can manually examine the report for anomalies. The report can also be provided as input to another system or process such as detection engine . As one example the frequency with which site is scanned for problems can be tuned based on the report generated by reporting engine . The particular frequency can be based on a variety of factors such as the overall risk e.g. high medium low and or the risk in a given category e.g. External JavaScripts medium .

One way that a malicious advertisement can be included in page is for the ad tag itself to be compromised. Additional examples of ways in which a malicious advertisement could be included in a page such as page are presented in . Using the techniques described herein the impact on users such as Alice of such malicious activities can be minimized.

Using the techniques described herein system can detect malicious advertisements and can also minimize the damage that such advertisements can cause. System can perform the detection on behalf of a variety of distinct parties such ad servers ad networks advertisers or other entities responsible for the creation serving of advertisements publishers e.g. publisher and or individual users e.g. as a feature of module . Detection on behalf of each type of party will now be described in more detail.

An ad network and or ad server advertiser etc. can contract with the operator of system to provide malvertising detection and or remediation services. As one example suppose the operator of system has contracted to monitor the advertisements served by ad network . The ad network could provide a list of publisher websites to system which system would in turn scan in accordance with the techniques described above. The ad network could also provide system with access to its ad inventory such as by providing system with a list of URLs for every advertisement in the network. Advertisements may be hosted directly by the network but may also be hosted by an advertiser or agent of the advertiser to allow greater flexibility in managing advertisement creative. System is configured to crawl and analyze the provided URLs in accordance with the techniques described above to identify any suspicious elements. In various embodiments advertisements are scanned as soon as they are uploaded into the network and are also regularly rescanned after upload to ensure that advertisements previously determined to be legitimate are not subsequently compromised.

In addition to or instead of providing direct links to advertisement creatives the ad network may also provide to system one or more ad tags for evaluation. The ad tags may pertain to advertisements served by the ad network and may also belong to other ad networks with which the ad network has a syndication agreement. Many different advertisements may ultimately be accessible via a single tag. Further which advertisements are shown when a tag is executed may depend on factors such as the IP address of the client that accesses the ad tag. This is true of both legitimate advertisements and of malicious ones. For example a malicious advertisement that attempts to persuade viewers to click on the advertisement to receive a free virus scan will want to ensure that the language used in the advertisement matches with the language spoken by the viewer of the advertisement.

In various embodiments system is configured to repeatedly analyze ad tags to ensure that all advertising creative is ultimately evaluated. Virtual machines can be used in the analysis to emulate heterogeneous visitors. In particular different virtual machines can make use of different user profile information e.g. cookies browser histories system language and locale settings etc. and proxies and thus appear to an ad server to be distinct users from distinct locales. The user profiles included in the virtual machines can be manually created e.g. to simulate the appropriate demographics of typical visitors to a particular website and can also be automatically generated e.g. to make sure that many different types of users are simulated . In various embodiments the virtual machine images are constructed to be highly vulnerable to malware e g running out of date software with known compromises to help ensure that if an advertisement is malicious the virtual machine will be susceptible to its malicious activity.

Configuration information such as how often to scan an ad tag which virtual machines to use and which proxies should be use by those virtual machines is stored in some embodiments in configuration and used by anti malvertising module to coordinate analysis e.g. by providing instructions to static analysis module and dynamic analysis module .

Ad servers typically have their own format for advertisement related URLs and encode various pieces of information in those URLs such as referrer identifiers publisher identifiers and advertiser identifiers. In various embodiments anti malvertising module is configured to decode URLs and extract out the various types of information encoded therein. Various techniques to decode the URLs can be used including by employing decoding rules and by using APIs provided by cooperative ad networks.

In some embodiments network trace table is used to store information associated with the scans conducted by anti malvertising module . In particular each row of the network trace table stores for a given URL a sequence number a full scan identifier that identifies a particular scan a crawler URL identifier that indentifies distinct URLs a referrer URL identifier that indicates which URL referred to the URL being scanned the full URL of the scanned element and whether or not the advertisement was determined to be malicious. As explained above one technique for obtaining the information included in table is for anti malvertising module to decode the URLs. If a particular advertisement is determined to be malicious the information stored in table and other information as applicable can be used to locate other instances of the advertisement such as copies of the advertisement that might be present within other ad networks. If the other ad networks are subscribed to the services provided by system appropriate actions can be taken to make sure that those networks stop serving the malicious advertisement. If the other ad networks are not subscribed to the services provided by system in some embodiments a report is sent to those ad networks alerting them as to the nature of the malicious advertisement and offering them a free trial of system s services. Other tables may also be used in conjunction with the scanning such as a table that records the date and time the scan was performed a hash of what was retrieved and the number of times the retrieved creative has been previously seen by system .

When a malicious advertisement is detected the ad network is provided with a variety of information as applicable. It may be the case that the ad network is itself is serving the malicious advertisement e.g. because it was directly compromised by an attacker . In that case a report may be provided to the ad network that appears similar to the one shown in . The report would identify the particular malicious advertisement explain the nature of the malicious activity such as that a viewer of the advertisement will be subject to a drive by download and include an image of the advertisement as it would appear to a viewer. In various embodiments the ad network makes available an API by which system can automatically suspend the malicious advertisement from being served.

As explained above it is also possible that the advertisement is being served by a third party such as is illustrated in where ad network is responsible for serving via malicious server a malicious advertisement as a syndicate of ad network . In that scenario the report may include additional information to help the ad network understand which of its syndicates is responsible and to serve as evidence that the syndicate is responsible. An example report is shown in . Suppose ad network has contracted for anti malvertising services from system but ad network has not. Ad network and ad network have a syndication agreement and ad network has additional syndication agreements with other ad networks not shown including a malicious ad network. By analyzing ad tags provided by ad network system determines that malicious advertisements are being served by a subsyndicate of ad network which received a redirection from ad network . The operator of ad network can provide the report to the operator of ad network and demand that the subsyndicate be prevented from serving any more advertisements. The operator of ad network can also prevent redirections to ad network from occurring until such time as ad network can demonstrate that it has remedied the problem with its subsyndicate. As one example the operator of ad network may require the operator of ad network to enroll in one or more services offered by system as a condition of syndication. The frequency with which ad network and or its subsyndicates and the type of scanning performed e.g. with a higher amount of dynamic analysis being performed can be adjusted upward from what might otherwise be performed due to network s history of compromise.

As indicated in box when URL is analyzed several redirections occur ultimately culminating in a drive by download taking place . Forensic information is also provided in region about the malicious advertisement. By selecting link the ad network operator can obtain copies of the full set of URLs loaded and redirected through for loading ads. By selecting link the ad network operator can obtain a PCAP network trace and a full HTTP referrer. The PCAP network trace provides traceability as to which geography IP the scan was initiated from and can be used to further determine the nature of the attack. For example the PCAP network trace is useful in determining that a malvertisement is only being served to a particular geography or if the attack is due to DNS cache poisoning at an ISP from which the scan occurred. The HTTP referrer trace provides the sequence of ad servers that were redirected through in addition to all the files that were downloaded including the drive by binary . The ad network can use this information to prove to its downstream ad network partner that the partner is responsible by virtue of its subsyndicate for serving malicious advertisements. As explained above the image used for the malicious creative can also be included.

A publisher can also contract with the operator of system to provide malvertising detection and or remediation services. As one example suppose the operator of site chooses to have system monitor its photograph site for the presence of malicious advertisements but does not desire to use other services offered by system . In such a scenario system would scan site periodically using the techniques described above. The publisher may make use of third party advertisements and or may choose to recruit advertisers directly. The techniques described herein can be used to detect malicious advertisements in any of those situations. In some embodiments content extraction engine and risk analysis feature extractor are used to perform the analysis but their results are ultimately pruned to just those page elements that pertain to advertising.

When a malicious advertisement is detected a report can be sent by system to the operator of site an example of which is shown in . Information such as the publisher s credential information with the ad network and an identifier of the malicious advertisement s server can be used by system to automatically report the detected advertisement to the implicated ad network or other appropriate entity. As explained above if the ad network provides an appropriate API the malicious campaign can be paused for all users of the ad network and or just for site thus automatically containing the malicious advertisement without site to disable or remove all advertising units.

An end user can also be accorded protection from malvertising irrespective of whether publishers or at networks associated with the pages that the user views have contracted for services from system . As one example module can be configured to check the URLs requested by the user s browser against the information stored in database and to block any suspicious or malicious advertisements from being rendered.

Although the foregoing embodiments have been described in some detail for purposes of clarity of understanding the invention is not limited to the details provided. There are many alternative ways of implementing the invention. The disclosed embodiments are illustrative and not restrictive.

