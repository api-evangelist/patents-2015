---

title: Method and system for tank refilling using active fueling speed control
abstract: In one or more embodiments, a system and method for filling a compress gas tank or fuel tank is provided, including determining a fill time (t) predicted to produce a gas final temperature (T) based on one or more coefficients selected from a lookup table, mass average dispenser gas temperature for control (MATC), and alpha, determining a pressure ramp rate (RR), delivering gas to the compressed gas tank at a control pressure based on the pressure RR during a first portion of filling the compressed gas tank, determining a mass average enthalpy (MAE) and density, and delivering gas to the compressed gas tank at a target ending fueling pressure based on the density and the gas final temperature during a second portion of filling the compressed gas tank.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09605804&OS=09605804&RS=09605804
owner: Honda Motor Co., Ltd.
number: 09605804
owner_city: Tokyo
owner_country: JP
publication_date: 20150529
---
This application claims priority pursuant to 35 U.S.C. 119 e from U.S. Provisional Patent Application No. 62 009 701 filed on Jun. 9 2014 the content of which is incorporated by reference in its entirety 

this application is a continuation in part of U.S. patent application Ser. No. 13 843 537 filed on Mar. 15 2013 the content of which is incorporated by reference in its entirety which is a continuation in part of U.S. patent application Ser. No. 12 982 966 filed on Dec. 31 2010 the content of which is incorporated by reference in its entirety which claims priority pursuant to 35 U.S.C. 119 e from U.S. Provisional Patent Application Nos. 61 332 919 and 61 326 375 the contents of which are incorporated by reference in their entirety 

this application is a continuation in part of U.S. patent application Ser. No. 13 832 311 filed on Mar. 15 2013 the content of which is incorporated by reference in its entirety which is a continuation in part of U.S. patent application Ser. No. 12 982 966 filed on Dec. 31 2010 the content of which is incorporated by reference in its entirety which claims priority pursuant to 35 U.S.C. 119 e from U.S. Provisional Patent Application Nos. 61 332 919 and 61 326 375 the contents of which are incorporated by reference in their entirety 

this application is a continuation in part of U.S. patent application Ser. No. 14 300 229 filed on Jun. 9 2014 the content of which is incorporated by reference in its entirety which is 

Advances in hydrogen H2 refueling methods present increased opportunity to reduce fueling times for vehicles while allowing more flexibility in H2 station designs. Generally cost reduction is an important factor when designing and building H2 infrastructure and should be taken into consideration when entering the fuel cell electric vehicle FCEV market.

There are numerous approaches when it comes to developing a hydrogen fueling method. For example a constant pressure ramp rate approach is used in the SAE J2601 2103 table based approach. The constant pressure ramp rate approach uses fixed inputs or boundary conditions in conjunction with a fueling model employing a finite element solution to the hear transfer thermodynamics and fluid dynamics with the output being a target constant pressure ramp rate. Another approach for hydrogen fueling is the Monde Method.

The safety and convenience of hydrogen tank refueling are recognized as important considerations in determining the ultimate success of hydrogen fueled vehicles in the marketplace. Under current safety guidelines the refueling of compressed hydrogen tanks are to be conducted in a manner that prevents the tank from overheating temperatures exceeding 85 C. during refueling and or from overfilling the tank to a point at which the pressure could exceed 125 of normal working pressure NWP at any time. Because of the number of unknown parameters associated with conventional hydrogen tank refueling procedures the refueling operations tend to be somewhat conservative thereby trading performance and efficiency particularly with respect to end of fill density or state of charge SOC and or unnecessary levels of pre cooling for an increased safety margin. A SOC of 100 for example corresponds to a tank at NWP and 15 C.

This tradeoff is especially significant in non communication fueling operations in which the parametric assumptions are even more conservative. Because the hydrogen station does not have information about the tank that it is filling very conservative assumptions need to be made for the system in order to encompass the range of possible tank configurations and initial tank conditions to avoid exceeding the system safety limits. In SAE TIR J2601 defined by the Society of Automotive Engineers the disclosure of which is incorporated herein by reference in its entirety these conservative assumptions are incorporated into a series of lookup tables for hydrogen tank filling. Working from parameters including the tank volume starting pressure ambient temperature and station pre cooling set point the lookup tables are then used for determining a pressure ramp rate and final target pressure. While application of these lookup tables tends to provide for safe refilling under virtually all conditions and for virtually all tank systems given the conservative nature of the associated assumptions the resulting hydrogen tank filling operation may take longer achieve lower final fill pressures and or require lower hydrogen station pre cooling temperatures than necessary to fill a particular tank system.

An additional limitation of the refilling procedures defined by SAE TIR J2601 is the lack of any method or procedure for a hydrogen tank filling station to compensate or adjust for situations in which its actual operating conditions fall outside of the allowed tolerances. For example if the pre cooling temperature is above the design set point as the result of multiple consecutive refills the lookup tables defined in SAE TIR J2601 cannot be used. Efforts to avoid this out of specification condition can lead to an overdesigned hydrogen tank filling station excessive cooling for ensuring that the pre cooling target temperature is maintained thereby driving up station cost.

Conversely failing to ensure that the pre cooling target temperature is maintained can inconvenience customers that are unable to refill their tanks in a timely manner as a result of delays waiting for the pre cooling temperature to come into specification thereby reducing customer satisfaction station revenue and or repeat business. Further operating a station with a constant pre cooling temperature regardless of current ambient conditions results in excessive energy usage and reduced well to wheel energy efficiency. In order to reduce energy use a hydrogen tank filling station should be operated at the highest possible pre cooling temperature that provides both customer acceptable refueling times and a satisfactory safety margin.

According to one or more aspects a method for filling a compressed gas tank is provided including determining a fill time t predicted to produce a gas final temperature T determining a final pressure P calculated to produce a state of charge of 100 within the compressed gas tank and delivering gas to the compressed gas tank at a pressure ramp rate RR that achieves the final pressure P at a conclusion of the fill time t wherein the gas is delivered to the compressed gas tank using a dispenser.

According to one or more aspects a method of filling a compressed gas tank is provided including determining a fill time t predicted to produce a gas final temperature T based on one or more coefficients selected from a lookup table mass average dispenser gas temperature for control MATC and alpha determining a pressure ramp rate RR delivering gas to the compressed gas tank at a control pressure based on the pressure RR during a first portion of filling the compressed gas tank determining a mass average enthalpy MAE and density and delivering gas to the compressed gas tank at a target ending fueling pressure based on the density and the gas final temperature during a second portion of filling the compressed gas tank.

The method may include measuring an ambient temperature T and an initial pressure in the gas tank P and setting an expected end of fill mass average dispenser gas temperature MAT . In one or more embodiments one or more of the coefficients may be selected from the lookup table based on the ambient temperature T and the initial pressure in the gas tank P . One or more of the coefficients may be selected from the lookup table using Tand Tvalues which are directly above and below a corresponding Tvalue in the lookup table. tmay be calculated by interpolating between different tvalues calculated using Tand T. The lookup table may be selected based on a tank category for the compressed gas tank.

MATC may be calculated based on a time interval an expected end of fill mass average dispenser gas temperature MAT mass average temperature measured from t 0 MAT mass average temperature measured from t 30 MAT or a weighted average of MATand MAT. The mass average enthalpy MAE may be calculated as a function of pressure and temperature at a dispenser filling the compressed gas tank. The density may be calculated based on the mass average enthalpy MAE . The method may include a process check and monitoring for one or more stop conditions. One or more of the stop conditions may be based on pressure at the dispenser or temperature at the dispenser.

The method may include determining a second fill time t based on one or more coefficients selected from a second lookup table. The lookup table associated with the fill time may correspond to a first tank category while the second lookup table associated with the second fill time may correspond to a second tank category. The method may include selecting the larger e.g. more conservative or worst case of the fill time and the second fill time as the fill time t . The pressure ramp rate RR may be determined based on the fill time t . Further the pressure ramp rate RR may be determined based on the equation 

According to one or more aspects a system for filling a compressed gas tank may include a controller and a dispenser having a flow regulator. The controller may determine a fill time t predicted to produce a gas final temperature T based on one or more coefficients selected from a lookup table of one or more lookup tables mass average dispenser gas temperature for control MATC and alpha. The controller may also determine a pressure ramp rate RR a mass average enthalpy MAE and density. The dispenser may deliver gas to the compressed gas tank at a control pressure based on the pressure RR during a first portion of filling the compressed gas tank. The dispenser may deliver gas to the compressed gas tank at a target ending fueling pressure based on the density and the gas final temperature during a second portion of filling the compressed gas tank.

The system may include an ambient temperature sensor for measuring an ambient temperature T a pressure sensor for measuring a pressure in the gas tank P a database component having one or more of the lookup tables each table comprising one or more of the coefficients wherein respective lookup tables are indicative of one or more tank categories associated with one or more conditions or a mass flow meter for measuring a flow rate of the delivered gas.

The goal of the methods and systems detailed in this disclosure are to provide and utilize both a filling model and an associated algorithm that can be used by a hydrogen tank filling station or indeed any gas tank filling operation to improve the accuracy of the end of fill temperature and pressure for a range of hydrogen tanks and a range of ambient and operating conditions. Implementation of the methods and systems detailed below during hydrogen tank refueling events can improve the efficiency accuracy and or safety of the refueling operation by avoiding overfilling and avoiding overheating the hydrogen tank.

Accurately estimating the end of fill temperature of a refueling event is difficult which is why communication refueling has been developed where temperature and pressure information is directly transmitted to the hydrogen tank filling station via one or more communication device s including for example the Infrared Data Association IRDA interface detailed in SAE TIR J2799 the disclosure of which is incorporated herein by reference in its entirety. The corresponding lack of such temperature and pressure information is the reason that non communication fueling protocols require a large margin of safety particularly given the additional unknown parameters including for example the tank type the tank size the aspect ratio the number of tanks hot or cold soak status.

Although full communication fueling can be used to provide the tank parametric data to the hydrogen tank filling station full communication fueling adds more cost and complexity to both the station and the vehicle and raises additional concerns particularly with regard to the use of in tank sensors. Accordingly there remains a need for a method that provides for sufficiently accurate predictions regarding the temperature of the hydrogen in the tank during refueling without requiring full communication protocols and hardware.

In order to provide an accurate prediction of the temperature of the gas both the amount of energy that has been transferred to the tank and the quantity of heat that has been transferred from the gas to the wall of the tank are estimated. Many studies have been conducted in trying to understand and quantify the end of fill temperature.

As used herein MC may represent mass specific heat capacity. As used herein gas may include hydrogen hydrogen fuel fuel etc. As used herein a compressed hydrogen storage system CHSS may be referred to interchangeably as a gas tank a CHSS tank a tank a fuel tank etc. As used herein a fuel dispenser may be a hydrogen dispenser hydrogen fuel dispenser etc. As used herein RR may mean pressure ramp rate or ramp rate.

By modeling a hydrogen tank as an open system in unsteady flow as illustrated in it is possible to estimate the amount of energy that has been transferred to a tank by measuring the enthalpy of the incoming hydrogen stream and monitoring the temperature of the tank. For the purposes of this disclosure the control volume is defined as the boundary between the gas and the tank liner with heat being transferred through the boundary of the control volume and into the liner of the tank. The total heat transfer in and out of the system Q is reflected in Equations 1 and 2 .

The enthalpy can be determined by measuring the temperature and pressure of the hydrogen in the flow stream preferably at a point close to or at the tank inlet with the mass flow into the tank being measured or calculated from initial and final conditions. To estimate the final temperature of the gas during or after a refueling procedure the actual heat transfer Q from the gas into the tank wall should be estimated. Because Equation 2 only gives information for the internal energy state of the tank a tool such as the National Institute of Standards and Technology NIST Thermophysical Property Database is used to look up the temperature from the internal energy properties of the target gas e.g. hydrogen. A curve fit to the NIST data used here for internal energy is illustrated in . The difference between the adiabatic internal energy and the measured internal energy uat measured temp and pressure is the quantity of heat that is transferred from the control volume and can be determined from test data.

To calculate the end of fill gas temperature T the amount of heat that is absorbed by the tank wall may be estimated. One method of calculating the total heat transfer is to integrate the temperature distribution over the tank volume at the end of a vehicle refueling procedure. In 2003 General Dynamics conducted a series of tests aimed at understanding the relationship between final tank temperature and filling time with the results being reported in Eihusen J. A. Application of Plastic Lined Composite Pressure Vessels For Hydrogen Storage World Hydrogen Energy Conference 2004 Eihusen the disclosure of which is incorporated herein by reference in its entirety. As detailed in Eihusen a series of filling tests were conducted while measuring the temperature of the gas and of various locations in the hydrogen tank wall.

These results indicated that during a refueling operation the heat transfer process was a process in which the temperature of the outer surface of the tank did not rise indicating that no appreciable quantity of heat was being transferred through the tank wall. Based on these results General Dynamics proposed a heat transfer model for predicting the temperature distribution within the tank wall which was based on a Green s Function solution to the general heat equation with a constant heat flux on the inside surface and an adiabatic boundary on the outside surface. See Equation 6 . A constant heat flux model showing temperature distribution dependent on time with an adiabatic boundary condition is illustrated in . Note that the assumption of no heat transfer from the outside of the tank is conservative meaning that the actual final temperature in the tank can tend to be somewhat lower than the final temperature calculated using this assumption.

Inherent in this approach is the assumption that given an initial set of conditions hydrogen tank temperature fuel gas temperature and pressure the fueling temperature result and the temperature distribution result is purely dependent on time. The amount of heat transferred to the liner during a refueling procedure could be estimated by integrating the temperature distribution over the volume of the liner. General Dynamics found that for the given set of tests this model predicted the final tank temperature within 3K. The assumption of a constant heat flux or of temperature dependence only on time is however both interesting and problematic. Different initial conditions temperature of the tank initial fill mass of the tank temperature and or pressure of the incoming gas can produce different temperature gradients and hence a different average heat flux. Further the heat flux would depend on the conditions of the boundary layer between the gas and the wall a change in the velocity density or temperature of gas flow over the wall resulting from forced and or free convection inside the tank would result in a corresponding change in the heat transfer. As these conditions do tend to vary during the actual tank filling procedure the heat flux can also tend to vary over the course of the filling procedure.

Furthermore hydrogen refueling tests by the Japan Automobile Research Institute JARI as reported in Hirotani R. et al. JARI Thermal Behavior in Hydrogen Storage Tank for Fuel Cell Vehicle on Fast Filling World Hydrogen Energy Conference 2006 the disclosure of which is incorporated herein by reference in its entirety revealed a significant temperature distribution within the gas itself up to a 30K difference throughout the tank which would influence the heat flux. The presence of such temperature distributions further complicates the analysis of data as well because it renders it difficult if not impossible to know precisely how accurately a particular temperature measurement taken inside the tank represents the bulk properties of the tank.

Relative to the bulk temperature if the thermocouple is measuring a temperature that is warmer or cooler than the average bulk temperature the calculated values can be less accurate. Although it is customary to assume that temperature measurements taken at or near the centerline of the tank can represent the average bulk gas temperature the magnitude of the error s associated with this assumption are unknown in practice. Data taken during the development of the MC formula fueling control method and system disclosed in U.S. patent application Ser. No. 12 982 966 showed unexplained errors of 5K between the thermocouple output and the expected bulk gas temperature. Modeling efforts by the SAE TIR J2601 committee similarly reflected errors of up to 9K between the modeled temperature and the measured data despite the use of thermocouples that have an accuracy of approximately 1K. These real world complications to the temperature gradient modeling make it difficult in practice to apply a heat transfer model for directly estimating the temperature distribution in order to calculate the end of fill temperature with reliance on one or more temperature signal s during communication fueling operations introducing a degree of uncertainty .

One objective of the JARI testing was to analyze the impact of utilizing different refueling patterns while still keeping the same overall fueling time. An interesting result of the JARI testing indicated that given the same initial conditions and a set filling time the temperature of the gas at the end of filling is similar regardless of the particular filling pattern used in conducting the filling operation.

Analysis presented by St. Croix Research to the SAE TIR J2601 Committee Powars C. 70 MPa Hydrogen Tank Filling Model and Test Data Observations SAE TIR J2601 Modeling Sub Team Meeting Sep. 15 2008 St Croix Research 2008 the disclosure of which is incorporated herein by reference in its entirety also shows that the outer tank temperature does not rise significantly during a vehicle refueling.

While complex heat transfer models and analysis were previously proposed to explain the results of these tests the innovative approach described herein is based on analyzing tank refueling processes using a simple lumped heat capacity model the development of which is described in more detail below and further illustrated in the associated figures. The utility and applicability of this novel solution can be confirmed by using the JARI General Dynamics SAE and St. Croix Research results to show that the simplified model based on lumped heat capacitance detailed herein models and predicts the heat transfer characteristics of the system with sufficient accuracy. Additional testing and analysis of fueling data was conducted and the results further verified that this new method of using this lumped heat capacitance model is sufficient for accurately describing the thermodynamics of hydrogen tank refueling systems and improving the associated refueling processes.

Consider a tank that has just completed a vehicle refueling in a short period of time. As illustrated in the inside of the tank is much hotter than the outside of the tank due to the conversion of pressure energy to sensible energy of the high pressure hydrogen that was just recently injected into the tank. Calculating the actual temperature distribution is difficult because 1 there is a temperature distribution between the hydrogen in the tank and the liner due to boundary conditions 2 there is a temperature distribution through the liner contact resistances between layers 3 there is a temperature distribution through the various layers of the tank and 4 there is a temperature distribution between the outside of the tank and the environment due to the outer boundary conditions. And as discussed previously there may also be a temperature distribution within the hydrogen in the tank itself on the order of 30K. Each layer has a different specific heat capacity that might also be dependent on temperature and each layer is composed of a different mass. Given all of these complexities it is exceedingly difficult if not impossible to calculate the precise temperature distributions through the wall of the tank.

The biggest difficulty in considering a heat transfer model based on a precise calculation of the temperature distribution in the wall of a hydrogen tank is that it requires a solution to the temperature distribution for the entire time domain of a refueling event a solution which is difficult to achieve in practice. Accordingly the method utilizes a combined mass and specific heat capacitance model as shown in which illustrates a simplified section of a tank wall having an imaginary characteristic volume defined by its mass M and specific heat capacity C and an adiabatic external boundary. The temperature of the characteristic volume can be the same as the temperature of the gas for example hydrogen.

This section of the tank wall the characteristic volume can have a combined mass and specific heat capacity MC kJ K . Note that the characteristic volume and the associated MC are mathematical constructions only. Given knowledge of a tank design and the materials used in the tank construction it is possible to provide a reasonable estimation of the MC value. In the method disclosed herein however there is no need to calculate the exact mass and specific heat capacity of the tank because the characteristic volume simply acts as a heat sink allowing its characteristics to be used in predicting the thermal behavior of the tank system.

In applying the method the temperature of the characteristic volume is set to be equal to the temperature of the hydrogen in the tank at the end of the vehicle fill. This means that the characteristic volume has both high thermal conductivity and high convective heat transfer coefficient. In addition Q 0 meaning that no heat is transferred out of the characteristic volume during the fueling adiabatic boundary . As discussed supra there is very little heat transfer to the environment during the refueling operation allowing this component of the heat transfer to be ignored. In an illustrative example the heat transfer equation is solved for the target or preferred end of fill condition of for example a fill time of 2 or 3 minutes plus some adjustment for longer fill times as desired. For the purposes of this disclosure a target fill time of 3 minutes has been used but the method can be easily utilized for longer or shorter fill times.

When applying a characteristic volume in this manner the heat that is transferred from the hydrogen mass m into the characteristic volume can be described by the temperature rise during the fueling of the characteristic volume with a combined mass and specific heat capacity of MC. 7 

By applying an energy balance across the boundary of the control volume and combining Equation 5 energy transferred from the hydrogen with Equation 7 energy transferred to the characteristic volume results in 

Equation 10 can then be used to calculate the expected final temperature of a hydrogen tank refueling just as a fill has started. The MC parameter and m the end of fill mass in the control volume are transmitted to the station. In a non limiting example the MC parameter and mare transmitted by RFID through the SAE TIR J2799 IRDA interface or via an identification number that corresponds to entries in a database that is readily accessible to the hydrogen tank filling station. The hydrogen tank filling station can calculate Tfrom mand parameters including 1 the initial pressure of the tank receiving the hydrogen e.g. the vehicle s tank 2 the initial temperature of the tank receiving the hydrogen assuming ambient conditions plus some differences due to the possibility of a hot or cold tank as discussed in SAE TIR J2601 and 3 the enthalpy of the delivered hydrogen which is a function of the expected average temperature and pressure of the delivered hydrogen further description is given in the Appendix provided in .

Certain characteristics of the MC Method make it particularly useful for gas delivery systems. For example a particular tank configuration can have a characteristic curve of MC v. fill time from which adjustments can be made to compensate for a range of initial conditions. Utilizing the MC model avoids the need to address all of the intricacies of the temperature distribution of the wall of the tank especially over a time scale associated with typical hydrogen tank refueling procedures e.g. two to three minutes or more.

MC is not a direct physical constant such as the mass and the specific heat capacity of the tank and liner material but rather it is a composite value similar to an overall heat transfer coefficient that encompasses heat transferred to tank valve assemblies and piping as well as heat transferred to the hydrogen comprising the initial gas volume inside the tank being filled. Systems with slower heat transfer characteristics convection or conduction can tend to result in lower values of MC such as Type 4 tanks while systems with faster heat transfer characteristics convection or conduction can tend to result in higher values of MC such as Type 3 tanks . Although MC is a function of a number of different parameters including for example time fill conditions tank materials tank configuration etc. for a given tank fill time and set of fill conditions MC can be constant. The trend in the MC value over both time and under different fill conditions can be predicted and in turn utilized for adjusting the hydrogen tank filling procedures to improve efficiency while maintaining desired safety margins.

Based on observations of several sets of test data coupled with the use of multiple linear regressions for evaluating the significance of various parameters many possible physical models were considered for describing the MC v. time curve and also describing the changes in initial conditions that were tested. In a non limiting example one model is represented by Equation 11 as shown below 

In the context of Equation 11 C is a constant that represents a minimum heat capacity of for example a 2 minute fill or a 3 minute fill A is a constant representing an adjustment to the MC corresponding to the initial fill conditions and pre cooling amount and constants g k and j are if necessary utilized within the MC Method to provide the ability to adjust the resulting MC by extending the fill time beyond 2 or 3 minutes so that Tcan be optimized around a desired temperature. However it is to be understood that those skilled in the art will appreciate that there are many possible models that can be developed to predict the trend of MC with time internal energy pre cooling temperature etc. The MC Method is not intended to and does not attempt to perfectly describe the physics but instead provides an analytical engineering tool that can be used for predicting the temperature outcome of a particular filling procedure by approximating the equivalent heat mass of the system.

One way to check a new model is to verify that the model is capable of describing or predicting phenomena documented in previous literature. The Society of Automotive Engineers SAE conducted several sets of hydrogen tank fill testing at Powertech during the development of SAE TIR J2601 in support of and to test the modeling efforts that were being conducted to build the refueling tables in SAE TIR J2601. By using the tables provided in SAE TIR J2601 as a set of test fills and plotting the MC of each fill versus the fill time using Equation 8 the results fall in a distinct pattern as illustrated in .

This result is encouraging for several reasons including but not limited to 1 because the MC Method describes the actual results of the SAE TIR J2601 tests quite well suggesting that the model accurately represents the physics of hydrogen tank filling and 2 because the entire set of tables in SAE TIR J2601 can be approximated using this single equation. This result indicates that the equation utilized in the MC Method can be used to describe the MC v. Time over a wide range of conditions and can be used in place of the several sets of tables defined in SAE TIR J2601 which require interpolation between the listed data to find the appropriate pressure ramp rate and end of fill pressure target. Because the MC Method can adjust the fill time to match a desired final tank temperature it can be used for any station configuration. This releases the fill protocol from reliance on the rigid Type A B C D station type designations of SAE TIR J2601 because the resulting fill temperatures can be derived for a wide range of station conditions. Indeed by using the coefficients of the MC v. time curve utilized in the MC Method a hydrogen tank filling station can directly calculate the expected end of fill temperature T using Equation 10 .

As will be appreciated by those skilled in the art using the SAE TIR J2601 tables to calculate a characteristic MC curve provides a characteristic curve that corresponds to a default SAE TIR J2601 tank . Accordingly when this MC curve is used in Equation 10 the fill results are substantially the same as those represented in the SAE TIR J2601 tables. The MC Method however is intended to provide for fill times that are both shorter than predicted from the SAE TIR J2601 tables and provide for improved fill quality. In order to achieve this result the MC Method incorporates the specific characterized MC curve corresponding to a specific tank.

A set of fill tests were conducted at Powertech during Feb. 1 6 2010 and Aug. 23 30 2010 in order to characterize a 171 L Type 3 35 MPa tank an approximately 109 L Type 4 70 MPa tank and the same Type 4 70 MPa tank filled to 50 MPa and a 34 L Type 3 70 MPa tank. Each tank was tested using pre cooled and non pre cooled gas at 25 C. ambient and 2 MPa starting pressure or tank starting pressure. Each tank was filled in approximately 1 to 3 minutes at the given conditions and data recorded for 1 hour following. Each tank was then defueled and allowed to soak at the ambient temperature until the next test the following day.

Using Equation 8 the MC v. time was plotted for each fill as shown in . All of the tank fills follow a similar pattern of MC v. Fill Time as shown in . The resulting curve corresponds to the tank characteristic s for a given tank under a given set of conditions. To find the coefficients used in Equation 11 the MC for each end of fill at 3 minutes was plotted against the adiabatic internal energy divided by the initial internal energy as shown in . The slope and intercept of the linear best fit line give the coefficient A and the constant C respectively. The MC v. time that is MC MC v. t 180 s is then plotted as shown in and a best fit model is used to determine the coefficients g k and j. These coefficients can then be used to describe how much heat is absorbed by the tank in the time beyond the typical fill time and are particularly useful under conditions in which the ambient temperature is too warm and or the pre cooling temperature is too warm to achieve an end of fill temperature of less than 85 C. with a refueling time of 3 minutes or less.

To use the MC parameters for improving the performance of a hydrogen tank filling station a fueling protocol needed be developed. A fueling protocol should provide safe high state of charge SOC fills for a broad range of ambient conditions and initial fill conditions. Comparing the current fueling standards with the actual operating ranges of existing hydrogen stations as illustrated in it is clear that the current refueling standards do not satisfy a broad range of station fuel delivery operating conditions. Further should a vehicle manufacturer or modifier introduce a tank designed to operate at another pressure of for example 50 MPa the fueling standard s would have to be rewritten to accommodate this modification.

In order to fully utilize the MC Method at an actual fueling station the MC parameters should be communicated to or determined by the station in some manner. This data collection could be achieved in a number of ways. In a non limiting example RFID or even the IRDA interface defined in SAE J2799 may be used to transmit the MC parameters from the vehicle to the station. There is a working group within the California Fuel Cell Partnership that is developing a Hydrogen Vehicle Authorization System HVAS to be used for confirming that a vehicle is authorized to fuel OEM vehicle or a conversion that meets safety requirements . The HVAS specifications and device are still under development but it is a candidate for communicating the MC parameters to the station either directly through the device or alternatively by matching the identified vehicle to a database from which these parameters could be retrieved.

The MC Method can also readily accommodate the communication of specific modification to the fill protocol preferred or specified by the OEM. For example if an OEM imposes or suggests a maximum fill rate develops a tank system in which the maximum temperature can exceed 85 C. or allows fueling to 103 SOC if inside of the Maximum Allowable Working Pressure MAWP parameters related to the OEM s design or operating limits and or preferences can be provided to the hydrogen tank fueling station for modifying the fill protocol accordingly. This flexibility puts additional control of the outcome of the vehicle refueling squarely into the hands of the OEM so that fill stations utilizing the MC Method can adapt the fill protocol to accommodate the particular vehicle and thereby permit a broader range of OEM designs.

In an embodiment when applying the MC Method the fueling process can include two discrete steps. In the first step parametric data is used to determine an appropriate fueling fill rate i.e. one that does not overheat the gas in the tank. During the second step the fueling fill rate is used to determine a target end of fill pressure that can keep the system pressure within the target pressure ranges. These two steps are explained below in more detail. In order to determine the appropriate fueling rate for the projected fill operation the hydrogen tank filling station takes into consideration both the capabilities of the vehicle tank system and its own capabilities to deliver the fuel under the current conditions.

The limits of refueling as defined in SAE TIR J2601 and TIR J2579 are 85 C. and 125 of the NWP for average gas temperature and pressure respectively. In an illustrative example the station makes an assumption about the average gas temperature inside the tank based on measuring the ambient air temperature and optionally adding a margin for a hot soak condition e.g. the vehicle has been parked in an environment that is hotter than ambient such as a hot garage or parking lot . The station also determines the approximate initial SOC of the vehicle using the temperature assumption and by dispensing a small amount of fuel to the tank to equilibrate the hose pressure to the tank pressure. Based on the tank pressure and vehicle side information the station can estimate how much hydrogen mass should be delivered to the vehicle to achieve the desired SOC and utilizing an estimate of its pre cooling capability the station can calculate the average enthalpy that can be delivered to the vehicle s tank system during the fill operation. Working from this information the station can then determine how quickly to fill the vehicle while maintaining the requisite safety margin.

As explained supra the primary MC parameter is based on a target fueling time with additional parameters being used to account for the initial SOC and or fueling times that exceed the target fueling time. Starting with these targets the station analyses an initial fill protocol to determine if the fill can be successfully completed i.e. end of fill temperature within specification. If it is determined that the initial fill protocol cannot be successfully completed an iterative process is initiated to determine an appropriate fueling time. For example if the fueling operation can be conducted in the target time without exceeding any temperature limits the station can initiate fueling.

If however the initial fill protocol would cause a temperature limit to be exceeded the projected fueling time can be increased by some increment e.g. 0.1 1 5 10 seconds etc. and the new MC value can be calculated. This incremental increase of the fueling time can continue until a fueling time is identified that results in end of fill conditions that are within specification e.g. the end of fill gas temperature is less than 85 C. This process is shown in . The output of this Step 1 is the Tand the fueling or fill time. In an embodiment the appropriate fueling time can be continuously calculated throughout the fill procedure based on the actual enthalpy delivered to the vehicle. Accordingly even though the fueling time calculated at the beginning of the fill should be a good approximation the fueling time or rate of pressure rise during the fill can be adjusted utilizing a feedback loop based on the actual fill conditions as they occur.

For the dispenser to make the assumption that the upper bound of gas temperature inside the tank is ambient T plus a T hot soak it should know that the vehicle has not been refueled in the recent past. If it cannot know this information then it should make a more conservative assumption and determine the fueling speed based on an empty or nearly empty tank. Then even if the vehicle was recently refueled the fueling speed does not overheat the tank.

If the recent fueling history of the vehicle can be determined a less conservative fueling speed can be utilized potentially shortening the fueling time considerably. There are a number of approaches that can be utilized for determining the recent fueling history of the vehicle. A non limiting example is for the HVAS RFID tag to be time stamped each time the vehicle is fueled. The dispenser can then read this time stamp each time the vehicle is fueled and determine whether to use a conservative fueling speed if the time stamp indicates a recent refueling or a less conservative fueling speed based on the actual starting pressure in the tank if the time stamp indicates refueling has not occurred recently.

Once the appropriate fueling time has been determined the next step of the MC Method is to determine when or at what pressure to stop the fill operation. The process used by the station in this second step is similar to that used in the first step except that the station assumes the gas temperature inside the tank at the beginning of the fill is below the ambient temperature i.e. a cold soak condition which includes the possibility that the tank has been soaked in an air conditioned garage or that the ambient temperature is rising and the internal gas temperature lags the ambient. There is also the factor of driving that may be considered in which the gas temperature inside the tank has been reduced as a result of the decrease in pressure as the hydrogen was consumed. The MC Method can be used to estimate the average temperature of the MC and hydrogen gas during defueling using Equation 12 

The appropriate Tparameter and the defueling mass flow rate dot over m can typically be determined by the OEM and can be provided as part of the vehicle side information transferred through HVAS or otherwise made available to the filling station.

Once the initial conditions have been determined the station can calculate how much mass should be added to the tank to reach the target density of 100 SOC. If the station has an accurate flow meter it can simply integrate the mass flow during the fill and stop when the target mass has been achieved however the application of a flowmeter in this capacity might have its own challenges. A second option is to calculate a pressure target utilizing the same set of equations as in Step 1. Tcan be calculated based on the fueling time of Step 1 and then the Pvalue can be calculated based on the pressure that in conjunction with T provides a 100 SOC target density.

This process can be more easily understood by utilizing the equations shown in . It is important to note that the pressure target can be continuously calculated throughout the fill procedure based on the actual enthalpy delivered to the vehicle. Accordingly even though the pressure target calculated at the beginning of the fill should be a very good approximation the pressure target utilized in stopping the fill can be adjusted based on the actual fill conditions as they occur. The output of this Step 2 is the P.

In the case of a fill with communications the initial temperature can be measured directly by the station. Because this initial temperature is a settled temperature i.e. a temperature not subject to the dynamic changes associated with vehicle fueling it is typically reliable. In such cases the Tis simply the measured initial temperature and the hot soak and cold soak assumptions detailed above need not be considered.

During the fill testing conducted during development of the MC Method a Target T value was calculated in order to evaluate any errors between the expected result and the actual result. This Target T is shown in and to demonstrate the accuracy of the MC Method. In a normal ID Fill Step 3 e.g. of is unnecessary the station does not need to calculate an expected result as the fill protocol may be defined by Step 1 and Step 2.

Using the fill rate from Step 1 and the Pressure Target from Step 2 the expected Tcan be calculated. Because the Pressure Target calculated in Step 2 is usually lower than the Pressure Target that was assumed in Step 1 the resulting fill can tend to exhibit a slightly lower SOC which in turn indicates that the gas density target needs to be reduced to match the Pressure Target at a higher Tthan was calculated in Step 2. Because a change in additional mass of hydrogen added affects the T for greater precision the outlined calculations may be completed in order to determine the expected Tand SOC target.

The utility and flexibility of the MC Method provides many opportunities for customization and refinement to encompass for example fueling times of less than 3 minutes for tanks that start filling at high SOC.

To confirm the MC parameters calculated according to the procedures defined supra and to confirm the accuracy of using these parameters in the filling algorithm detailed supra a fifth fueling test was conducted for each of the previously tested tanks using conditions of ambient temperature initial fill amount and pre cooling temperature that were different than the conditions used in characterizing the tank. Using the algorithms discussed supra and illustrated in the expected final temperature Twas calculated for fills conducted at 35 MPa 50 MPa and 70 MPa. For the Hot Soak margin of safety to overheat T Ambient Temp 7.5 C. was used for the Cold Soak margin of safety to overfill T Ambient Temp 10 C. was used. For the target T T Ambient Temp was used in the algorithm illustrated in .

The results of a 35 MPa Type 3 Tank Confirmation Test are illustrated in . Although the original targets were set for delivering 0 C. gas the hydrogen filling station being used for the evaluation was actually delivering nearly 5 C. gas which would be outside of the SAE TIR J2601 tolerance of 0 C. 2.5 C. for a Type C station. This demonstrates one of the practical challenges of defining a tight tolerance on the pre cooling temperature it is actually difficult to achieve and or maintain even in test conditions. In light of the noted capabilities of the hydrogen filling station the targets were adjusted for using 4.8 C. as the temperature of the delivered gas the 35 MPa tank fill actual temperature measurement was within 1K of the calculated T. Further although fill completion was targeted for 180 seconds the actual fill was finished at 196 seconds. As a practical measure in order to achieve an optimum fill time the Hot Soak Bound should be set at 85 C. however because the test was predicated on a 3 minute fill target the Hot Soak Bound is less than 85 C. The MC Method algorithm can be further refined to improve performance for fill times of less than 3 minutes.

The results of a 70 MPa Type 4 Tank Filled to 50 MPa Confirmation Test are illustrated in . In this instance although the pre cooler was set for 20 C. it was determined that the pre cooler was actually delivering 14.8 C. gas on average. This result once again reflects the actual difficulty of meeting SAE TIR J2601 tolerances of 20 C. 2.5 C. for a Type B station. In light of the observed performance the temperature targets were adjusted to reflect what 15 C. pre cooling targets would have been given the same conditions otherwise. Although this rendered the Hot Soak bound high at 89 C. this deviation is a relic of the pre cooling temperature being out of specification.

Also noted were changes in temperature in the tank measured after the end of fill. These post fill deviations represent a practical source of error in temperature measurements in a hydrogen tank that may result from for example thermocouple placement temperature gradients within the tank and or time lag. Given these errors however the actual fill result was still remarkably close to the target further validating the model. Additionally 85 C. was not utilized as a stop point in these fills thereby allowing the tanks to reach temperatures slightly above 85 C. These minor temperature deviations were not considered problematic because transient temperatures above 85 C. are generally known and allowed pursuant to SAE J2579 the disclosure of which is incorporated by reference in its entirety.

The results of a 70 MPa Type 4 Tank Confirmation Test are illustrated in . As reflected in the illustrated data the 70 MPa tank test temperature result was an essentially perfect match for the calculated TTarget.

Comparing the data obtained from the 4 test fills used to generate the constants of Equation 11 to the data generated in the fifth verification fill and additional verification fills the results reinforce the concept that the MC is characteristic for the tank and can be used to predict the fueling result. This is demonstrated in the graphs illustrated in in which the data generated during the Type 3 Tank confirmation tests detailed above is consistent with the data used in determining appropriate values for the various constants utilized in Equation 11 . These results demonstrate that the MC Method is sufficiently robust to be applied confidently across a range of tank configurations and operating conditions.

Looking at the error from all of the fills conducted as illustrated in it is apparent that the MC Method yields very accurate results for Type 3 and Type 4 tanks typically falling within a range consistent with that expected from variations in thermocouple placement and or time lag errors. As shown in the MC Method Model error is the difference between Tas calculated by the MC Method and the actual final temperature result measured at the end of the fill procedure. The actual pre cooling temperature of the station was used as the input to the enthalpy calculation rather than the pre cooler set point for the reasons described supra. Known or suspected sources of error include for example 

Given all of these possible sources of error it is remarkable that the data generated during testing suggests that a lumped heat capacity model can achieve a standard deviation of errors of 0.6K for Type 3 Tanks and 2.4K for Type 4 Tanks. The Definition Error as shown in removes the error in calculating enthalpy calculating mass and calculating MC coefficients by using the test data to determine the actual heat transfer the actual average enthalpy of the fill and the actual MC value and using those to calculate T. This removes substantially all of the errors and approximations attributable to the calculations of the MC Method itself leaving only the measurement errors as the source of error. This has a standard deviation of 0.3K for the Type 3 tank and 1.3K for the Type 4 tank. The remaining portion of the errors is likely a result of measurement errors thermocouple lag and or differences between the assumed and actual conditions such as cold spots in the tank after defueling . It was noted that as the pace of the testing increased the magnitude of the errors also tended to increase possibly as the result of differences between the assumed and actual conditions including for example residual cold spots remaining from the defueling operations conducted between filling tests.

A sensitivity analysis of the MC Method to variations in input errors was conducted to examine the correspondence between known levels of input errors and the resulting output errors. As reflected in the data presented in the MC Method was relatively resistant to input errors with Type 3 tanks being more sensitive to variations in the initial temperature measurements while Type 4 tanks are more sensitive to variations in the temperature measurement of the flow stream at the station. 10K errors in the initial temperature measurement may lead to 6K errors in Tfor both Type 3 and Type 4 tanks. 10K errors in the hydrogen temperature measurement at the station used for the average enthalpy approximation lead to Terror of 6K for Type 3 tanks and 8K for Type 4 tanks. 10 errors in the calculated MC coefficients lead to errors of around 3K and 3K represents approximately a 1 error in the density of hydrogen . These results demonstrate that the MC Method has significant robustness to accurately describe vehicle fueling over a range of conditions and suppress the effect of input errors.

As detailed above utilizing the MC Method for refining Fueling Protocols can improve fueling performance. Although an ID Fill fueling protocol was discussed supra the MC Method may also be applied to conventional non communication fueling operations as well as full communication fueling operations as currently defined in SAE TIR J2601. A comparison of fueling methods is shown in which highlights the benefits that could be expected to flow from incorporating the MC Method into all three types of fueling i.e. ID Fill Non Communication and Full Communication . These benefits are further elaborated upon in the discussion provided infra.

In an ID Fill configuration the fueling process is better adapted to the tank that is being fueled thus tending to provide reduced fueling time and increased SOC within the bounds of the uncertainties of the initial conditions of the tank and the measurements at the station. The fueling process is also better adapted to the station s real time capabilities thereby increasing operational flexibility and avoiding the rigid preset tightly bounded temperature requirements corresponding to the various station types as defined in SAE TIR J2601. The MC Method allows the filling process to self adjust to the current fueling capabilities of the station thereby providing the potential for simpler more flexible and less costly hydrogen filling stations. The flexibility of the MC Method allows a hydrogen filling station to be tuned to the current operating environment which in turn may allow for increased pre cooling temperatures while still maintaining generally acceptable fueling times under most conditions. The ability to run at higher pre cooling temperatures can improve station efficiency lower costs and maintain customer satisfaction.

Fueling processes incorporating the MC Method as detailed supra could eliminate the need for the look up tables currently utilized for non communication fueling in accord with SAE TIR J2601 resulting in the same benefits as outlined above. The non communication fueling operations could include calculations of the MC Parameters of the boundary condition tanks utilized in building the non communication look up tables. When operating at the Type A 40 C. or Type B 20 C. pre cooling temperatures the resulting range of fueling rates and pressure targets would be expected to be substantially the same if not identical to those defined in the look up tables.

The flexibility of the MC Method in addressing variations in temperature and pressure would reduce or eliminate the need for rigid definitions of Station Types as currently applied and would allow each station to operate more efficiently for its current environment and to dispense fuel at improved rates regardless of its pre cooling temperature. Conversely non communication processes as defined in SAE TIR J2601 should operate within very tight pre cooling tolerances and if it falls outside them cannot dispense fuel resulting in unhappy customers until its margins are back within the specified range s .

The MC Method fueling process can also be utilized with full communication fueling resulting in a number of benefits. SAE TIR J2601 currently defines two types of communication fueling including 1 a Default method in which fueling rates are the same as the non communication fueling rates defined in the look up tables and 2 an Alt Method in which a more aggressive fueling rate can be utilized in those instances in which a vehicle Temperature Signal can be utilized in a feedback loop to regulate the fueling rate in order to suppress or avoid an overheat condition. With the MC Method the fueling rate is determined at the beginning of the fill just as described above and is also checked during the fill based on the actual enthalpy of hydrogen delivered during the fill. With communications fueling the initial and transient conditions can be more tightly defined giving even better results. Incorporation of the MC Method would mean that the Default and Alt Methods would no longer be needed a single communications fueling protocol could be defined and it would be adapted for the vehicle being fueled and the fueling conditions.

From a safety standpoint the MC Method allows an additional cross check based on the Temperature Signal received from the vehicle. Because the station can calculate the expected temperature from the MC parameters and delivered enthalpy it can cross reference this with the temperature signal from the vehicle. The temperature signal at the beginning of the fill procedure is generally constant so by using the actual measured initial temperature and the characteristic MC parameters the vehicle fueling protocol can be fully defined and higher quality fill results can be achieved as reflected in both SOC and fill time .

The MC Method Fueling Protocol can be utilized comprehensively by the station for Identification Fueling Non Communication Fueling and Full Communication Fueling resulting in a fill protocol that is better adapted to the current capabilities of both the vehicle and the hydrogen filling station capabilities and takes into account the current operating environment to achieve higher quality fills.

An aspect of using the MC Method is the accurate prediction of the mass average enthalpy that can be delivered to the tank during a refueling procedure or event. As shown in a 10K error in the mass average temperature can result in a 6K to 8K error in T so it is important to accurately predict the enthalpy of the upcoming fill. In connection with the MC Method testing a Runge Kutta approximation was developed for average hydrogen enthalpy at the nozzle from stations using pre cooling as illustrated below in Equation 16 .

During testing it was found that P 5 MPa if the initial tank pressure was 2 MPa 2 MPa if the initial tank pressure was 17 MPa and 1 MPa at higher initial pressures. Pwas assumed to be 1 MPa in all cases. Therefore the algorithm may be modified to reflect more accurately the conditions and performance of a particular station. In an illustrative example the station builder or operator may modify the algorithm to more accurately reflect the conditions and performance of the station.

During several test fills deviations were noted between the pre cooler output temperature and the actual temperature delivered at the nozzle. These deviations tended to follow a relationship with mass flow rate and pre cooling level as illustrated in . In general the higher flow rates and or larger differences between the pre cooling and ambient temperatures can be reflected in greater temperature deviations between the nozzle temperature and the pre cooler set temperature. Therefore such factors can be taken into account in the MC Method. In a non limiting example each station builder or operator may determine this relationship s for the range of expected operating conditions and parameters in order to select an appropriate pre cooling level that can typically provide customer friendly refueling times. This flexibility is one of the benefits of the MC Method it allows the station to calculate the appropriate fill time for a particular pre cooling temperature based on the conditions of that fill and the capabilities of the tank itself.

The algorithms utilized in practicing the MC Method are provided below. As the vehicle approaches the hydrogen filling station the vehicle provides the station via RFID IRDA or other communication method parametric data for a MC Method fill procedure. The parametric data can include for example 

Even if none of the parameters are communicated the station can use the MC Method to conduct the fill by utilizing default Constants of the MC Equation as derived from SAE TIR J2601 and the default Hot Soak Cold Soak assumptions of SAE TIR J2601.

As a practical measure Pcan be assumed to be the MAWP with only a very small error since internal energy has a very weak relationship with pressure.

A hydrogen station can maintain a database of MC parameters that have been communicated to the station and use the lowest performing MC parameter tank volume and lowest initial SOC historically observed to set the pre cooling temperature for the system in order to achieve a fast fueling rate given ambient temperature. In this way a station can keep the pre cooling temperature set at an economically optimal level.

As described above the MC Method calculates the appropriate fueling rate or speed based on the mass average enthalpy of the hydrogen fill with the mass average enthalpy estimated prior to the fill being conducted. Particularly according to the above described MC Method the station or dispenser makes an assumption about the average gas temperature inside the tank based on a measurement of the ambient air temperature and an optionally added margin for a hot soak condition . The station also determines the approximate initial SOC of the vehicle using the assumed average gas temperature inside the tank and by dispensing a small amount of fuel to the tank to equilibrate the hose pressure to the tank pressure. Based on the tank pressure and vehicle side information the station estimates how much hydrogen mass should be delivered to the vehicle to achieve the desired SOC and utilizing an estimate of its pre cooling capability the station calculates the average enthalpy that can be delivered to the vehicle s tank system during the fill operation. Working from this information the station then determines how quickly to fill the vehicle i.e. the fueling speed while maintaining the requisite safety margin.

According to another aspect the MC Method may be modified modified MC Method to employ active dynamic fueling speed control in which the hydrogen station or dispenser continuously calculates the mass average enthalpy dispensed to the vehicle tank during the fill based on real time measured conditions and uses the continuously calculated mass average enthalpy to adjust the fueling speed. More particularly the modified MC Method adjusts the fueling speed based on a pressure ramp rate such that the gas temperature inside the tank does not exceed a target temperature i.e. the 85 C. safety limit established in SAE J2601. Like the above described MC Method the modified MC Method active fueling speed control controls the fueling speed based on the mass average enthalpy. However whereas the above described MC Method estimates the mass average enthalpy of the hydrogen fill prior to the fill being performed the modified MC Method active fueling speed control continuously calculates the mass average enthalpy of the dispensed hydrogen based on real time measured conditions during the hydrogen fill. The fueling speed is then adjusted during the hydrogen fill based on the pressure ramp rate which is continuously determined based on the continuously calculated values of the mass average enthalpy as is described below.

Enthalpy can be determined by measuring the temperature and pressure of the hydrogen in the flow stream. The mass average enthalpy is determined as the sum of the determined enthalpy multiplied by the hydrogen mass dispensed to the vehicle tank over each of a plurality of predetermined time periods. As detailed below by continuously measuring the temperature and pressure of the hydrogen in the flow stream and using the continuously measured temperature and pressure to continuously calculate the mass average enthalpy the fueling speed can be actively determined and adjusted during the hydrogen fill to optimize the hydrogen fill.

With reference to to continuously determine the mass average enthalpy a hydrogen station is provided with a temperature sensor a pressure sensor a mass flow meter a hydrogen flow regulator and an ambient temperature sensor all of which communicate with a hydrogen station controller controller . The hydrogen station also includes a dispenser which includes a base and a hose . The hose is connected to and extends from the base and includes a nozzle at a distal end thereof. The nozzle is configured to couple with a vehicle input receptacle which communicates with a vehicle gas tank . Hydrogen gas is communicated from a source through the base and hose to the vehicle gas tank during fueling.

The temperature sensor pressure sensor mass flow meter hydrogen flow regulator ambient temperature sensor and controller are used to control the operation of the hydrogen station . The temperature sensor pressure sensor mass flow meter hydrogen flow regulator and ambient temperature sensor are generally known devices and will therefore not be described in detail herein. The controller may include one or more arithmetic processors computers or any other devices capable of receiving all of the herein described measurement inputs performing all of the herein described calculations and controlling the dispenser to dispense hydrogen to the vehicle gas tank as described herein.

To this end the controller may include an input receiver and a fueling speed controller . The input receiver communicates with and continuously receives measurement values as inputs from the temperature sensor pressure sensor mass flow meter and ambient temperature sensor . The input receiver continuously communicates these inputs to the fueling speed controller . The fueling speed controller calculates the fueling speed in the manner described below and controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen at the calculated fueling speed. More specifically the fueling speed controller continuously receives the inputs from the input receiver performs calculations to continuously calculate the mass average enthalpy pressure ramp rate and fueling speed and continuously controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen at the continuously determined fueling speed. It is to be appreciated that the controller may be used to receive inputs and perform calculations related to all of the other calculations of the above described MC Method and the modified MC Method.

With reference to the use of the mass average enthalpy to actively determine fueling speed in the modified MC Method it is first noted that the fueling speed is actively determined and controlled based on a calculated upper boundary for Pressure v. Time. shows a graph of Pressure v Time for a 70 MPa NWP tank. The upper boundary is defined by calculating the fastest Pressure v. Time profile based on the ambient temperature and a currently measured mass average enthalpy during the fill. For the 70 MPa NWP tank target final temperature 85 C. target final pressure P 87.5 MPa the pressure ramp rate RR is calculated using Equation 17 shown below 

During the hydrogen fill the pressure and temperature of the hydrogen in the flow stream are continuously measured and used to continuously calculate the mass average enthalpy h. In turn the continuously calculated mass average enthalpy his used to continuously calculate a total time to complete the hydrogen fill t and the total time to complete the hydrogen fill tis a variable is used in calculating the pressure ramp rate RR Equation 17 . With respect to calculating the mass average enthalpy hand total time to complete the hydrogen fill t Step 1 of the MC Method is modified by the modified MC Method as shown below.

The above algorithm is continuously performed as the pressure and temperature values are continuously measured so as to continuously calculate the mass average enthalpy hand the total time to complete the hydrogen fill t. The continuously calculated total time to complete the hydrogen fill tis then used to continuously calculate the pressure ramp rate RR using Equation 17 . The fueling speed is then continuously determined and actively controlled based on the continuously calculated pressure ramp rate RR.

More specifically the fueling speed is determined as a fueling speed which achieves a target pressure at a given future time where the target pressure at the given future time is determined based on the calculated pressure ramp rate RR. Referencing the graph shown in the target pressure at a given future time may be determined as a point on the Pressure vs. Time curve which is between tand t. The fueling speed is then controlled such that the pressure will equal the target pressure at the given future time. The selection of the given future time is discussed in further detail below. More particularly the hydrogen flow regulator increases or decreases the mass flow rate of hydrogen in order to match the defined pressure ramp rate RR from the fueling speed controller .

It is reiterated that as the mass average enthalpy hchanges tchanges and that as tchanges the pressure ramp rate RR changes. Moreover as the pressure ramp rate RR changes the target pressure at any given future time will also change. Accordingly by continuously measuring temperature and pressure and continuously calculating the mass average enthalpy hduring fueling the fueling speed can be continuously determined and actively controlled during fueling to optimize the fueling procedure.

With respect to determining the given future time it is to be appreciated that the continuous measurements and calculations may be iteratively performed at a plurality of predetermined time or pressure steps. For example measurement of the temperature and pressure and calculation of the mass average enthalpy h the total time to complete the hydrogen fill t the pressure ramp rate RR and the fueling speed may be iteratively carried out at predetermined time intervals e.g. every x seconds . Alternatively measurement of the temperature and pressure and calculation of the mass average enthalpy h the total time to complete the hydrogen fill t the pressure ramp rate RR and the fueling speed may be iteratively carried out at predetermined pressure levels e.g. every 1 MPa change . Accordingly the given future time may be set as a next time step or any other future time step .

As a further example it can be assumed that measurement of the temperature and pressure and calculation of the mass average enthalpy h the total time to complete the hydrogen fill t the pressure ramp rate RR and the fueling speed is iteratively carried out every 5 seconds. At the first time step t 5 seconds the calculated pressure ramp rate RR will be used to determine a target pressure at the second time step t 10 seconds . In this regard the target pressure Pat the given future time i where i and i 1 reference discrete time steps at which measurement and calculation are iteratively performed may be calculated using Equation 18 shown below 18 The fueling speed will then be determined and adjusted such that the measured pressure equals the target pressure at the second time step t 10 seconds inasmuch as is possible.

Accordingly the fueling speed may be adjusted so as to achieve the target pressure at a next predetermined time step for measurement and calculation. It is to be appreciated that while the instant disclosure references continuous measurement and calculation as used herein the term continuous may be considered to include iterative measurement and calculation as well as non iterative measurement and calculation. With respect to the non iterative continuous measurement and calculation a change in the measured temperature and pressure values may be used to trigger new calculation of the mass average enthalpy h the total time to complete the hydrogen fill t the pressure ramp rate RR and the fueling speed.

With further reference to the calculation of the mass average enthalpy h it is noted that it may take time for the gas to cool down at the beginning of the fill. The cooling of the gas may result in the calculated mass average enthalpy hbeing high which can yield a slow pressure ramp rate RR. Therefore as a further modification of the above algorithm an expected mass average enthalpy hmay be used until the calculated mass average enthalpy hdrops below a predetermined mass average enthalpy threshold. Once the calculated mass average enthalpy hdrops below the predetermined mass average enthalpy threshold and is observed to be decreasing then the mass average enthalpy hmay be calculated according to the above algorithm. This modification is reflected by the below algorithm 

As an additional modification a final mass average enthalpy at an end of the fill may be calculated based on a current calculated value of the mass average enthalpy h. The calculated final mass average enthalpy may then be used in Equation 17 to calculate the pressure ramp rate RR so as to facilitate determination of the fueling speed as described above. To calculate the final mass average enthalpy a minimum mass average enthalpy is set according to the following algorithm 

Once the mass average enthalpy is rising the mass average enthalpy may be extrapolated from the current average enthalpy to the end of the fill at P 1.25 NWP . Then a weighted average of the extrapolated mass average enthalpy and the calculated mass average enthalpy is used to calculate the final mass average enthalpy. The extrapolated mass average enthalpy and the final mass average enthalpy are calculated according to the following algorithm 

This algorithm ensures that the estimated final mass average enthalpy is always greater than or equal to the calculated mass average enthalpy. The calculated final mass average enthalpy may then be used in Equation 17 to calculate the pressure ramp rate RR so as to facilitate determination of the fueling speed as described above.

With reference to the hydrogen station dispenser shown in the inputs to Equations 17 and 18 and the above algorithm are provided by the temperature sensor pressure sensor mass flow meter and ambient temperature sensor which respectively measure the temperature of the hydrogen gas the pressure of the hydrogen gas the mass of hydrogen gas dispensed and the ambient temperature. These values are continuously measured and output to the input receiver of the controller . The input receiver receives these values and communicates these values to the fueling speed controller . The fueling speed controller then continuously calculates the mass average enthalpy h the total time to complete the hydrogen fill t the pressure ramp rate RR and the fueling speed in manner discussed above. The fueling speed controller then controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen to the vehicle tank at the determined fueling speed. This process is continuously iteratively or non iteratively performed e.g. at each of a plurality of time steps during the hydrogen fill such that the fueling speed is actively adjusted during the hydrogen fill.

By the above described active fueling speed control the fueling speed may be determined to optimize the hydrogen fill so as to for example reduce the time required for the hydrogen fill to complete while adhering to the relevant safety parameters i.e. while keeping the hydrogen temperature below 85 C. . To this point the estimation of the mass average enthalpy prior to the hydrogen fill as in the above described MC method relies on the hydrogen station dispenser estimating its pre cooling capability. However the pre cooling capability may be highly variable and therefore may require a conservative estimation of mass average enthalpy leading to an overly conservative determination of fueling speed. The active fueling speed control of the modified MC Method has removed the need to estimate the pre cooling capability and therefore may determine a better fueling speed value than that obtained otherwise. Additionally the active fueling speed control may provide a more accurate determination of the mass average enthalpy which allows for further optimization of the fueling speed.

According to another aspect the MC Method and the modified MC Method may be further modified in accordance with a second modified MC Method shown in . Turning to the second modified MC method uses a different MC equation when compared to the MC equations of the MC Method and the modified MC method. The MC equation of the second modified MC Method accurately derives MC parameters in view of dispenser and vehicle component heat transfer. Particularly the filling station may include several components that may transfer heat to the gas delivered to tank . For example with reference to the following components of the dispenser may transfer heat to the gas a breakaway the hose the nozzle . Additionally the following components of a vehicle tank system may transfer heat to the gas the vehicle input receptacle tank system tubing one or more valves and manifolds when present for multi tank systems . The one or more valves of the vehicle tank system may include but are not limited to a check valve. Therefore to account for component heat transfer directly in the MC equation equation 11 may be modified as shown below in equation 19 

By using equation 19 the error between actual MC and the result of the MC equation may be reduced to 4.5 . Further equation 19 achieves an RMS error of 0.39 and an R squared of 0.997. An exemplary graphic depiction of MC calculated in accordance with equation 19 of the second modified MC method is shown in .

Turning to another difference between the second modified MC Method and the other MC methods discussed above is that the estimated end of fill mass average enthalpy MAE in the second modified MC method is calculated from the mass average pre cooling temperature MAT and total fill time t using an enthalpy map equation. With more specific reference to the calculation of the estimated end of fill mass average enthalpy based on the mass average pre cooling temperature and the total fill time the enthalpy map equation used to derive the mass average enthalpy map plotted in is shown below as equation 20 

The fit of equation 20 to the observed data has been observed to be excellent. By using equation 20 the average error between the actual end of fill mass average enthalpy and the result of the estimated end of fill mass average enthalpy equation may be reduced to 0.009 . Further equation 20 achieves an RMS error of 0.385 and an R squared of 0.99997. Therefore while estimating the mass average enthalpy during a fill may be difficult the enthalpy map equation 20 is an accurate way to estimate end of fill mass average enthalpy.

The above equations 19 and 20 are applied in the second modified MC Method to control fill of a fuel tank at a hydrogen dispenser.

Further another difference between the second modified MC Method and the other MC methods discussed above is that the pressure ramp rate in the second modified MC Method is calculated based on mass average pre cooling temperature as is shown in .

Generally according to the second modified MC Method for the first 30 seconds of the fill the filling station uses an expected mass average pre cooling temperature which is based on what the mass average pre cooling temperature is expected to be at the end of the full fill of tank . The expected mass average pre cooling temperature MAT is set by the manufacturer at the factory. After 30 seconds have elapsed from the start of the fill the mass average pre cooling temperature used by the filling station is based on average calculations of the mass average pre cooling temperature starting from different time periods in the fill. A first average mass average pre cooling temperature calculation T is based on an average of the mass average pre cooling temperature calculations starting at the beginning of the fill from t 0 . A second average mass average pre cooling temperature calculation T is based on an average of the mass average pre cooling temperature calculations starting at the beginning 30 seconds into the fill from t 30 .

Once 30 seconds has lapsed since the beginning of the fill the filling station uses the Tvalue as the mass average pre cooling temperature when the pressure of the gas measured at the nozzle of the dispenser is less than or equal to 50 MPa. The dispenser uses a weighted average of the Tand the T when the pressure of the gas measured at the nozzle of the dispenser is greater than 50 MPa. The weighting placed on the Tand the Tchanges with rising pressure in tank such that at a highest allowed dispenser pressure the weighting is 100 on T. This relationship is shown in the graph of . The overall operation of the RR control and pressure ending control of the fill control in accordance with the second modified MC Method is illustrated in the flow chart of . provide additional details regarding the steps of . define constants and variables used in the equations of the second modified MC Method.

Turning to the second modified MC Method which continuously loops begins by setting i equal to 1 at where i is a time step counter. Following step values for the P T and Tvariables are measured in step . With reference to Pis the pressure of the gas measured by pressure sensor at the nozzle of dispenser for the current time step i . Tis the temperature of the gas measured by temperature sensor at the nozzle of dispenser for the current time step i . Tis the ambient temperature of the air around dispenser measured by ambient temperature sensor of filling station . Further in step of Pis set equal to P and tis set. tis the length of time that has elapsed since the filling of tank with gas commenced. In this embodiment since gas is first delivered to the tank in the next step the fill is deemed to commence at step . Therefore tfor time step 1 t will have a value of 0. Along the same lines Pis the initial measured pressure of the gas in tank before the fill commences. Accordingly since the fill of tank has yet to commence for the first time step in step Pis set equal to the pressure Pmeasured for the first time step P.

Therefore Pis the pressure measured by pressure sensor at the nozzle of the dispenser before the fill commences. Further it is noted that Pis also equal to the pressure of the gas in tank before the fill commences because a pressure drop is not present between the nozzle of the dispenser and tank before the fill commences. However a pressure drop is present between the nozzle of the dispenser and tank when gas flows from dispenser into tank after the fill commences. Therefore when gas is flowing from dispenser into tank a measurement of gas pressure taken at the nozzle of the dispenser will be higher than a measurement of gas pressure taken in tank .

In step the filling of tank with gas commences. Following step the cold tank initial conditions are calculated and set in step . The term cold tank is defined in SAE J2601. A cold tank is a boundary tank type 3 vessel having a carbon fiber overwrap and an aluminum liner where the tank temperature is colder than ambient before the fill commences. The aluminum liner in the cold tank increases the heat dissipation capability of the tank during the fill when compared to the type 4 hot tank discussed below.

The cold tank initial conditions set in step are the worst case conditions for overfilling a tank with gas and are used in the pressure ending control steps described below. The cold tank initial condition calculations are shown in which is discussed in more detail below.

Turning to the detailed steps carried out while setting the cold tank initial conditions of step are shown. The cold tank initial conditions are set by first calculating an Min step using M P 0.3091657 12.21372 where Mis a temporary variable used for the calculation of T. Tis the initial assumed temperature of the gas in tank before the fill commences. Next in step C a temporary variable used for the calculation of Tis calculated using the equation 0.8921259 6.7441550115 06 0.3095305 43.452377 . Following step the Cand Mvalues are compared in step . The method progresses to step when Cis greater than M. Otherwise the method progresses to step when Cis not greater than M.

In step Tis set equal to C. Further Tis set equal to Min step . The method progresses to step following either of steps or . In step Tis examined to see if it is less than 233.15K. If Tis less than 233.15K the method progresses to step where Tis set equal to 233.15K and then progresses to step . If Tis not less than 233.15K in step the method proceeds to step .

In step values used in the ending pressure control steps are set. More specifically a minimum fill time is set t the volume of tank is set V the maximum pressure in tank P is set the MC density limit is set the MC non communication density limit is set the communication density limit is set and the final mass of the tank at 100 SOC m is set based on a 1 kg tank at reference conditions. Vis the volume of gas in a full 1 kg tank at reference conditions. Pis determined using the enthalpy map equation 20 such that hydrogen station provides a full fill to tank most of the time while achieving a fast fill of tank all of the time. The and limits are set using the enthalpy map equation 20 . The value is typically set to end the fill when the tank reaches 98 SOC. The value may be set by the manufacturer of hydrogen station by setting the communication density limit density value at 98 SOC to account for sensor errors during the fill. The value is typically set to end the fill when the tank reaches 115 SOC. The value may be set by the manufacturer of hydrogen station by setting the MC density limit value at 115 SOC based on a maximum tank pressure of 97.3 MPa and maximum tank temperature of 50 C. The value is typically set to end the fill when the tank reaches 100 SOC. The value may be set by the manufacturer of hydrogen station .

100 SOC is defined as the density of the gas in the tank at normal working pressure NWP at 15 C. The values set in step are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different values than those listed in step in order to prevent the gas in tank from exceeding 85 C. in accordance with SAE J2601.

Further in step additional values used in the ending pressure control steps are set. More specifically the initial calculated density of the gas in the cold tank before fill commences is set according to the equation f P T . Further the initial mass present in the cold tank before the fill commences m is set according to the equation m V . Additionally the mass to be added to the cold tank during the fill to achieve 100 SOC m is set according to the equation m m m. Also the internal specific energy of the gas in the cold tank before the fill commences u is set according to the equation u f T P . Lastly the internal energy of the gas in the cold tank before the fill commences U is set according to the equation U U m. The values set in step are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different values than those listed in step in order to prevent the gas in tank from exceeding 85 C. in accordance with SAE J2601.

Following step the MC equation coefficients are set in step for the MC equation 27 used in the ending pressure control steps and . These MC equation coefficients were obtained using simulation results of a 1 kg type 3 tank but could also be have been obtained using test result data. The MC equation coefficients of step are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different MC equation coefficients than those listed in step .

Turning back to following step the hot tank initial conditions are calculated and set in step . The term hot tank is defined in SAE J2601. A hot tank is a boundary tank type 4 vessel having a carbon fiber overwrap and a plastic liner material where the tank temperature is hotter than ambient before the fill commences. The plastic liner in the hot tank reduces the heat dissipation capability of the tank during the fill when compared to the type 3 cold tank discussed above.

Hot tank initial conditions set in step are the worst case conditions for overheating the gas in tank are used in the RR control steps discussed below. The hot tank initial condition calculations are shown in which are discussed below.

Turning to the detailed steps carried out while setting the hot tank initial conditions of step are shown. First an initial assumed temperature of the gas in tank before the fill commences T is set in steps based on T. More specifically in step if Tis less than or equal to 273.15K Tis set to 288.15K in step . Otherwise the method progresses from step to step . In step if Tis both greater than 273.15K and less than or equal to 283.15K the method moves to step otherwise the method moves to step . In step Tis set according to the equation T T 15K.

In step if Tis both greater than 283.15K and less than or equal to 293.15K the method moves to step otherwise the method moves to step . In step Tis set according to the equation T 0.5 T 156.575K. In step if Tis both greater than 293.15K and less than or equal to 308.15K the method moves to step otherwise the method moves to step . In step Tis set according to the equation T 0.668 T 107.315K. In step Tis set to 313.15K. The method progresses to step following any of steps and .

The expected end of fill mass average pre cooling temperature MAT is set in step . The value of MATis set as close to the actual mass average pre cooling temperature for the gas in tank as possible. The value of MATmay be set by the manufacturer of the hydrogen station at the factory based on the expected behavior and characteristics of the pre cooling system employed. MATneed not be a constant value but can be a function of conditions.

A tank size TS is set in steps based on MATand T. More specifically in step if Tis greater than 315.65K the method progresses to step where TS is set to 4 kg. Otherwise the method progresses from step to step .

In step if Tis both greater than 310.65K and less than or equal to 315.65K the method progresses to step . Otherwise the method progresses from step to step . Further the method progresses from step to step when the MATis less than 250.65 otherwise the method progresses from step to step . TS is set to 4 kg in step and TS is set to 7 kg in step .

In step if Tis both greater than 288.15K and less than or equal to 310.65K the method progresses to step . Otherwise the method progresses from step to step . Further the method progresses from step to step when the MATis less than 245.65 otherwise the method progresses from step to step . TS is set to 4 kg in step and TS is set to 7 kg in step .

In step if Tis both greater than 278.15K and less than or equal to 288.15K the method progresses to step . Otherwise the method progresses from step to step . Further the method progresses from step to step when the MATis less than 240.65 otherwise the method progresses from step to step . TS is set to 4 kg in step and TS is set to 7 kg in step .

In step if Tis both greater than 268.15K and less than or equal to 278.15K the method progresses to step . Otherwise the method progresses from step to step . Further the method progresses from step to step when the MATis less than 235.65 otherwise the method progresses from step to step . TS is set to 4 kg in step and TS is set to 7 kg in steps and . The method progresses to step following any of steps and .

In step a value is set for the minimum tank pressure Pand the initial calculated density of the gas in the hot tank before the fill commences as a function of Pand Taccording to the equation P T . The value for Pis set based on a worst case starting pressure for a fill of tank in hot tank conditions. Following step the values and coefficients used in the MC equation 25 of step are set based on the TS value in steps . More specifically if TS equals 4 tank size of 4 kg in step the values and coefficients used in the MC equation 25 of step are set in accordance with steps and otherwise the tank is deemed to have a size of 7 kg TS 7 values and coefficients used in the MC equation 25 of step are set in accordance with steps and . The MC equation values and coefficients of steps and are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different MC equation values and coefficients than those listed in steps and .

In step the method progresses to step when TS equals 4 where values used in the MC equation 25 of step are set. The values set in step are the volume of the hot tank V the final hot mass in the hot tank at 100 SOC m the initial calculated mass in the hot tank before the fill commences m the calculated mass to be added to the hot tank during the fill to achieve 100 SOC m . Vand mare set based on tank in hot tank conditions. After step coefficients for the MC equation 25 of step are set in accordance with step and then the method progresses to step .

In step the method progresses to step when TS does not equal 4 where values used in the MC equation 25 of step are set. The values set in step are the volume of the hot tank V m m and m. Vand mare set based on tank in hot tank conditions. After step coefficients for the MC equation 25 of step are set in step and then the method progresses to step . The MC equation coefficients of steps and were obtained using hot tank simulation result data. The MC equation values and coefficients of steps and are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different MC equation values and coefficients than those listed in steps and .

In step coefficients for the enthalpy map equation 24 of step are set. The enthalpy map equation coefficients were obtained using hot tank simulation result data. Once the coefficients for the enthalpy map equation 24 are set in step the method progresses to step where the minimum pressure ramp rate for all time steps RR the target temperature for end of fill T the ending fill pressure P the minimum fill time t the initial specific internal energy of the gas in the tank before fill commencement u and the initial internal energy of the gas in the tank before fill commences Uare also set. The Tvalue is set based on a max temperature of the gas in tank and to account for error in the MC equation 25 . The Pvalue is determined based on the enthalpy map equation 20 such that hydrogen station provides a full fill to tank most of the time while achieving a fast fill of tank all of the time. The Tvalue is determined to prevent the hydrogen station from exceeding a maximum temperature in the hot tank.

The enthalpy map equation coefficients of step are exemplary and not intended to be limiting. Accordingly a person having ordinary skill in the art can choose to use different enthalpy map equation coefficients than those listed in step . Further the values set in step are exemplary and not intended to be limiting. A person having ordinary skill in the art can choose to use different values than those shown in step in order to prevent the gas in tank from exceeding 85 C. during the fill in accordance with SAE J2601.

Turning back to following step step of the RR control and step of the pressure ending control are performed. In step the RR control time step calculations are performed In general the time step calculations commence with calculating which is the adjustment factor used in the estimated end of fill mass average enthalpy equation 20 to account for variability in RR. Generally a is calculated based on a comparison of the ramp rate RR during a current calculation and the RR from an immediately preceding calculation. Then the mass average pre cooling temperature is calculated. The RR control time step calculations are shown in further detail in which is discussed below.

Turning to the detailed steps performed in the time step calculations of step are shown. In steps a value for RRis set and a value for a is set. a is the adjustment factor used in the mass average enthalpy equation 24 of step to account for variability in the RR.

In step if i is greater than 1 the method proceeds to step otherwise the method proceeds to step . In step the method proceeds to step if the calculated RR value in the previous time step RR is less than RR otherwise the method proceeds to step . In step RRis set equal to RR. In step the method proceeds to step if RRis greater than RR otherwise the method proceeds to step . In step a value for is set according to the equation 0.5 RR RR . is a temporary variable used for the calculation of . After step the method progresses to step where the method progresses to step when otherwise the method progresses to step . It is noted that the value of is the value of a from the last time step.

In step is set equal to and the method progresses to step following step . In step is set equal to and the method progresses to step following step .

A value for mass average pre cooling temperature MAT is determined in steps . The equation used to determine the value for mass average pre cooling temperature is based on P the pressure of the gas measured by pressure sensor at the nozzle of the dispenser and t the elapsed time since the beginning of the fill. In step a first average mass average pre cooling temperature calculation T is performed based on an average of the mass average pre cooling temperature calculations since the beginning of the fill since t 0 until the current time t using the equation 21 

After step the method progresses to step . In step the method progresses to step if tis less than or equal to thirty in other words not more than 30 seconds have passed since the beginning of the fill otherwise the method proceeds to step . In step MATis set equal to MAT where MATis the mass average pre cooling temperature for the current time step. In step a second average mass average pre cooling temperature calculation T is performed based on an average of the mass average pre cooling temperature calculations starting since 30 seconds from the beginning of the fill since t 30 until the current time t using the equation 22 

After step the method progresses to step . In step the method progresses to step if the Pis less than or equal to 50 in other words the pressure of the gas at the nozzle of the dispenser is not greater than 50 MPa otherwise the method proceeds to step . The pressure value of 50 MPa in step is exemplary and was empirically selected based on simulation data. Therefore a predetermined pressure value other than 50 MPa may be used in other embodiments of the method in step . In step MATis set equal to MAT. In step the mass average pre cooling temperature is calculated using a weighted average of the Tand the T. The weighting placed on the Tand the Tchanges with rising pressure in tank such that at a highest allowed dispenser pressure the weighting is 100 on the Tmeasured from the beginning of the fill. The mass average pre cooling temperature is calculated with the weighted average of the Tand the Tusing the equation 23 

Turning back to following step iterative calculations are performed in step in which an estimation for total fill time for the current time step t an estimated mass average enthalpy at the end of the fill h in accordance with equation 20 and the MC for the hot tank MC are iteratively calculated. The iterative calculations stop once MCconverges with MC. MCis the MC required to achieve the target final gas temperature Tbased on initial conditions and the enthalpy put in the tank . Once MCconverges with MC generally the total fill time for the current time step t is set equal to t. The iterative calculations are shown in further detail in which are discussed below.

Turning to the detailed steps carried out while performing the iterative calculations in step are shown. First an iteration counter variable j is set to 1 in step . In steps tis set. More specifically if i is equal to 1 in step then the method progresses to step . However if i is not equal to 1 in step the method progresses to step . In step tis set to 172 seconds. In step tis set to t where tis tfrom the previous time step. The method progresses to step following steps or . In step the estimated end of fill mass average enthalpy h is calculated using the following Enthalpy Map equation 24 

k l m n p q r s v y z are constants from step which were obtained by fitting the enthalpy map equation 24 to hot tank simulation result data.

After step the specific adiabatic internal energy of the gas in the hot tank U is calculated in step using the equation

AC BC DC EC FC GC HC KC LC NC are constants from steps or which were obtained by fitting the MC equation 25 to hot tank simulation result data.

It is noted that the general term t of equation 19 is further specified as tin equation 25 . Further it is noted that constant designations AC BC DC EC FC GC HC KC LC and NC in equation 25 are used in place of constant designations a b c d e f g h i and j from equation 19 .

After step the difference MC between the required MC MC and the actual MC MC is calculated using the equation MC MC MC.

The total time required to fill the tank from 2 MPa to P t is set based on MCand t in steps . More specifically in step the method proceeds to step when MCis less than or equal to zero and tis less than or equal to 172 seconds otherwise the method proceeds to step . In step is set equal to 172 seconds. In step the method proceeds to step if the absolute value of MCis less than 0.01 otherwise the method proceeds to step . In step if j is equal to 1 the method proceeds to step otherwise the method proceeds to step . In step is set equal to the value of tfrom the last iteration t 30 seconds. In step tis set according to the equation

In step the method proceeds to step if tis greater than or equal to 172 seconds otherwise the method proceeds to step . In step tis set equal to t. In step tis set equal to 172 seconds.

Turning back to after a value for tt is determined in step the value for tis used to calculate a pressure ramp rate RR for the current time step RR in step . The RRis set based on the ending fill pressure P the measured pressure of the gas at the dispenser outlet P the elapsed time since the fill commenced t a predetermined minimum tank pressure value associated with the minimum mass average enthalpy P and the value of t. The RRcalculation is shown in further detail in in which in which the pressure ramp rate RR is calculated in step using the following RR equation 26 

Turning back to after the RRis calculated in step the fueling speed controller determines and sets the fueling speed of hydrogen station during step based on the RR. The fueling speed controller adjusts the speed of gas delivered to tank using flow regulator .

Following step i is incremented by 1 in step . After step new measurements for Pand Tare taken tis set to equal the time that has elapsed since the start of the fill and mis calculated. mis the change in mass added to tank during the previous time step as measured by mass flow meter of hydrogen station . mis calculated by multiplying the flow rate of dispenser during the previous time step by the amount of time that elapsed during the previous time step. Following step the method returns to steps and .

In step Pis compared to P where Pis a predetermined maximum gas pressure permitted within tank . If Pis greater than or equal to Pin step the fill of tank is stopped. Otherwise the method proceeds to step which checks to see whether communication has been established between communication receiver of hydrogen station and a tank temperature sensor located within tank . The method proceeds to step when communication is present and proceeds to step when communication is not present.

MC density calculations are carried out within step using the cold tank initial conditions calculated in step . After the MC density is calculated it is compared to a predetermined MC non communication density limit in step . The method proceeds to step where the fill is stopped when the calculated MC density exceeds the MC non communication density limit in step . Otherwise the method proceeds to step after step . In step the fill is continued for the remainder of the current time step until new P T m and tvalues are calculated for the next time step in step at which time the pressure ending control steps return to step . This allows the RR control steps and pressure ending control steps to use the same time step increments i . The details of pressure ending control steps which are carried out when communication has not been established between tank temperature sensor and hydrogen station are shown in further detail in .

Turning to the details are shown for the pressure ending control steps that are used when communication between the tank temperature sensor and hydrogen station is not present. The pressure ending control steps of determine if the filling of tank with gas should end based on the MC density of the gas in tank . First the mass average enthalpy of the gas in tank is calculated in steps . In step the enthalpy of the gas h in tank is calculated as a function of Pand T using the equation h f P T and then the method proceeds to step . In step the method proceeds to step if i is equal to 1 otherwise the method proceeds to step . In step the mass average enthalpy h is set equal to h. In step his calculated using the equation

Following steps and values used for the MC equation 27 of step and the equation 28 for the temperature of the gas in the cold tank T of step are calculated in steps . First the method proceeds to step where the adiabatic internal energy of the gas in the cold tank is calculated using the equation U U mh. Following step the method proceeds to step where the specific adiabatic internal energy of the gas in the cold tank u is calculated using the equation

Following step the specific heat capacity of the gas at constant volume Cv is calculated as a function of Pand Tfor the cold tank using the equation Cv f P T Following step the method progresses through step to step if tis greater than t otherwise the method progresses to step . In step the current fill time beyond t t is set using the equation t t t. In step tis set to 0 seconds. The method progresses to step following step or .

The MC density of the gas in tank is calculated in steps . First in step the MC for the cold tank MC is calculated using the following equation 27 

AC BC GC KC JC are constants from step which were obtained by fitting MC equation 27 to simulation results of a 1 kg type 3 tank but could also have been obtained by fitting MC equation 27 to test result data.

Following step the temperature of the gas in the cold tank T is calculated in step using the equation 28 

Following step is calculated in step as a function of Pand Tusing the equation f P T . Following step the method proceeds to step where the is compared to the MC non communication density limit . The method progresses to step when the is greater than or equal to the P otherwise the method progresses to step . In step the fill is stopped. In step the fill is continued for the remainder of the current time step until new P T m and tvalues are calculated for the next time step in step at which time the pressure ending control steps return to step . This allows the RR control steps and pressure ending control steps to use the same time step increments i .

Turning back to if communication has been established between communication receiver of dispenser of hydrogen station and a tank temperature sensor located within tank in step MC density calculations and communication density calculations are carried out within step using the cold tank initial conditions calculated in step . After the MC density and communication density are calculated they are compared to a predetermined MC density limit and communication density limit in step . The method proceeds to step where the fill is stopped when the calculated MC density or calculated communication density exceeds the corresponding MC density limit or communication density limit in step . Otherwise after step the method proceeds to step where the fill is continued for the remainder of the current time step until new P T m and tvalues are calculated for the next time step in step at which time the pressure ending control steps return to step . This allows the RR control steps and pressure ending control steps to use the same time step increments i . The details of pressure ending control steps and which are carried out when communication has been established between tank temperature sensor and hydrogen station are shown in further detail in .

Turning to the actions that take place within steps of are the same actions that take place within steps of . Therefore steps of will not be discussed for the sake of brevity. has additional steps beyond those of namely steps . In step the is compared to the MC density limit and the method progresses to step when the is greater than or equal to the otherwise the method progresses to step . In step the fill is stopped.

In step the temperature of the gas in tank is measured using the tank temperature sensor in tank T . Tis received by filling station through communication receiver . The input receiver of the controller of the hydrogen station communicates with and continuously receives measurement values as inputs from the tank temperature sensor T through the communication receiver . The input receiver continuously communicates the measurement of tank temperature sensor T to the fueling speed controller . In one embodiment the communications receiver and tank temperature sensor communicate using the IRDA protocol. However it is contemplated that a different communications protocol could be used in other embodiments.

Once the Tmeasurement is obtained in step the method progresses to step where the communication density of the gas in the tank is calculated as a function of Pand Tusing the equation f P T . Following step the method proceeds to step where the is compared to the communication density limit . The method progresses to step when is greater than otherwise the method progresses to step . In step the fill is stopped. In step the fill is continued for the remainder of the current time step until new P T m and tvalues are calculated for the next time step in step at which time the pressure ending control steps return to step . This allows the RR control steps and pressure ending control steps to use the same time step increments i .

The main difference between the methods shown in and is that the decision to stop the fill in is based solely on the but the method in considers both of the and the when deciding whether to stop the fill of tank .

According to another aspect the modified MC Method may be further modified second modified MC Method to employ active dynamic fueling speed control in which the hydrogen station or dispenser continuously calculates the mass average pre cooling temperature MAT and uses the continuously calculated mass average pre cooling temperature to adjust the fueling speed. More particularly the second modified MC Method adjusts the fueling speed based on a pressure ramp rate RR calculated using the mass average pre cooling temperature such that the gas temperature inside the tank does not exceed a target temperature i.e. the 85 C. safety limit established in SAE J2601. The mass average pre cooling temperature is calculated based on the time elapsed since the beginning of the fill of tank and pressure of the gas measured at the nozzle of the dispenser P . Like the modified MC method described above the estimated end of fill mass average enthalpy MAE is still used but only to calculate the MC equation in the second modified MC method. Further the estimated end of fill mass average enthalpy in the second modified MC method is derived from the mass average pre cooling temperature and estimated total fill time t using the enthalpy map equation 24 . The total fill time t is determined based on the MC equation 25 that is calculated using the estimated end of fill mass average enthalpy.

Further like the above described modified MC Method the second modified MC Method uses active fueling speed control controls. However whereas the above described modified MC method active fueling speed control continuously calculates the mass average enthalpy of the dispensed hydrogen based on real time measured conditions during the hydrogen fill the second modified MC method active fueling speed control continuously calculates the mass average pre cooling temperature. The fueling speed is then adjusted during the hydrogen fill based on the RR which is continuously determined based on the continuously calculated values of the mass average pre cooling temperature.

Mass average pre cooling temperature can be determined using the time elapsed since the beginning of the fill and the pressure in tank . Generally when more than 30 seconds have elapsed since the beginning of the fill and the pressure in tank is greater than 50 MPa the mass average pre cooling temperature is calculated based on a P P T and T using mass average pre cooling temperature map equation 23 . Equation 23 uses a weighted average of Tand Tthat changes with rising pressure in tank such that at a highest allowed dispenser pressure the weighting is 100 on the Tmeasured from the beginning of the fill. If more than 30 second has elapsed since the beginning of the fill but the pressure within tank has not reached 50 MPa the mass average pre cooling temperature is set equal to T. If more than 30 second has not elapsed since the beginning of the fill the mass average pre cooling temperature is set equal to MAT.

RR can be determined by P P fill time t P and t using equation 25 . As detailed above by continuously calculating the mass average pre cooling temperature and using the continuously calculated mass average pre cooling temperature to continuously calculate the RR the fueling speed can be actively determined and adjusted during the hydrogen fill to optimize the hydrogen fill.

Returning to the flowcharts of a method of filling a compressed gas tank includes determining a fill time t predicted to produce a gas final temperature T determining a final pressure P calculated to produce a state of charge of 100 within the compressed gas tank and delivering gas to the compressed gas tank at a pressure ramp rate RR using equation 26 that achieves the final pressure Pat a conclusion of the fill time t in tank .

The method further includes calculating a mass average pre cooling temperature of the gas MAT calculating an estimated end of fill mass average enthalpy of the gas dispensed to the tank based on at least the mass average pre cooling temperature using equation 24 or 20 and calculating the fill time t based on the estimated end of fill mass average enthalpy.

The mass average pre cooling temperature of the gas MAT is determined by setting the mass average pre cooling temperature MAT to equal a predetermined expected mass average pre cooling temperature MAT when less than a predetermined amount of time has elapsed since a beginning of the fill e.g. 30 seconds . Further the mass average pre cooling temperature MAT is set equal to a mass average pre cooling temperature iteratively calculated from the predetermined time following the beginning of the fill until the current time T when a predetermined amount of time has elapsed since the beginning of the fill and a pressure of the gas measured at the nozzle of the dispenser is less than a predetermined pressure e.g. 50 MPa . Further when a predetermined amount of time has elapsed since the beginning of the fill and the pressure of the gas measured at the nozzle of the dispenser is greater than or equal to the predetermined pressure e.g. 50 MPa the mass average pre cooling temperature MAT is calculated using equation 23 . Equation 23 calculates the mass average pre cooling temperature MAT using a transitional weighted average of a mass average pre cooling temperature iteratively calculated since the beginning of the fill until the current time T and the mass average pre cooling temperature iteratively calculated from the predetermined time following the beginning of the fill until the current time T .

In equation 25 a weighting factor on the mass average pre cooling temperature iteratively calculated since the beginning of the fill until the current time T is increased and a weighting factor on the weight on the mass average pre cooling temperature calculated from the predetermined time following the beginning of the fill until the current time T is decreased as the pressure of the gas at the nozzle of the dispenser P increases. An increase in the pressure of the gas at the nozzle of the dispenser P naturally results in an increase in the pressure of the gas in the gas tank .

The estimated end of fill mass average enthalpy is calculated based on at least the mass average pre cooling temperature MAT and an adjustment factor that accounts for variability in the pressure ramp rate RR . In some embodiments the mass average pre cooling temperature of the gas MAT estimated end of fill mass average enthalpy of the gas and the fill time t are continuously calculated. It is noted that fill time t of equation 20 has been further specified as tin equation 24 . However the equations 20 and 24 remain identical since fill time t is set equal to tduring the last iteration of the calculation of the fill time t . Further it is noted that the estimated end of fill mass average enthalpy of the gas is represented by MAE in equation 20 and represented in iteratively calculated equation 24 by h.

More specifically an estimation of the fill time t t is iteratively calculated using equation 24 until the estimation of the fill time t is less than a predetermined value of the estimation of the fill time t and an absolute value of MC difference MC is less than a predetermined value of MC difference MC . The predetermined value of MC difference MC is the difference between a required MC MC for the tank in hot soak conditions and an actual MC MC calculated for the tank in hot soak conditions. The actual MC MC is calculated using equations 19 or 25 which slightly differ only in nomenclature and therefore produce the same result. More specifically the general term t for a final fill time beyond a minimum fill time used in equation 19 is further specified as the term tin equation 25 which represents a final fill time beyond a minimum fill time for the current iteration.

The method further includes stopping the delivery of gas to the gas tank when a communication density of gas in the gas tank is greater than a communication density limit . The delivery of gas to the gas tank is also stopped when an MC density of gas in the gas tank is greater than an MC density of gas limit . The delivery of gas to the gas tank is also stopped when the MC density of hydrogen gas in the gas tank is greater than an MC non communication density of gas limit . The delivery of gas to the gas tank is also stopped when a current pressure of gas P at the nozzle of the dispenser P is greater than or equal to a gas tank pressure limit P .

With reference to to continuously determine the mass average pre cooling temperature a hydrogen filling station is provided with a temperature sensor a pressure sensor a mass flow meter an optional communication receiver a hydrogen flow regulator and an ambient temperature sensor all of which communicate with a hydrogen station controller controller . The hydrogen station also includes a dispenser which includes a base and a hose . The hose is connected to and extends from the base and includes a nozzle at a distal end thereof. In some embodiments a breakaway is located between the base and the nozzle along the hose . The nozzle is configured to couple with a vehicle input receptacle which communicates with a vehicle gas tank . Hydrogen gas is communicated from a source through the base and hose to the vehicle gas tank during fueling. In some embodiments tank has a tank temperature sensor which makes direct measurements of the temperature of the gas in tank and provides these temperatures to controller of hydrogen station through communication receiver and input receiver . Tank temperature sensor and hydrogen station can communicate using a variety of protocols through communication receiver such as but not limited to IRDA.

The temperature sensor pressure sensor mass flow meter communication receiver hydrogen flow regulator ambient temperature sensor and controller are used to control the operation of the hydrogen station . The temperature sensor pressure sensor mass flow meter hydrogen flow regulator and ambient temperature sensor are generally known devices and will therefore not be described in detail herein. The controller may include one or more arithmetic processors computers or any other devices capable of receiving all of the herein described measurement inputs performing all of the herein described calculations and controlling the dispenser to dispense hydrogen to the vehicle gas tank as described herein.

To this end the controller may include an input receiver and a fueling speed controller . The input receiver communicates with and continuously receives measurement values as inputs from the temperature sensor pressure sensor mass flow meter optional communication receiver and ambient temperature sensor . The input receiver continuously communicates these inputs to the fueling speed controller . The fueling speed controller calculates the fueling speed in the manner described below and controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen at the calculated fueling speed. More specifically the fueling speed controller continuously receives the inputs from the input receiver performs calculations to continuously calculate the mass average pre cooling temperature estimated end of fill mass average enthalpy pressure rate ramp and fueling speed and continuously controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen at the continuously determined fueling speed. It is to be appreciated that the controller may be used to receive inputs and perform calculations related to all of the other calculations of the above described MC Method modified MC Method and second modified MC method.

With reference to the hydrogen station in which includes a dispenser having a base and a hose the inputs to Equation 26 and the above algorithm are provided by the temperature sensor pressure sensor mass flow meter and ambient temperature sensor and optional tank temperature sensor via communication receiver which respectively measure the temperature of the hydrogen gas at nozzle the pressure of the hydrogen gas at nozzle the mass of hydrogen gas dispensed by dispenser the temperature of the hydrogen gas in tank and the ambient temperature at dispenser . These values are continuously measured and output to the input receiver of the controller . The input receiver receives these values and communicates these values to the fueling speed controller . The fueling speed controller then continuously calculates the mass average pre cooling temperature of the hydrogen gas mass average pre cooling temperature estimated end of fill mass average enthalpy the total time to complete the hydrogen fill t . the pressure ramp rate RR and the fueling speed in manner discussed above. The fueling speed controller then controls the hydrogen flow regulator to cause the dispenser to dispense hydrogen to the vehicle tank at the determined fueling speed. This process is continuously iteratively or non iteratively performed e.g. at each of a plurality of time steps during the hydrogen fill such that the fueling speed is actively adjusted during the hydrogen fill.

Also shown in is the vehicle tank system which includes the vehicle input receptacle at least one valve tank system tubing vehicle tank and optional tank temperature sensor .

Further with reference to the hydrogen filling station in some embodiments includes a dispenser for providing hydrogen to a vehicle gas tank and a hydrogen filling station controller . The hydrogen filling station controller includes an input receiver configured to continuously receive measured values of a pressure a temperature and a flow rate of hydrogen dispensed to the gas tank from a temperature sensor a pressure sensor and a mass flow meter provided in the dispenser of the hydrogen gas filling station .

The hydrogen filling station controller also includes a fueling speed controller configured to calculate a mass average pre cooling temperature of the hydrogen gas MAT using mass average pre cooling temperature map equation 23 and calculate an estimated end of fill mass average enthalpy of the gas dispensed to the tank using enthalpy map equations 20 or 24 based on at least the mass average pre cooling temperature MAT while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station . The fueling speed controller is further configured to calculate a fill time t based on the estimated end of fill mass average enthalpy while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station .

The fueling speed controller is also configured to calculate a pressure ramp rate RR using pressure ramp rate equation 25 that achieves a final pressure Pbased on the fill time t while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station . The fueling speed controller is additionally configured to determine a fueling speed based on the pressure ramp rate RR while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station . The fueling speed controller is further configured to control the dispenser of the hydrogen filling station to adjust a fueling speed while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station .

With additional reference to in some embodiments of hydrogen station hydrogen station controller includes an input receiver configured to continuously receive measured values of a pressure a temperature and a flow rate of hydrogen dispensed to the gas tank from a temperature sensor a pressure sensor and a mass flow meter provided in the dispenser of the hydrogen gas filling station .

The hydrogen filling station controller also includes a fueling speed controller configured to calculate a mass average pre cooling temperature of the hydrogen gas MAT using mass average pre cooling temperature map equation 23 and calculate an estimated end of fill mass average enthalpy of the gas dispensed to the tank using enthalpy map equations 20 or 24 based on at least the mass average pre cooling temperature MAT while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station . The fueling speed controller is further configured to calculate a fill time t based on the estimated end of fill mass average enthalpy while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station .

The hydrogen station controller is further configured to set the mass average pre cooling temperature MAT to equal a predetermined expected mass average pre cooling temperature MAT when less than a predetermined amount of time has elapsed since a beginning of the fill e.g. 30 seconds . Further the hydrogen station controller is also configured to set the mass average pre cooling temperature MAT equal to a mass average pre cooling temperature iteratively calculated from the predetermined time following the beginning of the fill until the current time T when a predetermined amount of time has elapsed since the beginning of the fill and a pressure of the gas measured at the nozzle of the dispenser is less than a predetermined pressure e.g. 50 MPa . Further the hydrogen station controller is additionally configured to set the mass average pre cooling temperature MAT using equation 23 when a predetermined amount of time has elapsed since the beginning of the fill and a pressure of gas P measured at the nozzle of the dispenser is greater than or equal to the predetermined pressure e.g. 50 MPa . Equation 23 calculates the mass average pre cooling temperature MAT using a transitional weighted average of a mass average pre cooling temperature iteratively calculated since the beginning of the fill until the current time T and the mass average pre cooling temperature iteratively calculated from the predetermined time following the beginning of the fill until the current time T .

In equation 25 a weighting factor on the mass average pre cooling temperature iteratively calculated since the beginning of the fill until the current time T is increased and a weighting factor on the weight on the mass average pre cooling temperature calculated from the predetermined time following the beginning of the fill until the current time T is decreased as the pressure of the gas at the nozzle of the dispenser P increases. An increase in the pressure of the gas at the nozzle of the dispenser P naturally results in an increase in the pressure of the gas in the gas tank .

The hydrogen station controller is further configured to calculate the estimated end of fill mass average enthalpy based on at least the mass average pre cooling temperature MAT and an adjustment factor that accounts for variability in the pressure ramp rate RR . In some embodiments hydrogen station controller is configured to continuously calculate the mass average pre cooling temperature of the gas MAT estimated end of fill mass average enthalpy of the gas and the fill time t .

More specifically hydrogen station controller is configured to calculate an estimation of the fill time for the current time step t iteratively using equation 24 until the estimation of the fill time t is less than a predetermined value of the estimation of the fill time t and an absolute value of MC difference MC is less than a predetermined value of MC difference MC . The predetermined value of MC difference MC is the difference between a required MC MC for the tank in hot soak conditions and an actual MC MC calculated for the tank in hot soak conditions. The actual MC MC is calculated using MC equations 19 or 25 .

The hydrogen station controller is further configured to stop the delivery of gas to the gas tank when a communication density of gas in the gas tank is greater than a communication density limit . The hydrogen station controller is additionally configured to stop the delivery of gas to the gas tank when an MC density of gas in the gas tank is greater than an MC density of gas limit . The hydrogen station controller is further configured to stop the delivery of gas to the gas tank when the MC density of hydrogen gas in the gas tank is greater than an MC non communication density of gas limit . The hydrogen station controller is also configured to stop the delivery of gas to the gas tank when a current pressure of gas P measured at the nozzle of the dispenser is greater than or equal to a gas tank pressure limit P .

By the above described active fueling speed control the fueling speed may be determined to optimize the hydrogen fill so as to for example reduce the time required for the hydrogen fill to complete while adhering to the relevant safety parameters i.e. while keeping the hydrogen temperature below 85 C. . To this point the mass average pre cooling temperature as in the above described second modified MC method may determine a better fueling speed value than that obtained otherwise.

Although the MC Method modified MC method and second modified MC method were developed and have been described with an emphasis on filling vehicle hydrogen tanks at hydrogen filling stations modification of the MC Method modified MC method and second modified MC method to improve their performance in connection with fueling hydrogen busses or fueling systems with cryogenic gasses or liquids is certainly contemplated. Similarly it is anticipated that the MC Method modified MC method and second modified MC method could readily be adapted for use in conjunction with compressed natural gas vehicle fueling or fast filling of vessels involving any industrial gas and or for calculating the resulting temperature of any process in which a pressurized gas is injected into a pressure vessel. The applicability of the MC Method modified MC method and second modified MC method and the associated constants reflecting the thermodynamic properties and behavior for other processes can be determined by applying a similar test matrix as set out above in connection with compressed hydrogen tank refueling for automobiles.

The modified MC Method as detailed infra provides a new tank filling model based on the total heat capacity of the hydrogen fueling system and an advanced algorithm based on that model for improving the performance of hydrogen filling stations under a broad range of operating conditions. This algorithm as applied stepwise in the second modified MC Method can be used to enhance fueling performance pursuant to SAE J2601 through the use of additional thermodynamic information about the tank system. The modified MC Method works at a tank system Normal Working Pressure NWP and with a compressed hydrogen tank system. Utilizing the modified MC Method permits hydrogen filling stations to improve their fill speed and fill quality SOC while enabling lower cost hydrogen stations to meet those needs.

The method includes determining a fill time t predicted to produce a gas final temperature T at a final pressure P . The method further includes delivering gas to the compressed gas tank at a pressure ramp rate RR that achieves the final pressure P at a conclusion of the fill time t . The gas is delivered to the compressed gas tank using a dispenser.

According to another aspect a controller configured to control a hydrogen filling station is provided. The controller includes an input receiver and a fueling speed controller. The input receiver is configured to continuously receive measured values of a pressure a temperature and a flow rate of hydrogen dispensed to a gas tank from a temperature sensor a pressure sensor and a mass flow meter provided in a dispenser of the hydrogen gas filling station. The fueling speed controller is configured to calculate a mass average pre cooling temperature of the hydrogen gas. The fueling speed controller is further configured to calculate an estimated end of fill mass average enthalpy of the gas dispensed to the tank based on at least the mass average pre cooling temperature while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is additionally configured to calculate a fill time t based on the estimated end of fill mass average enthalpy while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is also configured to calculate a pressure ramp rate RR that achieves a final pressure P based on the fill time t while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is additionally configured to determine a fueling speed based on the pressure ramp rate RR while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. Further the fueling speed controller is configured to control the dispenser of the hydrogen filling station to adjust a fueling speed while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station.

According to yet another aspect a hydrogen filling station is provided. The hydrogen filling station includes a dispenser for providing hydrogen to a vehicle gas tank and a hydrogen station controller. The hydrogen station controller includes an input receiver and a fueling speed controller. The input receiver is configured to continuously receive measured values of a pressure a temperature and a flow rate of hydrogen dispensed to the gas tank from a temperature sensor a pressure sensor and a mass flow meter provided in the dispenser of the hydrogen gas filling station. The fueling speed controller is configured to calculate a mass average pre cooling temperature of the hydrogen gas. The fueling speed controller is further configured to calculate an estimated end of fill mass average enthalpy of the gas dispensed to the tank based on at least the mass average pre cooling temperature while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is additionally configured to calculate a fill time t based on the estimated end of fill mass average enthalpy while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is also configured to calculate a pressure ramp rate RR that achieves a final pressure P based on the fill time t while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. The fueling speed controller is additionally configured to determine a fueling speed based on the pressure ramp rate RR while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station. Further the fueling speed controller is configured to control the dispenser of the hydrogen filling station to adjust a fueling speed while the hydrogen is being dispensed to the gas tank by the dispenser of the hydrogen filling station.

The MC Method is effectively an analytical method which may be utilized to calculate a final gas temperature in a CHSS by drawing a control volume around the CHSS tank monitoring the enthalpy that goes into the tank calculating the adiabatic internal energy and the adiabatic temperature in the tank and comparing those with the final gas temperature in the tank over a variety of like test fills to characterize that type of tank and calculate MC. The M and the C of a MC lumped heat capacity model or MC model are derived from the concept of mass times specific heat capacity. In other words MC denotes mass times specific heat capacity and represents the heat capacity of the tank. This means that MC represents how much heat was absorbed during a tank fill which may be dependent on elapsed time. Accordingly initial conditions in a tank an end fill and the MC equation may be utilized to calculate end of fill conditions such as a final gas temperature in the tank or ending pressure control calculations. In this way the MC Method may be utilized to determine when to stop a fill of a tank.

In one or more embodiments a system and method for hydrogen fueling based on gas temperature prediction is provided in association with fueling or filling protocols. For example the system and method for hydrogen fueling may be aligned with one or more industry standards such as the SAE J2601 standard. Gas temperature prediction may be based on a thermodynamic solution to calculating an internal Compressed Hydrogen Storage System CHSS gas temperature using real time inputs. In other words a system and method for fueling a CHSS which is essentially a fuel tank or hydrogen tank of a vehicle is provided. In one or more embodiments this gas temperature prediction may be employed as a dynamic control algorithm implemented within a fuel dispenser e.g. hydrogen dispenser . In other words the fuel dispenser may utilize gas temperature prediction to determine an internal CHSS gas temperature for H2 gas or fuel and pump fuel at a corresponding rate. As an example the method for hydrogen fueling based on gas temperature prediction may be implemented as a fueling protocol to promote safety around fueling stations. A lumped heat capacity model may be utilized to provide lumped system analysis to facilitate gas temperature prediction. In other words the CHSS gas reservoir may be viewed as a thermal system with a number of discrete lumps thereby providing a way to approximate complex differential heat equations. Here a lumped heat capacity model may be based on MC a combined heat mass of a control volume denoted in units of kJ K.

Because the method for hydrogen fueling based on gas temperature prediction provides fueling speeds or fueling pressures based on inputs which may fluctuate throughout the course of fueling the fueling speeds or fueling pressures may be dynamically adjusted. In other words the method for hydrogen fueling may be implemented as an adaptive fueling protocol which enables fueling speeds fueling pressures or rates of change associated therewith to be adjusted e.g. on the fly as fuel is being pumped. As an example a flow rate controller may dynamically adjust the rate of change in dispenser pressure or a target pressure at an end of fill time based on one or more sensed inputs such as an ambient temperature an initial gas pressure within the CHSS measured gas pressure at the dispenser measured temperature at the dispenser etc. As a result of this ability to dynamically adjust the rate of change in dispenser pressure or target pressure station types or tolerances may be relaxed.

The MC method as described above characterized a tank with the MC equation such that the MC equation would be based on the tank currently being filled. According to one or more aspects the MC Default Fill uses calculations from the MC equation based on a boundary condition tank which is not the tank currently being filled. In other words the MC Default Fill provides for characterization of one or more worst case scenario tanks and fills a current tank accordingly. The MC Default Fill is an adaptive fueling protocol which dynamically adjusts the rate of change in dispenser pressure and an end of fill target pressure based on inputs measured e.g. measured by the dispenser such as ambient temperature initial gas pressure of a CHSS and measured gas pressure and temperature at the dispenser. Because the MC Default Fill utilizes worst case scenario data for its MC calculations no station types or tolerances on pre cooled gas temperature are generally required e.g. other than having a range between 40 C. and 15 C. .

SAE or predefined boundary conditions may be utilized based on standards predefined tank construction materials tank dimensions carbon fiber thickness liner thickness etc. Further different volume tanks or different tank sizes may be considered. At the boundary conditions such as a hot case scenario e.g. when station components are warmer than a predetermined temperature or a cold case scenario e.g. when station components are colder than a predetermined temperature different assumptions may be made. For example in the hot case scenario it may be assumed that the initial temperature in the tank is significantly greater than the ambient air temperature. As an example among different tanks a type 4 tank with a plastic liner may heat up the most. Conversely in a cold case scenario it may be assumed that the initial temperature in the tank is significantly less than the ambient air temperature. Here among different tanks a type 3 tank with an aluminum liner may heat up the least.

For example in one or more embodiments a cold case 1 kg type 3 aluminum 25 liter tank is a worst case tank so the MC equation is modeled after this worst case tank and MC calculations are performed or determined accordingly. In this way a tank currently being filled or fueled may be fueled based on a worst case tank or worst case scenario and may thus be independent of the actual tank being filled or fueled. Further it would be unnecessary to provide measurements from the tank being filled to the hydrogen fueling station.

The MC Default Fill enables and accounts for varying inputs and otherwise adjusts corresponding fueling based on actual conditions measured by sensors in a dispenser. Generally there are three primary properties which may vary during the fueling process. The sensor on a dispenser may measure these in real time dispenser outlet gas pressure dispenser gas temperature and dispenser outlet mass flow. Dispenser outlet temperature and mass flow are dynamic input parameters for the MC Default Fill Pressure RR control e.g. and of . Dispenser outlet temperature dispenser outlet pressure and mass flow are the dynamic input parameters for the MC Default Fill Ending Pressure Control e.g. and of . Additional input parameters which are static and generally stay fixed throughout a fueling event are ambient temperature CHSS initial gas pressure and the expected dispenser outlet mass average gas temperature at the end of the fill.

The controller may perform one or more calculations such as one or more calculations related to the MC Method the MC equation or the MC Default Fill. Examples of calculations include initializing one or more variables calculating one or more MC coefficients looking up one or more MC coefficients according to one or more lookup tables from the database component calculating alpha mass average dispenser gas temperature for control MATC or mass average precooling temperature t mass average enthalpy MAE density etc. The input receiver may communicates with and receive one or more measurement values as inputs from one or more sensors the sensor component which may include the temperature sensor pressure sensor and ambient temperature sensor or the flow component which may include the mass flow meter . In this way the input receiver may receive inputs utilized for the MC Default Fill MC method MC equation etc.

The sensor component may include one or more sensors such as a pressure sensor a temperature sensor an ambient temperature sensor etc. The pressure sensor may measure a pressure of gas or fuel at a nozzle e.g. of of a dispenser e.g. of on a continual incremental basis or at one or more time steps. The temperature sensor may measure a temperature of gas or fuel at the nozzle of the dispenser on an incremental basis at one or more time steps. The ambient temperature sensor may measure an ambient temperature of the air around the dispenser of a filling station. In one or more embodiments the sensor component may take measurements at 30 second intervals although other time steps may be utilized in other embodiments.

The decision component may make one or more determinations or determine which lookup table to utilize based on one or more conditions. In one or more embodiments a comparator may be utilized to perform such determinations. For example the decision component may perform a process check or run through a list of one or more stop conditions to determine whether fueling should continue. In this way the decision component may manage fueling of a compressed fuel tank. Examples of stop conditions monitored by the decision component may include overheating of a tank overfilling of a tank etc.

The flow component may measure the current flow rate e.g. change in mass added to tank from previous time step or mass of the fluid traveling past a fixed point per unit time of fuel using mass flow meter and regulate flow using the flow regulator based on the MC Default Fill or one or more of the calculations performed by the controller . The flow regulator may manage dispensing of fuel or hydrogen at a continuously determined fueling speed as calculated by the controller using the MC Default Fill.

The database component may include one or more tables or lookup tables of one or more coefficients or constants associated with the MC Default Fill. For example the database component may include one or more tables such as coefficient tables of such as MC equation coefficients for different volume tanks different pressure conditions different scenarios etc. e.g. 5 MPa 2 kg 4 kg 7 kg 10 kg cold dispenser case .

The communication component may include a communication receiver which may optionally establish a communication link between a hydrogen station and a tank temperature sensor located within tank as seen in for communication enabled fueling. In one or more embodiments the communication receiver and tank temperature sensor of communicate using IRDA protocols.

The components of may be described in greater detail in conjunction with one or more of the following figures such as for example.

If a tank does not fall within one of the CHSS volume categories of fueling may occur at based on a fueling process associated communication between a hydrogen station and a tank temperature sensor for example. Fueling may then terminate at . If a tank falls within one of the CHSS volume categories of filling using the MC Default Fill may occur at and end at .

In one or more embodiments MC Default Fill may be implemented when the mass average dispenser gas temperature is between 40 C. and 15 C. In one or more embodiments a stop condition for fueling under the MC Default Fill includes a scenario where the mass average dispenser gas temperature falls below a lower boundary temperature of 40 C. Conversely the upper boundary temperature of 15 C. may be used as another stop condition measured as TPCor T.

In one or more embodiments the MC Default Fill may be implemented when an initial gas pressure is greater than 0.5 MPa. In other words if the CHSS pressure measured by the dispenser or communicated to the dispenser is less than 0.5 MPa the dispenser may not initiate fueling.

Pmay be set to be 83.5 MPa. In other words a stop condition may include a scenario where P 83.5 MPa. Pmay represent a transition pressure which defines a point in a fill where a transitional weighted average of TPCor T and TPCor T. In one or more embodiments Pmay be a constant which equals 50 MPa although other values may be utilized in other embodiments.

The MC Default Fill may utilize a controller e.g. of to implement two independent control architectures. The first control architecture regulates the pressure ramp rate throughout the fill while the second control architecture regulates the ending pressure control. Each of these control architectures are defined in detail below.

In other embodiments the MC Default Fill may utilize a dispenser gas pressure tolerance e.g. a pressure tolerance area or PTA instead of setting an absolute upper tolerance on the dispenser pressure. PTA may be derived or calculated by taking the worst case pressure path from a lookup table corridor and converting this into an area. The PTA is derived by integrating the difference between the upper corridor boundary pressure and the HPRR pressure over the elapsed time of the fill. The PTA effectively puts a bound on the amount that the enthalpy over the course of the fill can vary from the ideal.

In defining the allowed area for this pressure tolerance a more conservative value for total area may be utilized than for the lookup tables. This area is primarily defined by the P when Pis equal to P. For the lookup tables this P value is 9 MPa. For the MC Default Fill a P of 7 MPa may be used.

The PTA may be calculated continuously during a fill. This sets a limit which should not to be exceeded. Additionally a Pressure Area PA may be calculated continuously during the fill which is defined as the summation of the dispenser pressure minus the control pressure multiplied by the time it spends there. In one or more embodiments a means of integration is used to calculate the PA which is then compared to the PTA. If the PA exceeds the PTA the fill is terminated. This condition may be checked continuously by the decision component as a stop condition in the MC Default Fill Process Check Subroutine of .

At the MC Default Fill is initialized and one or more inputs or initial determinations e.g. and may be sensed detected by the sensor component or initial inputs determined by the controller . For example the ambient temperature sensor may detect the ambient temperature and the pressure sensor may detect the initial CHSS gas pressure . The initial gas pressure within the CHSS may be determined by measuring the pressure at the station. At the beginning of the fill a valve on the station may be opened to allow a certain amount of gas to flow into the CHSS tank to equalize the pressure within the tank. In other words the valve is opened briefly to allow pressure in the line e.g. 70 megapascal or above the nominal working pressure of the tank to be equalized such that high pressure gas flows into the lower pressure tank or vessel which stops flowing when the pressures are equalized. In this way the pressure sensor may determine the initial pressure of the tank.

Additionally the controller may determine an expected end of fill mass average temperature MAT . In other words an expected end of fill mass average precooling temperature may be calculated for a CHSS tank based on a dispenser s capability. As an example a T40 station is defined as a station that is rated to hold the dispenser outlet temperature between 33 C. and 40 C. throughout a fill. Because the MC Default Fill is based on worst case scenario assumptions the upper boundary for the precooling temperature may be utilized as the precooling category or the precooling temperature for the station. In other words the T40 station may be associated with the 33 C. temperature rather than the 40 C. temperature. In any event the expected end of fill MAT may be determined by the controller .

At one or more RR control initial conditions may be calculated by the controller . These initial conditions may represent assumptions or worst case assumptions which go into each case or scenario. For example it may be assumed that the initial temperature in a CHSS tank is hotter than the ambient temperature measured at . In one or more embodiments one or more variables are initialized and one or more coefficients are set or initialized at . In one or more embodiments the periodicity of the calculations may be as frequent as possible based on capabilities of the controller . As described herein a one second time step for control calculations is described. In other words in the equations below the time step is assumed to be 1 second so the value i represents a 1 second interval. In any event the following may be initialized at by the controller 

In one or more embodiments the ambient temperature and the initial CHSS pressure may be measured at via sensor component .

Further at the MC Default Fill may continue based on the initial CHSS pressure and Pmay be set accordingly by the controller and the decision component based on P.

In one or more embodiments at the MC Default Fill may calculate a value for beta using the controller . Beta may be based on P P and P for example.

Further at the MC Default Fill may calculate a value for tusing the controller . This tvalue may be determined using a lookup table such as the lookup table of .

At the expected end of fill mass average dispenser gas temperature and coefficients for the tequation are set by the controller .

Effectively one or more coefficients for a tequation may be set for different volumes of CHSS tanks using a lookup table which corresponds to the appropriate volume among other initialization which occurs at . In one or more embodiments when Pis a threshold value such as 5 Mpa coefficients a b c and d are set to have above and below values such as a b c d a b C and d. These values may be determined by using lookup tables e.g. and taking values from the ambient temperature categories directly above and below T. When a comparison is made between two values variables etc. the comparator of the decision component may be utilized to make such a determination and provide a decision or determination accordingly e.g. such as which table to utilize etc. .

In one or more embodiments at the controller may calculate one or more values for a b c or d based on respective a b c d a b c and dvalues.

At the controller may calculate one or more ending pressure control initial conditions. This may include setting or calculating P T MT CT or one or more MC equation coefficients. The equations below e.g. MT and CT used to calculate Tare derived from a fit to defueling temperature data generated by using the MC Method with the coefficients given in table of . At the MC Default Fill may continue with one or more calculations provided by the controller and the decision component .

In one or more embodiments coefficients for the MC equation may be set based on table of . Further the calculations of such as interim calculations MT and CT may be performed by the controller and the decision component . For the limit density may be set so if a communicated temperature is wrong e.g. in the event of a faulty sensor the limit density may be set to a threshold such as 115 of the maximum density which provides a stop gap to ensure that the fill using MC Default Fill stops before significant overfilling. or the initial density may be calculated based on the initial temperature and the initial pressure.

At the controller may calculate one or more fueling time calculations. This may include calculating alpha the mass average dispenser gas temperature for control MATC or mass average precooling temperature t etc. In one or more embodiments tmay be calculated for one or more different tank sizes or tank volumes such as 2 kg 4 kg 7 kg 10 kg etc. Thus at the MC Default Fill may continue with one or more calculations provided by the controller and the decision component .

Because the fill may vary from a constant pressure ramp rate alpha or a may be calculated. Alpha may be a discount factor which extends a fill time based on non ideal conditions. For example because tis derived from simulations run at a constant pressure ramp rate and constant pressure ramp rate doesn t typically stay constant in the real world the alpha or discount factor may be utilized or calculated by the controller to account for non ideal conditions by adjusting taccordingly. In other words if an actual fill has a variable ramp rate during the fill then tshould be adjusted to compensate for the change in the in the ramp rate. This may be achieved by calculating alpha which will be used to adjust t e.g. multiply alpha by tequation . As an example when the difference between the maximum ramp rate and the minimum ramp rate during a fill is larger then alpha is larger. Conversely when the difference between the maximum ramp rate and the minimum ramp rate during a fill is smaller e.g. approaches zero then alpha is smaller. In this way tmay be extended or compensated for to account for variability in the ramp rate in the real world.

Additionally at the mass average dispenser gas temperature control MATC or calculate mass average precooling temperature is calculated by the controller . TPCis the mass average of the temperature measured from time zero which is the beginning of the fill. TPCis the mass average of the temperature measured from an elapsed time which is 30 seconds into the fill. There are two measurements of MAT which are made during the fill. The first starts at the beginning of the fill from t 0 and labeled MAT . The second starts from 30 seconds into the fill from t 30 and labeled MAT . With reference to the MAT from t 0 MAT is the mass average precooling temperature measured from time zero. is a plot of temperature e.g. y axis versus time e.g. x axis . As seen during the beginning of the fill this is the warmest because the gas hasn t been cooled down yet. However the MAT from t 0 MAT as seen at isn t used entirely as a control input for a fill because of the length of time for the mass average to become stable. Accordingly MATC may be calculated based on elapsed time and pressure. Continuing with it can be seen that from time t 0 to t 30 seconds MATC MAT as seen at . When t 30 s and P30 s and P P MATC transitional weighted average of MATand MAT as seen at . In this way the fill rules for MATC are divided into different time intervals associated with different mass average precooling temperatures.

Explained another way during the first time interval e.g. 30 seconds when the gas is still warm at the dispenser outlet the pump is being primed or there may be a period before the gas gets cold or to temperature. Thus during this first time interval e.g. 30 seconds the expected MAT e.g. what is expected for the actual MAT to be at the end of a full fill based on current conditions is used for MATC. By the end of the first time interval the gas temperature is typically approaching the temperature at which it will be during the fill and thus the MAT e.g. MAT measured from 30 seconds or TPCmay be used for MATC. In this can be seen as the line or curve represented by MAT from t 30 MAT . However because this curve does not represent the warm gas e.g. MAT from t 0 MAT pumped at the beginning of the fill the transitional weighted average may be used.

The transitional weighted average of MATand MATaccounts for both the warm gas at the beginning of the fill and the colder gas which approaches a stable temperature during the fill. In one or more embodiments Pis set to 50 MPa at which point the transitional weighted average of transitions the control input from MATor TPCto MAT as seen at . In this way the transitional weighted average of MATand MATprovides more weight to the mass average temperature from the beginning of the fill as the pressure increases. Explained another way the weighting in this average changes with rising pressure such that at the highest allowed dispenser pressure the weighing is 100 on the MAT measured from 0 seconds MAT. Accordingly by the end of the fill the weighing favors the mass average temperature measured from t 0. Because MATC is calculated in such a piecewise manner the tcalculation is more stable than if merely the expected MAT MAT or MATwere used in an individual manner.

In one or more embodiments the controller may calculate tbased on MATC and alpha. The trepresents the amount of time it would take to fill the tank from a minimum pressure to a maximum pressure allowed in the tank. Further tmay be calculated for different tank sizes volumes or categories. For example when a tank is in the 4 kg to 7 kg category the controller may calculate tfor both the 4 kg and the 7 kg tank categories. This may be done because under certain conditions the 4 kg tank will be worst case and under other conditions the 7 kg tank will be worst case. In other words it is unknown which tank will be the worst case scenario tank ahead of time. Generally at warmer ambient temperatures the 4 kg tank is the worst case tank between 4 kg and 7 kg tanks while at colder ambient temperatures the 7 kg tank is the worst case between the two tanks. However because it is not always known which tank will be the worst case scenario as assumed by the MC Default Fill the controller may calculate tfor a plurality of tank categories. The decision component may utilize the comparator to compare different tvalues for respective tank sizes or tank categories and utilize the most conservative value. In this way the worst case or the largest tvalue may be utilized or selected by the decision component .

In calculating t the controller may utilize an equation based on alpha MATC e.g. mass average precooling temperature and one or more cubic regression coefficients a b c and d. These cubic regression coefficients may be selected from different tables based on tank category or temperature scenario. Examples of cubic regression tables for a variety of tank categories and scenarios may be found in . The cubic regression coefficients of the tables in may be calculated based on simulations which are run at one or more ambient temperatures. In other words tis calculated based on interpolation based on actual ambient temperature which may be represented by coefficients a b c and d of respective cubic regression tables.

In one or more embodiments coefficients a b c and d may be interpolated during initialization e.g. or instead of interpolating t final during each time step.

As an example respective cubic regression tables may provide a set of cubic regression coefficients a b c and d for different sets of ambient temperatures e.g. 30 C. 35 C. 40 C. etc. . However if the measured or actual ambient temperature is 32 C. tis calculated for 30 C. tis calculated for 35 C. and interpolation may be performed by the controller between respective tvalues to calculate a corresponding tfor 32 C. In this way an above and a below set of cubic regression coefficients from one or more cubic regression tables may be used to calculate or interpolate t e.g. effectively by plugging in the cubic regression coefficients into a tequation and calculating accordingly . Regardless in the MC Default Fill these cubic regression coefficients may be used to calculate a worst case scenario tamong a variety of tank sizes tank volumes or tank categories where the worst case scenario tis the largest tvalue among those. Explained yet another the cubic regression coefficient tables of are lookup tables which are used to provide one or more cubic regression coefficients e.g. a b c and d based on tank size volume category initial CHSS pressure ambient temperature and conditions e.g. cold case . Using these cubic regression coefficients multiple tvalues may be calculated and the worst case most conservative or largest value used.

In one or more embodiments tis calculated as a function of the mass average dispenser outlet gas temperature abbreviated as MAT. Although the MAT is measured throughout the fill the MAT which is used to calculate tnot the actual MAT until the very end of the fill. This is because the actual MAT varies during the fill such as at the beginning of the fill or if the dispenser is warm before the fill begins. If the actual measured MAT were utilized the pressure vs. time profile would be very non linear starting out slowly due to the warm gas at the dispenser outlet and then accelerating as the gas gets colder. To overcome this the MAT used for calculating tis called MATC where C denotes control . Rules are utilized which govern the behavior of the MATC during the fueling process as seen in .

Examples of fueling time calculations which may be performed by the controller at including calculating alpha the mass average dispenser gas temperature for control MATC or mass average precooling temperature t etc. are as follows 

At the controller may set the pressure ramp rate or RR and the control pressure which is the current target pressure or pressure that the dispenser is targeting or other pressure which should be utilized for the next time interval or time step. In one or more embodiments pressure area and pressure tolerance area may be calculated. Pressure ramp rate control calculations may be based on a hot CHSS.

In setting the pressure ramp rate the controller may utilize the decision component to determine whether the mass flow of fuel over a time step has exceeded a threshold e.g. a safety threshold . If such a threshold is exceeded a limit on the mass flow may be implemented by capping the ramp rate. For example if the mass flow exceeds the safety threshold the station may be malfunctioning and thus the cap on the ramp rate may be set to slow the fill down.

When a tank is close to being full the controller may set the ramp rate to a top off ramp rate. In other words the controller may reduce the ramp rate towards an end of a fill and thus reduce the pressure drop between the dispenser and the vehicle. As a result of utilizing top off ramp rate close to the end of the fill this ramp rate reduces the flow rate and likewise reduces the pressure drop between the dispenser and the tank thereby improving fill quality. In one or more embodiments when a top off flag 1 the controller sets the ramp rate to the top off ramp rate or RR. Further the controller may check or determine whether a fill is close the end of fill such as within a threshold time window e.g. 10 seconds . In response to determining a fill is close to the end of fill or within the threshold time window of finishing the fill the controller may hold the ramp rate constant. If the fill is not yet approaching the end of fill the ramp rate may be calculated based on P P P t. In this way if the dispenser is at a current pressure at a time in the fill and time remaining is known ramp rate may be determined accordingly for one or more time steps or one or more time intervals. Theoretically in a perfect environment twould stay constant as well as the mass average precooling temperature and thus ramp rate would stay constant in this perfect theoretical environment. However in the real world tmay vary and thus ramp rate and control pressure should be adjusted accordingly.

As seen below pressure ramp rate control may be determined based on the total fueling time or t. tis defined as the time required to fill the CHSS from a minimum initial gas pressure P to a maximum allowable or final gas pressure Pin the shortest time possible without exceeding an average gas temperature threshold of 85 C. The current RR at time tis calculated based on the difference between Pand the Pdivided by tminus t the time elapsed from the beginning of the fill minus t.

In one or more embodiments the controller and decision component may perform one or more of the following calculations including setting the pressure ramp rate and control pressure at 

By utilizing the control equation disclosed in the Set Pressure Ramp Rate section above the dispenser control pressure will reach Pin the appropriate amount of time based on t.

At one or more ending pressure control calculations may be performed by the controller and the decision component . Ending pressure control calculations may be based on a cold CHSS. For example the mass average enthalpy MAE may be calculated based on pressure and temperature. Pressure and temperature at dispenser outlet may be used to calculate enthalpy on an instantaneous basis or instantaneous enthalpy thereby enabling calculation of mass average enthalpy. At time step i 0 the mass average enthalpy would be equal to the instantaneous enthalpy but after i 0 delta m is used to calculate MAE by determining mass dispensed per time step.

Effectively if there is high mass flow the high mass flow has a greater effect on MAE because more mass at that enthalpy is being added to a tank. Accordingly this may be weighted more heavily or given higher weight in the MAE equation as will be discussed below. Conversely enthalpy at a lower mass flow will be given a lower weight because the amount of mass at that enthalpy is smaller on a relative basis.

By weighting the instantaneous enthalpy or taking an average which is weighted by the mass flow such that the average is continually updated a mass average enthalpy is determined. In other words a mass average calculation is performed where the instantaneous enthalpy is averaged based on the mass flow which is continually updated for one or more time steps or time intervals.

At the density may be calculated based on the MAE for one or more time intervals by the controller and the decision component . In calculating the density an internal energy or adiabatic internal energy and the adiabatic temperature may be calculated by multiplying the mass average enthalpy MAE with the mass added to the tank added to initial energy of the tank. Further the internal energy may be used with the MC equation to calculate the final gas temperature and ending pressure. For a low capacity station the controller may adjust or calculate an adjusted ending pressure based on actual fueling time t. The final gas temperature may be used to calculate the density of gas in the tank or the density of the gas in the tank at that final gas temperature stop fill at limit density . Further the density may be calculated based on dispenser pressure. If the dispenser pressure is significantly higher than the actual tank pressure a lower density or lower SOC may occur as a result. Based on the density and the final gas temperature a target ending fueling speed and target ending fueling pressure may be determined or calculated. The flow regulator may adjust the flow of the fuel accordingly.

In one or more embodiments the controller and the decision component may perform one or more of the following calculations at as follows 

Accordingly it can be seen that the hcalculation may be repeated for any number of thermocouples and a most conservative value e.g. minimum among the hcalculations used.

At a target ending fueling speed and target ending fueling pressure may be determined or calculated based on the density and the final gas temperature. The flow regulator or the flow component may adjust the flow of the fuel accordingly.

At the controller may have the decision component check for one or more stop conditions based on IRDA or other communications based protocol. For example the comparator of the decision component may compare a density to a limit density e.g. and if the calculated density e.g. is greater than the density then the controller stops the fill at . In this way the calculated MC density or the cold case density may be utilized as a secondary stop condition such as in the event communications are faulty or incorrect for example.

If used the TopOff RR limits RR to 20 MPa min for a later portion of the fill such as the last 5 to 8 . TopOff enables the MC Default Fill to achieve a higher ending SOC by lowering the pressure drop.

At the controller may have the decision component check for one or more additional stop conditions based on the MC density limit. For example the comparator of the decision component may compare a calculated MC density to an MC limit density e.g. and if the calculated density e.g. is greater than the density then the controller stops the fill at . If no communications are enabled between the tank and the station . In one or more embodiments the value may be set to a maximum of 115 of the MC limit density.

At with reference to a process check is performed by the decision component . The process check begins at . The station pressure ambient temperature CHSS temperature TPC TPC Pand Pat and flow rate may be provided as test inputs against the stop conditions of the process check. The station pressure may be detected by the pressure sensor the ambient temperature may be detected by the ambient temperature sensor TPC TPC PA PTA etc. may be calculated from interim calculations from fueling time calculations and setting ramp rate and control pressure respectively. Flow rate may be measured by the mass flow meter of the flow component .

Returning to if the process check failed at fueling is terminated at . if the process check is passed at the method continues to where the time step and counter are incremented or advanced as follows 1

Accordingly respective calculations may be performed determined or calculated on a periodic basis e.g. once every 1 second for i 1 throughout the MC Default Fill. The method may then proceed with additional iterations of fueling time calculations at setting the ramp rate and control pressure ending pressure control calculations fueling and stop condition checks at and process check at until one or more of the stop conditions is met.

Specific internal energy kJ kg 0.000000251102 2 0.00003270544 0.020635744157 0.000110237178 2 0.014948338423 0.706955972653 2 1.00794 1000

Tables and of and provide tables of coefficients of a b c and d for 2 kg 4 kg 7 kg and 10 kg tank categories and different Pconditions e.g. or a threshold amount such as 5 MPa .

Similarly tables and of and provide tables of coefficients of a b c and d for 2 kg 4 kg 7 kg and 10 kg tank categories and different Pconditions e.g. or a threshold amount such as 5 MPa for cold dispenser cases or scenarios. These coefficients can be used when the dispenser confirms that the station components hose nozzle etc. are already cold from a prior fueling event. More specifically these coefficients can be used when station components e.g. hose nozzle etc. are colder than a predetermined temperature e.g. 0 degrees C. . Otherwise when the station components are not colder than the predetermined temperature the coefficients a b c and d from the tables listed in and are used in the cubic regression equation for t. In this way embodiments of the MC Default Fill which incorporate the cold dispenser coefficients use the cold dispenser coefficients in the tables from and in the cubic regression equation for twhen the dispenser is already cold from a prior filling event and use the coefficients a b c and d from the tables of and in the cubic regression equation for twhen the station components are not colder than a predetermined temperature from a prior fueling event.

Still another embodiment involves a computer readable medium including processor executable instructions configured to implement one or more embodiments of the techniques presented herein. An embodiment of a computer readable medium or a computer readable device devised in these ways is illustrated in wherein an implementation includes a computer readable medium such as a CD R DVD R flash drive a platter of a hard disk drive etc. on which is encoded computer readable data . This computer readable data such as binary data including a plurality of zero s and one s as shown in in turn includes a set of computer instructions configured to operate according to one or more of the principles set forth herein. In one such embodiment the processor executable computer instructions may be configured to perform a method such as the method of or the method of . In another embodiment the processor executable instructions may be configured to implement a system such as the system of . Many such computer readable media may be devised by those of ordinary skill in the art that are configured to operate in accordance with the techniques presented herein.

As used in this application the terms component module system interface and the like are generally intended to refer to a computer related entity either hardware a combination of hardware and software software or software in execution. For example a component may be but is not limited to being a process running on a processor a processor an object an executable a thread of execution a program or a computer. By way of illustration both an application running on a controller and the controller may be a component. One or more components residing within a process or thread of execution and a component may be localized on one computer or distributed between two or more computers.

Further the claimed subject matter is implemented as a method apparatus or article of manufacture using standard programming or engineering techniques to produce software firmware hardware or any combination thereof to control a computer to implement the disclosed subject matter. The term article of manufacture as used herein is intended to encompass a computer program accessible from any computer readable device carrier or media. Of course many modifications may be made to this configuration without departing from the scope or spirit of the claimed subject matter.

Generally embodiments are described in the general context of computer readable instructions being executed by one or more computing devices. Computer readable instructions may be distributed via computer readable media as will be discussed below. Computer readable instructions may be implemented as program modules such as functions objects Application Programming Interfaces APIs data structures and the like that perform one or more tasks or implement one or more abstract data types. Typically the functionality of the computer readable instructions are combined or distributed as desired in various environments.

For one or more of the figures herein one or more boundaries such as boundary of for example may be drawn with different heights widths perimeters aspect ratios shapes etc. relative to one another merely for illustrative purposes and are not necessarily drawn to scale. For example because dashed or dotted lines may be used to represent different boundaries if the dashed and dotted lines were drawn on top of one another they would not be distinguishable in the figures and thus may be drawn with different dimensions or slightly apart from one another in one or more of the figures so that they are distinguishable from one another. As another example where a boundary is associated with an irregular shape the boundary such as a box drawn with a dashed line dotted lined etc. does not necessarily encompass an entire component in one or more instances. Conversely a drawn box does not necessarily encompass merely an associated component in one or more instances but may encompass a portion of one or more other components as well.

In other embodiments device includes additional features or functionality. For example device may include additional storage such as removable storage or non removable storage including but not limited to magnetic storage optical storage etc. Such additional storage is illustrated in by storage . In one or more embodiments computer readable instructions to implement one or more embodiments provided herein are in storage . Storage may store other computer readable instructions to implement an operating system an application program etc. Computer readable instructions may be loaded in memory for execution by processing unit for example.

The term computer readable media as used herein includes computer storage media. Computer storage media includes volatile and nonvolatile removable and non removable media implemented in any method or technology for storage of information such as computer readable instructions or other data. Memory and storage are examples of computer storage media. Computer storage media includes but is not limited to RAM ROM EEPROM flash memory or other memory technology CD ROM Digital Versatile Disks DVDs or other optical storage magnetic cassettes magnetic tape magnetic disk storage or other magnetic storage devices or any other medium which may be used to store the desired information and which may be accessed by device . Any such computer storage media is part of device .

The term computer readable media includes communication media. Communication media typically embodies computer readable instructions or other data in a modulated data signal such as a carrier wave or other transport mechanism and includes any information delivery media. The term modulated data signal includes a signal that has one or more of its characteristics set or changed in such a manner as to encode information in the signal.

Device includes input device s such as keyboard mouse pen voice input device touch input device infrared cameras video input devices or any other input device. Output device s such as one or more displays speakers printers or any other output device may be included with device . Input device s and output device s may be connected to device via a wired connection wireless connection or any combination thereof. In one or more embodiments an input device or an output device from another computing device may be used as input device s or output device s for computing device . Device may include communication connection s to facilitate communications with one or more other devices.

Although the subject matter has been described in language specific to structural features or methodological acts it is to be understood that the subject matter of the appended claims is not necessarily limited to the specific features or acts described above. Rather the specific features and acts described above are disclosed as example embodiments.

Various operations of embodiments are provided herein. The order in which one or more or all of the operations are described should not be construed as to imply that these operations are necessarily order dependent. Alternative ordering will be appreciated based on this description. Further not all operations may necessarily be present in each embodiment provided herein.

As used in this application or is intended to mean an inclusive or rather than an exclusive or . Further an inclusive or may include any combination thereof e.g. A B or any combination thereof . In addition a and an as used in this application are generally construed to mean one or more unless specified otherwise or clear from context to be directed to a singular form. Additionally at least one of A and B and or the like generally means A or B or both A and B. Further to the extent that includes having has with or variants thereof are used in either the detailed description or the claims such terms are intended to be inclusive in a manner similar to the term comprising .

Further unless specified otherwise first second or the like are not intended to imply a temporal aspect a spatial aspect an ordering etc. Rather such terms are merely used as identifiers names etc. for features elements items etc. For example a first channel and a second channel generally correspond to channel A and channel B or two different or two identical channels or the same channel. Additionally comprising comprises including includes or the like generally means comprising or including but not limited to.

It will be appreciated that various of the above disclosed and other features and functions or alternatives or varieties thereof may be desirably combined into many other different systems or applications. Also that various presently unforeseen or unanticipated alternatives modifications variations or improvements therein may be subsequently made by those skilled in the art which are also intended to be encompassed by the following claims.

