---

title: DNS snooping to create IP address-based trust database used to select deep packet inspection and storage of IP packets
abstract: At a network device through which client devices communicate with a network, a database is created that maps Internet Protocol (IP) addresses each to a respective trust metric for a domain name associated with the IP address. An IP packet sent from a client device to the network and that indicates a destination IP address for a network-accessible resource associated with a domain name is intercepted. Using the destination IP address in the intercepted IP packet, the domain name trust metric mapped to the destination IP address is retrieved from the database. IP packets received from the destination IP address are processed based on the retrieved domain name trust metric and a predetermined trust metric criterion.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09628442&OS=09628442&RS=09628442
owner: Cisco Technology, Inc.
number: 09628442
owner_city: San Jose
owner_country: US
publication_date: 20150622
---
The present disclosure relates to selection of deep packet inspection DPI of data packets and storage thereof for security purposes.

A network device that performs security functions such as a firewall is commonly used to protect networks servers and clients. A security function performed by a firewall on a flow of data packets passing through the firewall is Deep Packet Inspection DPI . Often DPI occurs at the application layer i.e. layer 7 of the Open System Interconnection OSI model. Layer 7 DPI is generally resource intensive because all of the data packets associated with a particular data packet flow need to be parsed down to layer 7 in real time. On the other hand experience shows that some reputable websites such as google.com and yahoo.com can be trusted and thus a security motivated layer 7 DPI on data packet flows from such websites may not be necessary. In such cases performing layer 7 DPI wastes resources.

The network device may also gather data packets or portions thereof and store the gathered information to repositories for subsequent access by security related analytics reporting forensics and so on. In a packet data flow to determine which data packets include information that should be stored to the repositories e.g. to discover which packets include information deemed suspicious or that poses a security risk the network security device generally performs DPI on all of the data packets even though many may originate from reputable or trustworthy sources. Performing DPI on all of the data packets including those from reputable sources wastes resources.

Client devices communicate with a network through a network device. An Internet Protocol IP address based trust database that maps IP addresses each to a respective trust metric for a domain name associated with the IP address is created at the network device. An IP packet sent from a client device to the network and that indicates a destination IP address for a network accessible resource associated with a domain name is intercepted. Using the destination IP address in the intercepted IP packet the domain name trust metric mapped to the destination IP address is retrieved from the IP address based trust database. IP packets received from the destination IP address are processed based on the retrieved domain name trust metric and a predetermined trust metric criterion.

Referring first to there is shown a block diagram of an example network environment in which embodiments presented herein may be implemented. Network environment includes a network device such as a network switch a network router or a network security device or appliance e.g. a firewall or a combination thereof connected to a local network such as a local area network LAN and a communication network that may include one or more wide area networks WANs such as the Internet and one or more local area network LANs . Local network includes client devices client clientN also referred to as clients client clientN which may include computer devices and or applications hosted on computer devices that communicate with communication network through network device . Network device also communicates with one or more local storage collectors or repositories to store information provided by the network device. Collectors include large memory stores and may be part of local network or separately connected to network device .

Network environment also includes various resources connected with communication network and thus accessible to network device and clients client clientN through the network device including a Domain Name System DNS server that stores network domain name based databases that map various network domain names to corresponding Internet Protocol IP addresses for accessing resources e.g. sources of content such as content servers associated with the domain names a reputation server that stores databases that map domain name reputations and or domain name categories to corresponding domain names various content servers CS CS that represent network accessible resources e.g. sources of content associated with corresponding domain names e.g. domain name and domain name respectively and that are accessible using the IP addresses associated with the domain names and a management or central server to provide control information to network device that is used in embodiments described herein. For convenience only two content servers are shown in however there will typically be a large number of content servers connected with communication network

Clients client clientN establish connections with content servers e.g. content servers CS CS through network device and then exchange IP packets with the content servers through the network device. In support of network security operations network device may perform resource intensive layer 7 DPI on some of the IP packets flowing from content servers however much of the content hosted by reputable content sources e.g. websites can be trusted because the sources are associated with a trusted domain name thus layer 7 DPI on IP packets from such sources can be avoided. Accordingly embodiments presented herein determine in an efficient manner whether to avoid layer 7 DPI on IP packets originated from content servers associated with domain names having corresponding domain name reputations.

In further support of network security operations network device may store to collectors security relevant portions of IP packets of interest originated from content servers e.g. content servers CS CS . An IP packet of interest is one that originates from a known threat source e.g. threat server or contains information of interest from a network security perspective. Such information of interest is often found at layer 7 of the IP packet. In one approach network device may perform layer 7 DPI on all IP packets regardless of where they originated to determine which of the IP packets contain information of interest and thus should be stored to collectors . This wastes resources because many content sources are know to be trustworthy and layer 7 DPI on IP packets from such sources can be avoided. Accordingly further embodiments herein determine whether the IP packets are of interest and thus should be stored to collectors without performing layer 7 DPI on all of the IP packets.

At a high level network device initially creates an IP address based reputation category or trust database having entries that map IP addresses associated with domain names to respective reputations and categories of the domain names. To create IP address based trust database network device i downloads information from reputation server into a domain name based reputation category or trust database that maps domain names to respective reputations and categories which are trust metrics indicative of domain name trustworthiness from a network security perspective ii intercepts or snoops DNS transactions that clients client clientN use to resolve domain names to IP addresses associated with the domain names and iii combines the reputations and categories corresponding to the snooped domain names with snooped IP addresses associated with the domain names to create entries in IP address based trust database . Thus IP address based trust database indicates different levels of trust for different IP addresses associated with different domain names based on reputations and or categories associated with the IP addresses. Once network device creates IP address based trust database the network device uses that database to determine whether IP packets flowing from a source e.g. a content server associated with a domain name should be subjected to layer 7 DNI snooping and or stored to collectors based on the IP address of the source indicated in IP packets originated at the source and the reputation and or category stored in the entries of database .

With reference to there is a block diagram of network device configured to implement the embodiments described herein according to an example embodiment. Network device includes a network interface unit configured to enable network communications so as to send messages to and receive messages from communication network local network and collectors . One or more processors are provided that execute software stored in memory . Processor s include for example one or more microprocessors and or microcontrollers. To this end the memory stores instructions for software stored in the memory that are executed by processor s to perform the methods described herein.

Memory may comprise read only memory ROM random access memory RAM magnetic disk storage media devices optical storage media devices flash memory devices electrical optical or other physical tangible memory storage devices. Thus in general the memory may comprise one or more tangible non transitory computer readable storage media e.g. a memory device encoded with software comprising computer executable instructions and when the software is executed by the processor s it is operable to perform the operations described herein. Memory may store control logic also referred to as snooping logic to implement methods described herein.

In addition memory stores data used and generated by the processor when executing logic described above. Data may include IP address based trust database domain name based trust database and a DNS database that stores local DNS records downloaded from DNS server .

With reference to together the process by which network device creates IP address based trust database is now described. is a block diagram of an arrangement of network device DNS server and client interconnected by various enumerated flows to indicate message transactions and operations collectively referred to as operations that are correspondingly enumerated in . A given flow in may coincide with multiple references numerals indicating multiple operations associated with that flow. is a flowchart of operations individually enumerated in used to create IP address based trust database . Network device executes control logic to perform various ones of the operations . The description of operations references actions initiated and performed with respect to client and content server CS by way of example only the description applies generally to any client and content server or other source of content.

At network device periodically downloads information from reputation server into domain name based trust database DB . Database includes entries each to map a domain name to a respective domain name reputation and a respective domain name category which are examples of domain name trust metrics. The category associated with a domain name may be based on the types of functions performed or services provided by the network accessible resources such as content servers associated with the domain name.

With reference to there in an illustration of an example of domain name based trust database configured as a table. The rows of database each correspond to a different domain name. Moving left to right database includes columns for domain name reputation score also referred to herein simply as reputation and domain name category. In the example of the reputation of a given domain name may be any number in a range from 0 to 10 where 0 is a lowest reputation indicative of a least trustworthy domain name and 10 is a highest reputation indicative of a most trustworthy domain name. The category of a given domain name includes a numerical value but may also include a text description. For example in the first row of database the domain name www.google.com is assigned a reputation 10 and a category search engine and portal .

Returning to method at before client can request content from content server CS associated with domain name the client initiates a DNS transaction to resolve domain name into an IP address through which the content server can be accessed. To initiate the DNS transaction client sends a DNS query indicating domain name to either a local DNS database e.g. database or if the local database is unable to satisfy the DNS query DNS server .

At a DNS reply including domain name taken from the DNS query and a resolved IP address associated with domain name is sent from DNS server or from local DNS database e.g. via an application programming interface API associated with the local database toward client.

At network device intercepts and reviews or snoops the DNS reply. Network device parses the snooped DNS replay packet to extract the domain name e.g. domain name and the IP address therein e.g. the IP address of content server CS associated with the domain name. Network device uses the extracted or snooped domain name e.g. domain name as an index into domain name based trust database to access the reputation and category for the domain name from the database. As a result network device has the domain name the IP address associated with the domain name the domain name reputation and the domain name category.

At network device combines the IP address associated with the domain name the domain name reputation and the domain name category into an entry of IP address based trust database that maps the IP address to the domain name reputation and category and in this way creates the entry in the database. Although only one DNS transaction is snooped in this example over time network device snoops many DNS transactions across clients client clientN to create many entries in database where each entry maps an IP address associated with a domain name to a respective reputation and a respective category of the domain name.

At network device sends the DNS reply to client so that client can make subsequent content requests to content server.

With reference to there in an illustration of an example of IP address based trust database . The rows or entries of database each correspond to a different IP address associated with i.e. used to access resources of a respective domain name. Moving left to right database includes columns for a snooped IP address associated with a given domain name domain name reputation domain name category a creation modification time for a time and a date when a given entry row was created in the database a querying client unique IP list to list IP addresses of querying clients e.g. IP addresses for clients among client clientN that initiated DNS transactions for a given domain name an domain name associated with the IP address this is optional . IP address based trust database is similar to domain name based trust database except that the IP address based trust database replaces the domain name in the domain name field of the domain name based trust database with the IP address associated with that domain name.

More than one querying client IP address may be associated with the same domain name e.g. www.google.com because many of clients clientsN may wish to connect with a content server of a given domain name. As mentioned above network device creates or updates an entry in IP address based trust database each time the network device snoops a new DNS transaction DNS query response . Once created an entry in IP address based trust database may not be deleted even if the particular client that initiated the DNS query leading to that entry finishes its network activities e.g. accessing the corresponding content server . Therefore it is likely that an entry in IP address based trust database for a particular content server may already exists before a next client initiates another DNS query to the domain name corresponding to that existing entry. The creation modification time field in IP address based trust database may be used to purge older entries therein when the database grows too large. For example entries having times and dates that indicate the entries have been in IP address based trust database for over a predetermined age out time may be deleted.

DNS change malware protection of IP address based trust database may be implemented based on the client unique IP list field in the database. To implement this protection each entry of the database is enabled only when a predetermined minimum e.g. 5 queries from different clients for that entry are indicated in the client unique IP list field for that entry. This prevents a few e.g. 5 clients among client clientN infected with DNS change malware from poisoning IP address based trust database .

Once network device creates IP address based trust database in accordance with method the network device uses the database to assist with processing or handling flows between clients client clientN and various content servers e.g. content servers CS CS . With reference to the process by which network device uses IP address based trust database to determine whether e.g. layer 7 DPI should be performed on IP packets in a call flow and or whether the IP packets or portions thereof should be stored in collectors is now described.

It is assumed that the operations of are performed after those of are performed. Therefore prior to the operations of client has already resolved a domain name of interest e.g. domain name to an IP address of a source of content e.g. content server CS for that domain name. Operations continue from that point in time.

At predetermined configuration information including a predetermined reputation threshold for performing DPI and a predetermined category range is configured on network device through management server using a command line interface or a user interface for example.

At client sends an initial IP packet e.g. a Transmission Control Protocol TCP SYN packet to connect to content server CS.

At network device intercepts the initial IP packet from client and creates a flow data structure also referred to more simply as a flow structure to maintain stateful information for an anticipated connection between client and content server CS. Flow structure is keyed with the 5 tuples source IP address e.g. the address of requesting client destination IP address e.g. the IP address of content source CS source and destination ports of network device and a communication protocol to be used over the connection.

In addition network device may also store in flow structure certain security information that may be forwarded to collectors . Such security information may include the domain name the reputation and the category e.g. of the domain name associated with content server CS . To access this security information network device uses the destination IP address e.g. of content server CS in the intercepted IP packet to retrieve the reputation the category and the domain name if available for that IP address from IP address based trust database . Even further security information may include information that maps between a content source IP e.g. destination IP for content server CS a source user name and a source user group which may be ascertained through user authentication or access to an external database such an Authentication Authorization and Accounting AAA server not shown in the Figures .

At network device accesses predetermined configuration information including the predetermined reputation threshold and the predetermined category range.

At based on the destination IP address of content server CS in the intercepted initial IP packet network device retrieves from IP address based trust database the reputation corresponding to the destination IP address e.g. the reputation of content server CS . Network device determines whether to perform DPI on IP packets subsequently received from the destination IP address based on the retrieved reputation and the predetermined reputation threshold. For example network device compares the retrieved reputation to the predetermined reputation threshold. If the retrieved reputation is greater than the retrieved threshold network device declares that DPI should not be performed and sets a DPI needed flag in flow structure to No. If the retrieved reputation is less than or equal to the retrieved threshold network device declares that DPI should be performed and sets the DPI needed flag in flow structure to yes. 

Also at based on the destination IP address e.g. of content server CS in the intercepted initial IP packet network device retrieves from IP address based trust database the category corresponding to the destination IP address e.g. the category of content server CS . Network device determines whether to store to collectors records that include the above mentioned security information and portions of IP packets e.g. IP packet header information subsequently received from the destination IP address based on the retrieved category and or the retrieved reputation. Network device may determine whether to store the records using the following example rules 

At the initial IP packet is sent to content server CS which replies and a client server connection between client and content server CS is established.

At after the client server connection is established client issues a content request such as Hypertext Transfer Protocol HTTP GET for example which is received at network device .

At network device forwards the content request to content server CS without inspection. Content server CS sends a reply e.g. sends an IP packet that indicates 200 OK for HTTP GET .

At network device receives the reply from content server CS. To process the reply network device accesses information in flow structure based on the 5 tuples indicated as IP header information in the reply. If the DPI needed flag in flow structure is set to No network device does not perform DPI on the reply. If the DPI needed flag is set to Yes network device performs DPI. Subsequent IP packets flowing from content server CS to client are handled similarly.

At if it is determined that network device should send a record for the reply to collectors based on one or more of the rules a d mentioned above the network device sends the record to the collectors. Otherwise network device does not send the record to collectors . Subsequent IP packets flowing from content server CS to client are handled similarly.

Operations described above in connection with associated with creating IP address based trust database to map IP addresses to domain name reputations and then using the database during flow processing to determine whether to perform DPI on IP packets may be performed separately and independently of operations associated with creating IP address based trust database to map IP addresses to domain name categories and or reputations and then using the trust database to determine whether to store records associated with IP packets to collectors .

With reference to there is a flowchart of an example generalized method of creating and using IP address based trust database . In the ensuing description domain name reputation and category are considered examples of domain name trustworthiness metrics more simply referred to as trust metrics . The operations of method include various operations described above in connection with .

At network device creates IP address based trust database that maps IP addresses each to a respective trust metric e.g. reputation and or category for a domain name associated with the IP address.

At network device intercepts an IP packet sent from a client device e.g. from one of clients client clientN to network and that indicates a destination IP address for a network accessible resource e.g. a content server that sources content associated with a domain name.

At network device use the destination IP address in the intercepted IP packet to retrieve from IP address based trust database the trust metric reputation category mapped to the destination IP address. Network also retrieves predetermined configuration information e.g. the predetermined reputation threshold and or the predetermined category range . Predetermined configuration information is also referred to as predetermined trust metric criteria or constraints e.g. the reputation threshold is a first predetermined trust metric criterion and the category range is a second predetermined trust metric criterion.

At network processes IP packets received from the destination IP address based on the retrieved trust metric e.g. domain name reputation and or category and predetermined configuration information e.g. the predetermined reputation threshold and or the predetermined category range . For example network determines whether to perform DPI on the IP packets and or whether to store IP packets and related security information to collectors .

In summary in one embodiment DNS snooping is used to learn the mapping between a domain name and its IP address. The mapping helps a firewall build an IP address based trust data base e.g. IP address based reputation category database which is consulted to determine the reputation for the flow packets from a content server. If the reputation is larger than a configured threshold value server packet inspection can be safely skipped. Since the IP address based trust database is keyed indexed by the server IP address the server packets only need to be parsed up to the layer 3 IP layer to obtain a reputation. This greatly improves firewall performance to make a real time decision if an inspection is required. Conventional techniques require the IP packets to be parsed up to layer 7 to make a decision if an inspection is needed.

The DNS snooping may also be used to build the IP address based trust database so that its content can be used for deciding whether to store received IP packet related records. This approach avoids the need for performing DPI on packets in a flow of data packets to determine whether the packets or information related thereto is to be stored to collectors. The generation and sending of the records to a collector can be further filtered based on security information for the flow of packets.

In summary in one form a method is provided comprising at a network device through which client devices communicate with a network creating an Internet Protocol IP address based trust database that maps IP addresses each to a respective trust metric for a domain name associated with the IP address intercepting an IP packet sent from a client device to the network and that indicates a destination IP address for a network accessible resource associated with a domain name using the destination IP address in the intercepted IP packet retrieving from the IP address based trust database the domain name trust metric mapped to the destination IP address and processing IP packets received from the destination IP address based on the retrieved domain name trust metric and a predetermined trust metric criterion.

In another form an apparatus is provided that includes a network interface unit configured to communicate with client devices over a network and a processor coupled to the network interface unit and configured to create an Internet Protocol IP address based trust database that maps IP addresses each to a respective trust metric for a domain name associated with the IP address intercept an IP packet sent from a client device to the network and that indicates a destination IP address for a network accessible resource associated with a domain name using the destination IP address in the intercepted IP packet retrieve from the IP address based trust database the domain name trust metric mapped to the destination IP address and process IP packets received from the destination IP address based on the retrieved domain name trust metric and a predetermined trust metric criterion.

In yet another form a non transitory processor readable medium is provided. The processor readable medium stores instructions that when executed by a processor cause the processor to create an Internet Protocol IP address based trust database that maps IP addresses each to a respective trust metric for a domain name associated with the IP address intercept an IP packet sent from a client device to the network and that indicates a destination IP address for a network accessible resource associated with a domain name using the destination IP address in the intercepted IP packet retrieve from the IP address based trust database the domain name trust metric mapped to the destination IP address and process IP packets received from the destination IP address based on the retrieved domain name trust metric and a predetermined trust metric criterion.

The above description is intended by way of example only. Various modifications and structural changes may be made therein without departing from the scope of the concepts described herein and within the scope and range of equivalents of the claims.

