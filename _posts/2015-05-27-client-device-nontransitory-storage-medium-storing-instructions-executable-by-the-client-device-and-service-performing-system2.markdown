---

title: Client device, non-transitory storage medium storing instructions executable by the client device, and service performing system
abstract: A client device communicates with a server and a relay device and includes a controller and a storage. The controller is configured to: receive service use information from the relay device; use the received service use information to transmit connection request information to the server; receive the server certificate data which is transmitted from the server as a response to the connection request information; determine whether certificate-authority certificate data for verification of server certificate data is stored in the storage; when the certificate-authority certificate data is stored in the storage, verify the server certificate data using the certificate-authority certificate data; when the certificate-authority certificate data is not stored in the storage, receive the certificate-authority certificate data from the relay device; verify the server certificate data using the received certificate-authority certificate data; and store the received certificate-authority certificate data into the storage.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09628470&OS=09628470&RS=09628470
owner: Brother Kogyo Kabushiki Kaisha
number: 09628470
owner_city: Nagoya-shi, Aichi-ken
owner_country: JP
publication_date: 20150527
---
The present application claims priority from Japanese Patent Application No. 2014 111795 which was filed on May 29 2014 the disclosure of which is herein incorporated by reference in its entirety.

The following disclosure relates to a client device configured to verify server certificate data acquired from a server device a non transitory storage medium storing a plurality of instructions executable by a processor of the client device and a service performing system.

There has been known a technique of communication using Secure Sockets Layer SSL between a server device for providing a service and a client device which uses the service. SSL effectively prevents communication with a device having spoofed the server device and also prevents eavesdropping and tampering of data transferred between the client device and the server device.

Specifically before using the service provided by the server device the client device acquires server certificate data from the server device verifies the server certificate data by using Certification Authority CA certificate data issued by CA and sends the server device a pre master secret value encrypted using a public key contained in the verified server certificate data. This pre master secret value is used to encrypt data to be transferred between the client device and the server device.

The number of CA certificate data stored in a storage device of the client device increases with increase in the number of services used by the client device. This increase may unfortunately result in a storage area of the client device being cluttered with the CA certificate data. This problem is caused in particular in the client device having a storage area of a small size.

Accordingly an aspect of the disclosure relates to a client device capable of using a multiplicity of services without a storage area being cluttered with CA certificate data a non transitory storage medium storing a plurality of instructions executable by a processor of the client device and a service performing system.

In one aspect of the disclosure a client device includes a communication device configured to be electrically connected with i a server configured to provide a service and ii a relay device a storage and a controller. The controller is configured to execute a first reception process for receiving service use information from the relay device via the communication device a first transmission process for using the service use information received in the first reception process to transmit connection request information to the server via the communication device a second reception process for receiving via the communication device the server certificate data which is transmitted from the server as a response to the connection request information a determination process for determining whether certificate authority certificate data is stored in the storage the certificate authority certificate data being for verification of server certificate data which is provided by the server a first verification process for verifying the server certificate data using the certificate authority certificate data when the controller determines in the determination process that the certificate authority certificate data is stored in the storage a third reception process for receiving the certificate authority certificate data from the relay device via the communication device when the controller determines in the determination process that the certificate authority certificate data is not stored in the storage a second verification process for verifying the server certificate data using the certificate authority certificate data received in the third reception process and a storage control process for storing the certificate authority certificate data received in the third reception process into the storage.

In one aspect of the disclosure a client device includes a communication device configured to be electrically connected with a server and a relay device a storage a controller and a plurality of servers each as the server. The plurality of servers are configured to respectively provide a plurality of services different from each other. The plurality of servers include a first server and a second server different from the first server. The plurality of services include a first service provided by the first server and accepted by the relay device in advance and a second service provided by the second server and not accepted by the relay device in advance. The storage includes a first storage area and a second storage area different from the first storage area. The controller is configured to store in the storage certificate authority certificate data for verification of server certificate data which is provided by the server store first certificate authority certificate data in the first storage area and store second certificate authority certificate data in the second storage area. The first certificate authority certificate data is for verification of first server certificate data provided by the first server. The second certificate authority certificate data is for verification of second server certificate data provided by the second server. The controller is configured to execute a first reception process for receiving service use information from the relay device via the communication device a first transmission process for using the service use information received in the first reception process to transmit connection request information to the server via the communication device a second reception process for receiving via the communication device the server certificate data which is transmitted from the server as a response to the connection request information and a verification process for verifying the server certificate data received in the second reception process using the certificate authority certificate data stored in the storage. The controller is configured to use the certificate authority certificate data stored in the first storage area to verify the first server certificate data in the verification process when the controller receives the service use information corresponding to the first service in the first reception process and use the certificate authority certificate data stored in the second storage area to verify the second server certificate data in the verification process when the controller receives the service use information corresponding to the second service in the first reception process.

In one aspect of the disclosure a non transitory storage medium stores a plurality of instructions executable by a processor of a client device. The client device includes a communication device configured to be electrically connected with i a server configured to provide a service and ii a relay device and a storage. The plurality of instructions when executed by the processor cause the client device to execute a first reception process for receiving service use information from the relay device via the communication device a first transmission process for using the service use information received in the first reception process to transmit connection request information to the server via the communication device a second reception process for receiving via the communication device the server certificate data which is transmitted from the server as a response to the connection request information a determination process for determining whether certificate authority certificate data is stored in the storage the certificate authority certificate data being for verification of server certificate data which is provided by the server a first verification process for verifying the server certificate data using the certificate authority certificate data when the client device determines in the determination process that the certificate authority certificate data is stored in the storage a third reception process for receiving the certificate authority certificate data from the relay device via the communication device when the client device determines in the determination process that the certificate authority certificate data is not stored in the storage a second verification process for verifying the server certificate data using the certificate authority certificate data received in the third reception process and a storage control process for storing the certificate authority certificate data received in the third reception process into the storage.

In one aspect of the disclosure a service performing system includes a server configured to provide a service a client device configured to use the service and a relay device. The client device includes a communication device configured to be electrically connected with the server and the relay device a storage and a controller. The controller is configured to execute a first reception process for receiving service use information from the relay device via the communication device a first transmission process for using the service use information received in the first reception process to transmit connection request information to the server via the communication device a second reception process for receiving via the communication device the server certificate data which is transmitted from the server as a response to the connection request information a determination process for determining whether certificate authority certificate data is stored in the storage the certificate authority certificate data being for verification of server certificate data which is provided by the server a first verification process for verifying the server certificate data using the certificate authority certificate data when the controller determines in the determination process that the certificate authority certificate data is stored in the storage a third reception process for receiving the certificate authority certificate data from the relay device via the communication device when the controller determines in the determination process that the certificate authority certificate data is not stored in the storage a second verification process for verifying the server certificate data using the certificate authority certificate data received in the third reception process and a storage control process for storing the certificate authority certificate data received in the third reception process into the storage.

Hereinafter there will be described embodiment by reference to the drawings. It is to be understood that the following embodiment is described only by way of example and the disclosure may be otherwise embodied with various modifications without departing from the scope and spirit of the disclosure.

The LAN is connected to the Internet via a router not shown. This router serves as a firewall. That is when a request is transmitted from the MFP to the relay device or any one of the server devices and when a response is transmitted from the relay device or any one of the server devices to the MFP the router allows these request and response to pass through it. When a request is transmitted from the relay device or the server devices to the MFP on the other hand the router inhibits the request from passing through it.

Connection may be established between the MFP and the relay device using Extensible Messaging and Presence Protocol Over Bidirectional Streams Over Synchronous HTTP XMPP over BOSH . With this establishment the request transmitted from the relay device can be received by the MFP via the router.

XMPP over BOSH is a protocol which always maintains a state in which connection is established. However the protocol for establishing connection between the MFP and the relay device is not limited to XMPP over BOSH. Examples of such protocol include protocols for establishing connection protocols for continuous connection and protocols for maintaining connection.

As illustrated in the MFP includes a printing device a scanning device a display device an operation device a communication device a central processing unit CPU a storage device and a communication bus . The devices of the MFP are connected to each other by the communication bus . The MFP is one example of an image recording apparatus or a client device configured to use a service provided by the server devices . Any device may be used as the client device examples of which include specialized machines such as a printer a label printer a scanner a facsimile machine a sewing machine and a machine tool mobile terminals such as a smartphone a mobile phone and a tablet computer and a personal computer PC .

The printing device records an image on a recording sheet based on image data. The printing device may be a well known printing device such as an ink jet printing device or an electronic photographic printing device. The scanning device performs a scanning operation for creating image data by reading an image recorded on a recording sheet. The MFP may further have other functions including a facsimile function for transmitting and receiving facsimiles and a copying function for reading an image recorded on a recording sheet and recording the image on another recording sheet.

The display device includes a display screen for displaying various kinds of information thereon. The display device may be constituted by any device such as a liquid crystal display LCD and an organic electroluminescent display OELD .

The operation device receives or accepts a user operation for selecting an object displayed on the display screen of the display device . Specifically the operation device includes push buttons for example and sends the CPU a signal corresponding to a pushed one of the push buttons. The operation device may further include a touch sensor shaped like a thin layer superposed on the display screen of the display device . That is the display device may be constituted as a touch panel display. The touch sensor may be constituted by a well known sensor such as a capacitance sensor and a resistive film sensor.

It is noted that the object is an image selectable by the user operating the operation device . For example the MFP may be configured such that each of objects is a character string displayed on the display device one of the displayed objects is highlighted by a push of a direction key of the operation device and the highlighted object is selected by a push of a determination button of the operation device . As another example in the case where the operation device is a touch panel the object may be an icon a button or a link displayed on the display device for example and the user may touch the object to select it.

The communication device is an interface for communicating with external devices over the communication network . That is the MFP outputs various kinds of information to the relay device or the server devices via the communication device and receives various kinds of data or information from the relay device or the server devices via the communication device .

The CPU controls operations of the MFP . The CPU acquires various programs which will be described below from the storage device and executes them based on information output from the operation device and information acquired from the external device via the communication device . In view of the above the CPU and the storage device are one example of a controller.

The storage device includes a program storage area A and a data storage area B. The program storage area A stores an operating system OS and a control program . It is noted that the control program may be a single program and may be a collection of a plurality of programs. The data storage area B stores data and or information required for execution of the control program .

In the present specification the term data and the term information are the same in that each of them is a bit or a bit string which can be handled by a computer. The data can be handled by the computer regardless of details indicated by each bit. The information causes branching in an operation of the computer depending on details indicated by each bit. Moreover the term instruction is a control signal for demanding next operation to a device to which the instruction is transmitted and may include the information or may have a nature of the information.

Also even if the data and the information are changed in format e.g. a text format a binary format and a flag format for each computer the computer treats the data before the change and the data after the change as the same data as long as the computer recognizes that the data before the change and the data after the change are substantially the same as each other. For example information indicating two may be stored in one computer as information in a text format of 0x32 in the ASCII code and stored in another computer as information in a binary format of 10 as a binary number.

However the data and the information are not strictly distinguished and may be treated exceptionally. For example the data may be temporarily treated as the information and the information may be temporarily treated as the data. Also the data treated in one device may be treated as the information in another device and vice versa. Furthermore the information may be taken out from the data and the data from the information.

The storage device is for example constituted by a random access memory RAM a read only memory ROM an electrically erasable programmable read only memory EEPROM a hard disk drive HDD a buffer for the CPU and other similar devices or constituted by a combination of at least two of these devices.

The storage device may be a storage medium readable by a computer. The storage medium readable by a computer is a non transitory medium. Examples of the non transitory medium also include recording media such as a CD ROM and a DVD ROM. The non transitory medium is also a tangible medium. However an electrical signal for transmitting programs downloaded from e.g. a server on the Internet is a signal medium readable by the computer as one kind of a medium readable by the computer but is not a non transitory storage medium readable by the computer.

Programs stored in the program storage area A are executed by the CPU . However in the present specification an operation of each of the programs may be described without referring to the CPU . That is the description meaning that a program A executes a processing A may indicate that the CPU executes the processing A written in the program A . This applies to the relay device which will be described below.

The OS is a basic program which provides an application programming interface API for controlling hardware constituting the MFP such as the printing device the scanning device the display device the operation device and the communication device . That is each of the above mentioned programs controls the hardware by calling up the API provided by the OS . However in the present specification operations of the programs will be described without referring to the OS . That is the description described later meaning that program B controls hardware C may indicate that the program B controls the hardware C through the API of the OS . This applies to the relay device described later.

As illustrated in the data storage area B includes a service use information storage area illustrated in a first storage area illustrated in and a second storage area illustrated in . Each of the service use information storage area and the first storage area is constituted by a non transitory ROM for example. The second storage area is constituted by a transitory RAM for example. However each of the storage areas may have a different structure. Data and information stored in the storage areas will be explained later in detail.

As illustrated in the relay device includes a display device an operation device a communication device a CPU a storage device and a communication bus . Each of the display device the operation device the communication device the CPU the storage device and the communication bus of the relay device has the same structure as that of a corresponding one of the display device the operation device the communication device the CPU the storage device and the communication bus of the MFP and an explanation of which is dispensed with. The CPU and the storage device are another example of the controller. The storage device has a program storage area A and a data storage area B. The program storage area A stores an OS and a control program . The data storage area B has a first storage area illustrated in and a second storage area illustrated in . Data and the information stored in the storage areas will be explained later in detail.

Each of the server devices provides or offers services to be used by the MFP . Each of the server devices is one example of a particular server device authorized by an administrator of the relay device . Each service provided by the server devices will be hereinafter referred to as particular service . Any device may be employed as each of the server devices examples of which include a device for providing services such as Dropbox registered trademark Google Docs registered trademark and Evernote registered trademark . The server device is one example of an external server device different from the particular server device. Each service provided by the server device will be hereinafter referred to as external service .

Any service may be provided by the server devices examples of which include a cloud print processing a Scan to Cloud processing and a device information collecting processing. The cloud print processing is a processing in which the MFP receives image data stored in one of the server devices and controls the printing device to record an image based on the received image data. The Scan to Cloud processing is a processing in which the scanning device performs a scan operation and transmits image data created in the scan operation to one of the server devices . The device information collecting processing is a processing in which the MFP transmits device information thereabout to one of the server devices . Examples of the device information include the number of recording sheets on which images have been recorded by the printing device and a remaining amount of ink in an ink cartridge mounted in the printing device .

The data or information transmitted and received in the service provided by any of the server devices is encrypted according to Secure Sockets Layer SSL . In the cloud print processing for example the server device transmits encrypted image data to the MFP In the Scan to Cloud processing for example the MFP transmits encrypted image data to the server device. In the device information collecting processing for example the MFP transmits encrypted device information to the server device.

The service use information storage area illustrated in stores particular service use information for use of the particular service provided by any one of the server devices . The service use information identified by the service ID 001 is information for use of the service provided by the server device for example. The service use information identified by the service ID 002 is information for use of the service provided by the server device for example. The particular service use information includes a service ID which identifies a particular service an interface definition file and an access uniform resource locator URL . The same kind of information is contained in external service use information which will be described below. The particular service use information and the external service use information are one example of the service use information.

The service ID is an identifier for uniquely identifying a service. Each service ID is assigned to a corresponding one of the services by e.g. the administrator of the relay device . The service ID is one example of the service identifier. The interface definition file defines service icons to be contained and displayed on a service list display screen. When pressed by a user of the MFP each service icon receives a service use instruction for starting use of a corresponding one of the services. The interface definition file is described in e.g. Hyper Text Markup Language HTML or Extensible Markup Language XML . The access URL is one example of location information which indicates a location of one of the server devices which is to be accessed by the MFP in a start of use of the service. It is noted that the service use information storage area may store character strings indicating the respective services instead of the interface definition file. In this configuration the service list display screen may contain the character strings instead of the service icons.

As illustrated in the first storage area of the MFP stores Certification Authority CA certificate data and key information for identifying the CA certificate data in a state in which the CA certificate data and the key information are associated with each other. The CA certificate data is issued by a certification authority CA to verify server certificate data provided by the server devices . The CA certificate data stored in the first storage area is preinstalled in manufacture of the MFP for example.

The CA certificate data includes an issuer of a certificate corresponding to Issuer defined according to ITU TX.509 a common name corresponding to Common Name defined according to ITU TX.509 a name of organization corresponding to Organizational Unit defined according to ITU TX.509 a period of validity of the certificate corresponding to Validity defined according to ITU TX.509 and CA s public key data for example. The key information is constituted by information contained in the CA certificate data. The key information contains the common name or the name of organization for example. The CA certificate data and the server certificate data correspond to a format of a digital certificate which is defined according to ITU TX.509 for example.

As illustrated in the second storage area of the MFP stores the CA certificate data the key information the service ID and last access date and time in association with each other. The last access date and time are one example of date and time information which indicates date and time at which corresponding CA certificate data is most recently used for verification of the server certificate data. The second storage area is assigned with a memory size which allows the second storage area to store N which is a natural number sets of the CA certificate data more specifically N rows of records illustrated in . The second storage area may store the CA certificate data and the service ID received from the relay device and the key information extracted from the CA certificate data. It is noted that the second storage area constituted by the RAM stores no data or information at a point in time when the MFP is turned on.

As illustrated in the first storage area of the relay device stores the CA certificate data and the key information in association with each other. As illustrated in the second storage area of the relay device stores the CA certificate data the key information and the service ID in association with each other. The CA certificate data is stored into the data storage area B and registered in a CA certificate registration processing illustrated in for example. The CA certificate registration processing illustrated in is for example executed by the control program of the relay device . The CA certificate registration processing is one example of a registration processing.

When the control program receives the CA certificate data from the administrator of the relay device via an administrator I F S ADMINISTRATOR I F the control program at S stores the acquired CA certificate data and the key information extracted from the CA certificate data into the first storage area in a state in which the acquired CA certificate data and the key information are associated with each other. The administrator I F is constituted by a combination of the display device and the operation device of the relay device for example. In this specification a when clause indicates that in the case where a condition indicated by the when clause is satisfied a processing described after the when clause is executed. It is noted that the processing may be executed at any timing after the condition is satisfied and may not be executed immediately after the condition is satisfied.

When the control program receives the CA certificate data and the service ID from the server device via the communication device S SERVER DEVICE the control program at S stores the received CA certificate data and service ID and the key information extracted from the CA certificate data into the second storage area in a state in which the received CA certificate data and service ID and the key information are associated with each other. It is noted that the CA certificate data to be stored in the second storage area may be acquired in any manner. For example an administrator of the server device may operate a terminal device different from the server device such that the terminal device displays a reception screen for uploading the CA certificate data to the relay device and may then upload the CA certificate data to the relay device by operating the reception screen. The control program may then store the CA certificate data received via the reception screen into the second storage area .

It is noted that the first storage area of the MFP and the first storage area of the relay device store only CA certificate data issued by a public CA for example. The second storage area of the relay device may store only CA certificate data issued by a private CA for example and may store the CA certificate data issued by the public CA in addition to the CA certificate data issued by the private CA for example. The second storage area of the MFP may store the CA certificate data stored in the first storage area or the second storage area of the relay device . It is noted that the kinds of the CA certificate data stored in each of the storage areas are not limited to those in the above described example. For example the CA certificate data issued by the private CA may be further stored into the first storage areas . Also the first storage areas and the second storage areas may not be distinguished from each other.

The public CA is a CA highly trusted by its publication of the Certification Practice Statement for example. Examples of public CAs include CAs founded by e.g. GMO Global Sign Inc. and Symantec Website Security GK. The private CA is a CA established by the administrator of the server device with own operational standards for example. However the public CA and the private CA are not distinguished uniquely and a manufacturer of the MFP or the administrator of the relay device may distinguish the public CA and the private CA as needed.

There will be next explained operations in the service performing system with reference to . In the service performing system according to the present embodiment when using the service provided by any one of the server devices the MFP uses the CA certificate data stored in the data storage area B or the CA certificate data received from the relay device to verify the server certificate data received from the server device noted that this verification corresponds to validate in SSL .

This flow begins with S at which the control program of the MFP establishes connection with the relay device following a procedure according to XMPP over BOSH. It is noted that this connection may be hereinafter referred to as XMPP connection . The XMPP connection is connection for transmission of a request from the relay device to the MFP noted that this operation corresponds to what is called server push . It is noted that the XMPP connection is disconnected when a predetermined connection maintaining period has passed. When a re connection period shorter than the connection maintaining period has passed the control program establishes the XMPP connection with the relay device . The XMPP connection is kept established by the MFP during execution of processings in for example.

When the control program of the relay device at S has received the external service use information from the server device via the communication device the control program at S transmits the external service use information to the MFP via the communication device . The relay device and the MFP at S transfer the external service use information through the XMPP connection. The processings at S and S are one example of a relay processing.

The external service use information may contain a plurality of access URLs and a plurality of service IDs respectively corresponding to the access URLs. The external service use information may contain the service use instruction instead of the interface definition file. The service use instruction is for causing the MFP to start using the external service that is available according to the external service use information. The external service use information in this case at least needs to contain an access URL and a service ID corresponding to the service used according to the service use instruction.

At S the control program of the MFP receives the external service use information from the relay device via the communication device . The processing in which the control program at S receives the external service use information is one example of a first reception process. When the interface definition file is contained in the external service use information received from the relay device via the communication device in other words when the service use instruction is not contained in the external service use information S No the control program at S displays the service list display screen on the display device . The screen illustrated in is one example of the service list display screen. The service list display screen illustrated in contains the interface definition files stored in the service use information storage area and the service icons defined by the respective interface definition files contained in the external service use information. A name of each service is described on a corresponding one of the service icons and this name of the service is one example of information identifying a corresponding service.

When the operation device has accepted a user operation of tapping on one of the plurality of service icons displayed on the service list display screen S Yes the control program at S controls the communication device to transmit a request of connection to a corresponding one of the server devices . Specifically the control program requests Hypertext Transfer Protocol Secure HTTPS connection to the access URL corresponding to the service icon tapped at S. In the present embodiment a service A is the name of the service provided by the server device a service B is the name of the service provided by the server device and each of a service C and a service D is the name of the service provided by the server device . The operation of tapping on the service icon at S is one example of an input of the service use instruction for instructing the start of use of the corresponding service.

When the service use instruction is contained in the external service use information received from the relay device via the communication device in other words when the interface definition file is not contained in the external service use information S Yes this flow goes to S by skipping S and S. The control program at S controls the communication device to request HTTPS connection to the server device .

When having received the request of connection from the MFP S the corresponding one of the server devices at S sends the MFP the server certificate data on the corresponding one of the server devices as a portion of an SSL negotiation processing in the HTTPS communication. It is noted that this server certificate data may be hereinafter referred to as particular server certificate data . Likewise when having received the request of connection from the MFP S the server device at S sends the MFP the server certificate data on the server device as a portion of the SSL negotiation processing in the HTTPS communication. It is noted that this server certificate data may be hereinafter referred to as external server certificate data .

Each server certificate data is issued by the CA and set for a corresponding one of the server devices to prove that the corresponding server device is a trusted device. The particular server certificate data is issued by the public CA in the present embodiment. The external server certificate data may be issued by the public CA or the private CA.

The server certificate data contains server s public key data key information identifying the CA certificate data for verification of the server certificate data and signature data for example. The signature data is created for example by encrypting the server s public key data using CA s private key data corresponding to the CA s public key data contained in the CA certificate data identified by the key information. It is noted that the key information contained in the server certificate data at least needs to uniquely identify the CA certificate data stored in the first storage areas and the second storage areas and may not completely coincide with the key information stored in the first storage areas and the second storage areas .

When having received the server certificate data from the corresponding one of the server devices via the communication device S the control program of the MFP executes a series of processings for verifying the server certificate data noted that these processings may be hereinafter referred to as verification processing . The processing for receiving the external server certificate data at S is one example of a second reception process.

There will be next explained the verification processing with reference to . It is noted that partly illustrates the verification processing specifically illustrates processings at S S and S or S in the verification processing. When having received the particular server certificate data at S S Yes the control program at S uses the CA certificate data stored in the first storage area to verify the particular server certificate data and this flow ends. The control program at S acquires from the first storage area the CA certificate data associated with the key information contained in the particular server certificate data. The control program then uses the CA s public key data contained in the acquired CA certificate data to decrypt the signature data contained in the particular server certificate data. The control program compares the server s public key data contained in the particular server certificate data with decryption public key data obtained by decrypting the signature data. The processing at S is one example of a third verification process.

When having received the external server certificate data at S S No the control program at S determines whether the CA certificate data for verifying the external server certificate data is stored in the second storage area or not. Specifically the control program at S determines whether the key information contained in the external server certificate data and the CA certificate data associated with the service ID contained in the external service use information are stored in the second storage area or not. The processing at S is one example of a determination process.

When the CA certificate data for verification of the external server certificate data is stored in the second storage area S Yes the control program at S uses the CA certificate data to verify the external server certificate data. The external server certificate data may be verified in the same method as used at S. The processing at S is one example of a first verification process. The control program at S updates to a current date and time the last access date and time stored in the second storage area so as to be associated with the CA certificate data used for verification at S and this flow ends.

When the CA certificate data for verification of the external server certificate data is not stored in the second storage area S No the control program at S controls the communication device to transmit transmission instructing information to the relay device . The transmission instructing information is information for instructing the relay device to transmit the CA certificate data for verification of the external server certificate data. The transmission instructing information contains the key information contained in the external server certificate data and the service ID contained in the external service use information for example.

When having received the transmission instructing information from the MFP via the communication device S the control program of the relay device at S executes a CA certificate search processing. In the CA certificate search processing the control program searches for the CA certificate data identified by the transmission instructing information from the CA certificate data stored in the first storage area and the second storage area . The CA certificate search processing will be explained in detail with reference to a flow in .

This flow begins with S at which the control program determines whether the CA certificate data associated with the key information contained in the transmission instructing information is stored in the first storage area or not. When the CA certificate data is not stored in the first storage area S No the control program at S determines whether the CA certificate data associated with the key information and the service ID contained in the transmission instructing information is stored in the second storage area or not.

When the CA certificate data is stored in the first storage area S Yes the control program at S acquires the CA certificate data from the first storage area . When the CA certificate data is not stored in the first storage area and the CA certificate data is stored in the second storage area S Yes the control program at S acquires the CA certificate data from the second storage area . When the CA certificate data is not stored in the first storage area and the CA certificate data is not stored in the second storage area S No the control program at S creates error information. The error information indicates that the CA certificate data identified by the transmission instructing information is not registered in the relay device .

The control program at S controls the communication device to transmit the CA certificate data acquired from the first storage area at S the CA certificate data acquired from the second storage area at S or the error information created at S to the MFP . The processing at S is one example of a transmission processing.

Returning to when the CA certificate data is received from the relay device via the communication device S Yes the control program of the MFP at S uses the CA certificate data to verify the external server certificate data. The external server certificate data may be verified in the same method as used at S and S. The processings at S S are one example of a second verification process.

The control program at S checks the number of the CA certificate data stored in the second storage area . When the N sets of the CA certificate data are stored in the second storage area S Yes the control program at S overwrites the key information the service ID and the CA certificate data stored in the second storage area so as to be associated with the oldest last access date and time respectively with the key information and the service ID contained in the transmission instructing information and the CA certificate data received at S. Also the control program at S updates the last access date and time to the current date and time and this flow ends.

The overwriting at S is not limited to writing of the CA certificate data newly received into a memory area of the second storage area which had stored the oldest CA certificate data. For example the second storage area may store flags in association with the respective CA certificate data such that each of the flags indicates whether a corresponding one of the CA certificate data is to be searched at S or not. In the present embodiment each flag is ON when the corresponding CA certificate data is to be searched and each flag is OFF when the corresponding CA certificate data is not to be searched. For example the control program at S sets the flag corresponding to the oldest CA certificate data to OFF and sets the flag corresponding to the CA certificate data newly stored in the second storage area to ON.

The number of the CA certificate data stored in the second storage area is less than N S No the control program at S additionally stores i the key information and the service ID contained in the transmission instructing information ii the CA certificate data received at S and iii the current date and time into the second storage area in association with each other and this flow ends. Specifically the control program at S stores the CA certificate data newly received into a memory area of the second storage area which differs from a memory area thereof in which the CA certificate data has already been stored. The processings at S S are one example of a storage control process.

When the control program has received the error information from the relay device via the communication device S No this flow ends. It is noted that the transmission of the transmission instructing information at S and the reception of the CA certificate data or the error information at S may be performed through the XMPP connection and may be performed through connection different from the XMPP connection which is newly established with the relay device .

When the control program at S or S determines that a value obtained by hashing the content of the server certificate coincides with data obtained by decrypting the signature data with the public key contained in the CA certificate data the control program at S determines that the verification is succeeded. When the control program at S determines that the value obtained by hashing the content of the server certificate does not coincide with the data obtained by decrypting the signature data the control program at S determines that the verification is failed. When the verification of the server certificate data is succeeded S Yes the control program at S starts using the service indicated according to the service use instruction determined or acquired at S or S. When the verification of the server certificate data is failed S No this flow skips S.

The control program at S uses the server s public key data to encrypt a pre master secret value used for the service to be used and controls the communication device to transmit the encrypted pre master secret value to one of the server devices which provides the service for example. When having received the encrypted pre master secret value from the MFP the server device decrypts the encrypted pre master secret value using server s private key data corresponding to the server s public key data. The MFP and the server device generate a common key based on the pre master secret value to encrypt data or information to be transmitted and uses the common key to decrypt the received data or information.

In the above described embodiment when the necessary CA certificate data is stored in the data storage area B the control program of the MFP executes the first verification process S Yes S using the CA certificate data and when the necessary CA certificate data is not stored in the data storage area B the control program acquires the CA certificate data from the relay device to execute the second verification process S No S S . This configuration allows the MFP to use a multiplicity of services without the CA certificate data clattering a memory area of the data storage area B.

In the above described embodiment the data storage area B is divided into the first storage area and the second storage area . Thus the CA certificate data for verification of the particular server certificate data and the CA certificate data for verification of the external server certificate data can be separately stored. This configuration can prevent overwriting of the preinstalled CA certificate data with the CA certificate data received from the relay device via the communication device . Also it is possible to prevent the particular server certificate data from being verified using the CA certificate data acquired from the relay device .

In the above described embodiment a memory area for storing the N sets of the CA certificate data can be provided as the second storage area . This configuration eliminates the need for increasing an amount of storage of the storage device to store the CA certificate data. Also the first storage area is constituted by the ROM thereby always keeping the CA certificate data for verification of the particular server certificate data. The second storage area is constituted by the RAM requiring a lower cost to provide a storage area for the CA certificate data acquired from the relay device . Also the control program at S overwrites the CA certificate data associated with the oldest last access date and time resulting in reduction of a frequency of acquisition of the CA certificate data from the relay device .

In the above described embodiment the control program at S sends the relay device the transmission instructing information containing the service ID to acquire from the relay device the CA certificate data associated with the service ID contained in the external service use information. This configuration can reduce a possibility in which the MFP communicates with another device having spoofed the server device .

It is noted that data structure of each of the first storage areas and the second storage areas is not limited to one illustrated in . For example the key information may be omitted. Each of the control programs may at S S S and S analyze the CA certificate data stored in a corresponding one of the storage areas to identify the CA certificate data corresponding to the key information. Also the control program may at S further determine whether the CA certificate data corresponding to the key information is stored in the first storage area or not.

In the MFP or the relay device in the above described embodiment the CPUs execute various programs stored in the program storage areas A A of the respective storage devices to execute processings to be executed by the controller. However the configuration of the controller is not limited to this configuration. For example the controller may be partly or entirely configured by hardware such as an integrated circuit IC .

The present invention is achieved by the MFP or the relay device in the above described embodiment but may be achieved by programs for causing the MFP or the relay device to execute processings. The programs may be stored in a non transitory storage medium. Examples of the non transitory storage medium include in addition to a CD ROM and a DVD ROM a storage device mounted on a server device connectable to the MFP or the relay device over the communication network . The programs stored in the storage device of the server device may be distributed as information or signals representing the programs over the communication network such as the Internet.

